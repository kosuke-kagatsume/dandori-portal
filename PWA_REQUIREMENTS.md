# 📱 Dandori Portal PWA - 確定要件書

**作成日**: 2025-11-13
**ステータス**: 実装準備完了 ✅

---

## 🎯 プロジェクト概要

- **目的**: Webアプリをモバイルアプリ化（iOS/Android対応PWA）
- **開発期間**: 2-3週間（爆速実装）
- **技術スタック**: Next.js 14 + Service Worker + Web Push API
- **アプリ名**: Dandori Portal

---

## ✅ 確定した要件

### 1. 機能範囲

**A. 必須機能（全て実装）**
- ✅ 勤怠打刻（位置情報取得）
- ✅ 休暇申請・承認
- ✅ ダッシュボード閲覧
- ✅ 通知受信
- ✅ プロフィール閲覧

**B. 推奨機能（全て実装）**
- ✅ 給与明細閲覧
- ✅ ワークフロー申請
- ✅ 書類承認
- ✅ 勤怠履歴確認
- ✅ 資産管理（車両・PC）

**C. オプション機能（カメラのみ）**
- ✅ カメラ撮影（書類・領収書・プロフィール画像）
- ❌ 通話機能連携
- ❌ メール送信
- ❌ GPS経路記録

---

### 2. オフライン動作

**レベル2: 閲覧 + 下書き保存**

```typescript
実装内容:
✅ オフライン中でも閲覧可能（キャッシュデータ）
✅ 申請フォームの下書き保存
✅ オンライン復帰時に自動送信
✅ 同期状態の可視化
```

**キャッシュ戦略**:
- ダッシュボード: Network-first（オフライン時はCache）
- 静的リソース: Cache-first
- API: Network-first + Background Sync

---

### 3. プッシュ通知

**カテゴリB: 勤怠関連のみ**

実装する通知:
- ✅ 打刻忘れ通知（「9:30ですが打刻されていません」）
- ✅ 退勤時刻リマインダー（「18:00です。退勤打刻してください」）
- ✅ 月末締め（「勤怠データを確認してください」）

通知設定:
```typescript
{
  badge: '/icons/badge-icon.png',
  icon: '/icons/icon-192x192.png',
  vibrate: [200, 100, 200],
  actions: [
    { action: 'open', title: '確認する' },
    { action: 'dismiss', title: '後で' }
  ]
}
```

---

### 4. インストール促進

**オプションB: 2-3回目訪問時**

実装:
- ローカルストレージで訪問回数カウント
- 3回目訪問時にインストールバナー表示
- ユーザーが却下した場合、1週間後に再表示
- ダッシュボード上部に控えめなバナー

---

### 5. デバイス機能

**A. GPS（位置情報）**
- 実装レベル: オプション（ユーザー許可時のみ）
- 用途: 勤怠打刻時の位置確認
- 精度: 高精度モード（10m以内）
- エラーハンドリング: 位置情報なしでも打刻可能

**B. カメラ**
- 実装: 有効
- 用途:
  - 経費申請時の領収書撮影
  - 報告書の写真添付
  - プロフィール画像更新
- 画像最適化: 自動リサイズ（最大2MB）

**C. 生体認証**
- 実装: なし

**D. バックグラウンド同期**
- 実装: 有効
- 用途: オフライン操作の自動送信
- リトライ: 指数バックオフ（1秒 → 2秒 → 4秒）
- 最大リトライ回数: 3回

---

### 6. デザイン・ブランディング

**アプリ名**: Dandori Portal

**アイコン**: 仮アイコンで実装開始
- 192x192px: ブルー背景に「D」文字
- 512x512px: 同上
- 1024x1024px: 同上（将来の本番用）

**配色**:
- プライマリー: #3B82F6（ブルー）
- アクセント: #8B5CF6（パープル）
- テキスト: #1F2937（ダークグレー）

**スプラッシュ画面**:
```json
{
  "background_color": "#FFFFFF",
  "theme_color": "#3B82F6",
  "display": "standalone"
}
```

---

### 7. パフォーマンス目標

**初期ロード**:
- 目標: 3秒以内 ✅ 達成済み
- Lighthouse スコア: 90+

**オフライン起動**:
- 目標: 1秒以内
- Service Worker アクティブ化: 500ms以内

**通知遅延**:
- 目標: 5秒以内
- Push → 表示: 3秒以内

**ストレージ**:
- Service Worker キャッシュ: 50MB
- IndexedDB: ユーザー承認後無制限

---

## 📊 実装スケジュール（爆速版）

### Phase 1: 基盤構築（2日）
```
Day 1:
- ✅ next-pwa セットアップ
- ✅ Web App Manifest 作成
- ✅ 仮アイコン生成（192, 512, 1024）
- ✅ Service Worker 基本設定

Day 2:
- ✅ オフラインページ実装
- ✅ キャッシュ戦略設定
- ✅ 動作確認（Chrome DevTools）
```

### Phase 2: コア機能（3日）
```
Day 3:
- ✅ カメラAPI統合
- ✅ 画像アップロード機能
- ✅ 画像最適化処理

Day 4:
- ✅ GPS API統合
- ✅ 勤怠打刻への位置情報追加
- ✅ 権限リクエストUI

Day 5:
- ✅ オフライン下書き保存
- ✅ バックグラウンド同期
- ✅ 同期状態表示UI
```

### Phase 3: 通知・インストール（2日）
```
Day 6:
- ✅ プッシュ通知基盤
- ✅ 勤怠リマインダー通知
- ✅ 通知設定画面

Day 7:
- ✅ インストールバナー実装
- ✅ 訪問回数カウント
- ✅ インストールガイド
```

### Phase 4: テスト・最適化（2日）
```
Day 8:
- ✅ iOS Safari テスト
- ✅ Android Chrome テスト
- ✅ オフライン動作確認

Day 9:
- ✅ パフォーマンス最適化
- ✅ バグ修正
- ✅ ドキュメント整備
```

---

## 🛠 技術スタック詳細

### 主要ライブラリ
```json
{
  "next-pwa": "^5.6.0",
  "workbox-window": "^7.0.0",
  "idb": "^8.0.0"
}
```

### Service Worker
- Workbox 7 （キャッシュ戦略）
- Background Sync API
- Push API

### デバイスAPI
- Geolocation API（位置情報）
- MediaDevices API（カメラ）
- Notification API（プッシュ通知）

---

## 📝 実装メモ

### 優先順位
1. **最優先**: Service Worker + Manifest（PWAの基盤）
2. **高優先**: オフライン対応（レベル2）
3. **中優先**: カメラ + GPS
4. **低優先**: プッシュ通知（最後）

### 注意事項
- iOS は Service Worker のサポートが制限的
- プッシュ通知は iOS 16.4+ のみサポート
- バックグラウンド同期は iOS 未サポート（代替案必要）

---

## ✅ 完了条件

- [ ] PWA として iOS/Android でインストール可能
- [ ] オフラインで主要ページ閲覧可能
- [ ] カメラで写真撮影・アップロード可能
- [ ] GPS で位置情報取得可能
- [ ] 下書き保存 → 自動送信の動作確認
- [ ] 勤怠リマインダー通知が動作
- [ ] インストールバナーが適切なタイミングで表示
- [ ] Lighthouse PWA スコア 90+

---

**最終更新**: 2025-11-13
**次のステップ**: Phase 1 実装開始 🚀
