# 入社ワークフロー 実装サマリー

**作成日**: 2025-10-17
**優先度**: フェーズ3（帳票出力→マイナンバー管理の後）
**実装期間**: 9週間（約2ヶ月）

---

## 🎯 要件サマリー

### 解決する課題
1. **4つのGoogleフォームでどれを対応したか分からない** → 統合ダッシュボード
2. **同じ情報を4回入力** → 重複入力削減
3. **不要な設問も表示される** → 条件分岐UI
4. **進捗把握が困難** → 人事管理ダッシュボード
5. **手動催促が手間** → 自動化（手動トリガー付き）
6. **マイナンバー回収に時間がかかる** → システム統合＋優先催促

### ユーザー情報
- **管理規模**: 月間最大2名
- **提出期限**: 3営業日以内
- **所要時間**: 10-15分（実測値）
- **デバイス**: PC・スマホ両対応
- **入力タイミング**: 数日に分けて対応する人もいる

---

## 📋 フォーム構成

### 4つのフォーム
| フォーム名 | 項目数 | 推定時間 | 特記事項 |
|-----------|--------|---------|---------|
| 入社案内 | 39項目 | 5分 | マイナンバー含む |
| 給与振込口座 | 11項目 | 3分 | 銀行コード自動検索 |
| 通勤経路 | 27項目+ | 5-7分 | ファイルアップロード必須 |
| 家族情報 | 13-93項目 | 5-15分 | 家族構成により可変 |

**合計**: 90-160項目、約10-15分

---

## 🚀 実装フェーズ

### Phase 1: 基盤機能（2週間）
```
✅ 統合ダッシュボード
  - 4フォームの進捗可視化
  - プログレスバー
  - 完了チェックリスト

✅ 重複入力の削減
  - 基本情報（名前、メール等）の共通化
  - 初回入力を他フォームに自動引用

✅ 自動保存機能
  - 30秒ごとの自動保存
  - 離脱時の保存確認

✅ マイナンバー項目追加
  - 入社案内フォームに統合
  - 簡易暗号化（Phase 6で本格化）
```

### Phase 2: スマートフォーム（3週間）
```
✅ 条件分岐UI
  【例】
  - 配偶者なし → 配偶者情報12項目を非表示
  - 同居 → 住所入力を非表示
  - 徒歩通勤 → 交通費項目を非表示
  - マイカー → マイカー関連のみ表示

✅ 入力支援
  - 銀行コード自動検索・サジェスト
  - 郵便番号→住所自動入力
  - リアルタイムバリデーション

✅ 必要資料の事前案内
  - 入力開始前の案内画面
  - ステップごとの資料チェックリスト
```

### Phase 3: 人事管理機能（2週間）
```
✅ 進捗管理ダッシュボード
  - 未提出者の一覧表示
  - フィルター・検索機能
  - 4フォームの個別ステータス

✅ 柔軟な催促機能
  - 手動トリガー付き催促メール
  - チャットワークDM送信
  - メッセージのカスタマイズ

✅ 期限管理
  - 提出期限の設定（デフォルト: 3営業日）
  - 期限延長機能
  - 期限アラート
```

### Phase 4: モバイル最適化（1週間）
```
✅ スマホ対応
  - レスポンシブデザイン
  - ファイルアップロード（カメラ直接撮影）
  - タッチ操作の最適化
```

### Phase 5: ヘルプ・ガイド（1週間）
```
✅ 間違いやすい設問の回答例
  - 税法上の扶養
  - 社会保険の扶養
  - 同一生計配偶者の判定

✅ マイナンバー提出促進
  - 重要性の説明
  - 提出方法のガイド
  - 優先催促機能
```

### Phase 6: セキュリティ強化（フェーズ2「マイナンバー管理」と統合）
```
✅ マイナンバー本格暗号化
  - AES-256-GCM暗号化
  - マスキング表示（****-****-1234）

✅ アクセス制御
  - 本人: マスキング表示のみ
  - 人事: 完全表示
  - 社労士: 完全表示（閲覧のみ）
  - その他: アクセス不可

✅ 監査ログ
  - アクセス履歴の記録
  - IPアドレス・日時・目的
```

---

## 🎨 主要画面

### 1. 新入社員ダッシュボード
```
┌───────────────────────────────────┐
│ 入社手続き進捗                      │
│ 期限: あと5日  進捗: 50%            │
│ ━━━●━━━●━━━○━━━○━━━              │
│                                   │
│ ✅ 入社案内        【提出済み】    │
│ ✅ 給与振込口座    【提出済み】    │
│ 📝 通勤経路        【未提出】      │
│    📋 準備: Googleマップ          │
│ 📝 家族情報        【未提出】      │
│    📋 準備: 家族の生年月日・収入   │
└───────────────────────────────────┘
```

### 2. 人事管理ダッシュボード
```
┌──────────────────────────────────────┐
│ 入社手続き管理（10月）                │
│ 対象: 2名  完了: 1名  進行中: 1名    │
├──────────────────────────────────────┤
│ 👤 山田太郎  入社日: 10/20  あと3日  │
│    進捗: 50%  ━━●━●─○─○━━          │
│    [詳細] [催促] [期限延長]          │
│                                      │
│ 👤 佐藤花子  入社日: 10/25  完了✅   │
│    進捗: 100%  ━━●━●─●─●━━         │
│    [詳細] [承認処理]                 │
└──────────────────────────────────────┘
```

### 3. スマートフォーム（条件分岐）
```tsx
// 配偶者の有無で表示切り替え
<RadioGroup name="hasSpouse">
  <Radio value="yes">配偶者あり</Radio>
  <Radio value="no">配偶者なし</Radio>
</RadioGroup>

{hasSpouse === 'yes' && (
  // 配偶者情報12項目を表示
  <SpouseInfoSection>
    <Input name="spouseName" />
    <RadioGroup name="liveTogether">
      <Radio value="yes">同居</Radio>
      <Radio value="no">別居</Radio>
    </RadioGroup>

    {/* 別居の場合のみ住所を表示 */}
    {liveTogether === 'no' && (
      <Input name="spouseAddress" />
    )}
  </SpouseInfoSection>
)}
```

---

## 🔐 セキュリティ仕様

### マイナンバー管理
```typescript
// 暗号化
AES-256-GCM
- 鍵長: 256bit
- IV: 12byte
- Tag: 16byte

// アクセス制御
employee: マスキング表示のみ（****-****-1234）
hr: 完全表示
socialInsuranceConsultant: 完全表示（閲覧のみ）
others: アクセス不可

// 監査ログ
- 誰が（accessedBy）
- いつ（accessedAt）
- 何を（accessType: view/edit/export）
- なぜ（purpose）
- どこから（ipAddress）
```

---

## 📧 通知テンプレート

### 1. 入社手続き開始通知
```
件名: 【重要】入社手続きのご案内

入社日に向けて、以下の手続きをお願いいたします。
提出期限: 〇〇月〇〇日（3営業日以内）

【入力が必要な項目】
✅ 入社案内（基本情報）
✅ 給与振込口座
✅ 通勤経路申請
✅ 家族情報（扶養確認）

【事前に準備するもの】
- 基礎年金番号
- 銀行口座情報
- 通勤経路（Googleマップのスクリーンショット）
- 家族の情報（該当者のみ）
```

### 2. リマインダー（期限1日前）
```
件名: 【リマインド】入社手続きの期限が明日です

現在の進捗: 2 / 4 フォーム完了
未提出: 通勤経路、家族情報

期限に間に合わない場合は、人事部までご連絡ください。
```

### 3. マイナンバー催促
```
件名: 【重要】マイナンバーの提出をお願いいたします

社会保険・雇用保険の加入手続きに必要なため、
マイナンバーの提出をお願いいたします。

【提出方法】
システムから安全に提出いただけます。
※256bit暗号化通信で保護されております。
```

### 4. チャットワーク（催促用）
```
[info][title]入社手続きのリマインド[/title]
入社手続きの提出期限が近づいています。
進捗: 2 / 4 完了

未提出のフォーム:
・通勤経路申請
・家族情報

期限に間に合わない場合はご連絡ください。[/info]
```

---

## 🛠️ 技術スタック

### フロントエンド
- **フレームワーク**: Next.js 14 (App Router)
- **言語**: TypeScript
- **UI**: Radix UI + Tailwind CSS
- **フォーム**: React Hook Form + Zod
- **状態管理**: Zustand (persist)

### データ永続化
- **LocalStorage**: 開発初期
- **Supabase**: 本番環境（将来）

### 外部連携
- **メール**: SendGrid API（将来）
- **チャット**: チャットワーク API
- **住所検索**: 郵便番号API
- **銀行検索**: 全銀協API（または自前DB）

---

## 📂 ディレクトリ構造

```
src/
├── app/[locale]/
│   └── onboarding/
│       ├── page.tsx                    # ダッシュボード
│       ├── [applicationId]/
│       │   ├── page.tsx               # 申請詳細
│       │   ├── basic-info/page.tsx    # 入社案内
│       │   ├── family-info/page.tsx   # 家族情報
│       │   ├── bank-account/page.tsx  # 口座情報
│       │   └── commute-route/page.tsx # 通勤経路
│       └── admin/
│           ├── page.tsx               # 人事管理
│           └── [applicationId]/page.tsx # 承認画面
│
├── features/onboarding/
│   ├── components/
│   │   ├── progress-tracker.tsx       # 進捗表示
│   │   ├── form-auto-save.tsx         # 自動保存
│   │   ├── address-autocomplete.tsx   # 住所自動入力
│   │   ├── bank-code-suggest.tsx      # 銀行コードサジェスト
│   │   ├── conditional-form.tsx       # 条件分岐フォーム
│   │   ├── approval-dialog.tsx        # 承認ダイアログ
│   │   └── return-dialog.tsx          # 差し戻しダイアログ
│   │
│   ├── forms/
│   │   ├── basic-info-form.tsx
│   │   ├── family-info-form.tsx
│   │   ├── bank-account-form.tsx
│   │   └── commute-route-form.tsx
│   │
│   └── hooks/
│       ├── useOnboardingApplication.ts
│       ├── useFormAutoSave.ts
│       └── useApprovalFlow.ts
│
├── lib/
│   ├── store/
│   │   └── onboarding-store.ts        # Zustand Store
│   │
│   ├── validation/
│   │   ├── basic-info-schema.ts       # Zodスキーマ
│   │   ├── family-info-schema.ts
│   │   ├── bank-account-schema.ts
│   │   └── commute-route-schema.ts
│   │
│   ├── services/
│   │   ├── my-number-service.ts       # マイナンバー暗号化
│   │   ├── notification-service.ts    # 通知サービス
│   │   ├── chatwork-service.ts        # チャットワーク連携
│   │   ├── address-service.ts         # 住所検索
│   │   └── bank-service.ts            # 銀行検索
│   │
│   └── utils/
│       ├── form-helpers.ts            # フォームヘルパー
│       └── conditional-logic.ts       # 条件分岐ロジック
│
└── types/
    └── onboarding.ts                  # 型定義
```

---

## 📊 データモデル（要約）

### OnboardingApplication
```typescript
{
  id: string;
  employeeId?: string;
  applicantEmail: string;
  hireDate: string;
  status: 'draft' | 'submitted' | 'returned' | 'approved' | 'registered';
  deadline: string;

  // 4フォームへの参照
  basicInfoFormId: string;
  familyInfoFormId: string;
  bankAccountFormId: string;
  commuteRouteFormId: string;

  // 進捗管理
  submittedAt?: string;
  approvedAt?: string;
  approvedBy?: string;
}
```

### BasicInfoForm（39項目）
- 基本情報: 名前、生年月日、性別、連絡先
- 住所: 現住所、住民票住所
- 緊急連絡先
- 社会保険・雇用保険
- **マイナンバー**（暗号化）

### FamilyInfoForm（可変）
- 配偶者の有無
- 配偶者情報（12項目）
- 家族①〜⑥（各12項目）

### BankAccountForm（11項目）
- 銀行情報
- 口座情報
- 同意チェック

### CommuteRouteForm（27項目+）
- 通勤方法
- 公共交通機関 or マイカー
- ファイルアップロード（マイカーの場合）

---

## ✅ よくある質問

### Q1: GoogleフォームとDandori Portalの主な違いは？
A:
1. **統合ダッシュボード** - 4フォームを一箇所で管理
2. **重複入力なし** - 名前などは1回だけ入力
3. **条件分岐** - 不要な設問を自動で非表示
4. **進捗可視化** - 人事がリアルタイムで確認可能
5. **自動催促** - 手動トリガーで簡単に送信

### Q2: マイナンバーのセキュリティは大丈夫？
A:
- AES-256-GCM暗号化（業界標準）
- マスキング表示（本人も完全な番号は見えない）
- アクセスログ記録（誰がいつ見たか記録）
- 人事・社労士のみ閲覧可能

### Q3: スマホで入力できる？
A:
- 完全対応
- カメラで直接書類撮影→アップロード
- タッチ操作に最適化

### Q4: 入力途中で中断できる？
A:
- 30秒ごとに自動保存
- いつでも続きから再開可能
- 離脱時に保存確認ダイアログ

### Q5: チャットワーク連携の設定は？
A:
- チャットワーク API Tokenを設定画面で登録
- 従業員のチャットワークIDをユーザーマスタに登録
- 自動的にDM送信

---

## 📚 関連ドキュメント

1. **PAYROLL_REQUIREMENTS_v2.md** - 全体要件定義
2. **ONBOARDING_WORKFLOW_DESIGN.md** - システム設計書
3. **ONBOARDING_FORMS_ANALYSIS.md** - フォーム詳細分析
4. **ONBOARDING_UX_REQUIREMENTS.md** - UX要件定義書

---

## 🚀 次のステップ

### 実装開始前
- [ ] Phase 1の詳細タスク分解
- [ ] モックデータ作成
- [ ] Zodスキーマ作成

### Phase 1 開始
- [ ] Zustand Store実装
- [ ] 統合ダッシュボード実装
- [ ] 基本情報フォーム実装
- [ ] 自動保存機能実装

---

**実装準備完了！Phase 1から開始しましょう。**
