# バグ修正チェックリスト

バグ修正時に必ず確認する項目です。

## 1. 問題の理解 (修正前)

- [ ] **症状を正確に把握**: エラーメッセージ、スクリーンショット、再現手順を確認
- [ ] **コードフローをトレース**: 問題が発生するまでの処理の流れを追う
  - フロントエンド → API → ミドルウェア → データベース
- [ ] **根本原因を特定**: 「なぜ」を3回繰り返して真の原因を見つける
- [ ] **関連コードを全て読む**: 修正対象だけでなく、呼び出し元・呼び出し先も確認

## 2. 修正の検証 (修正中)

- [ ] **シナリオベースで検証**: 報告された症状が解決するか頭の中でシミュレーション
- [ ] **副作用を確認**: この修正が他の機能に悪影響を与えないか
- [ ] **類似箇所を確認**: 同じパターンの問題が他にないか検索

## 3. テスト (修正後)

- [ ] **ビルド成功**: `npm run build` がエラーなく完了
- [ ] **元の症状が解決**: 報告された問題が再現しないことを確認
- [ ] **回帰テスト**: 関連機能が壊れていないことを確認

## よくある見落としパターン

### 認証・認可関連

- ミドルウェアの `publicPaths` に新しいパスを追加し忘れ
- Cookie名の不整合（login/logout/middleware間）
- Cookie設定の `path`, `domain`, `sameSite` の確認

### マルチテナント関連

- `x-tenant-id` の設定元（ミドルウェア vs API）の競合
- サブドメイン解決とCookieの優先順位
- テナントIDのハードコード

### API関連

- エラーレスポンスの形式統一
- 認証チェックの漏れ
- トランザクション処理の漏れ

## 参照

- 認証フロー: `src/middleware.ts`, `src/app/api/auth/*/route.ts`
- テナント解決: `src/middleware.ts`, `src/lib/api/api-helpers.ts`
- Cookie設定: 全認証APIで `path: '/'` を確認
