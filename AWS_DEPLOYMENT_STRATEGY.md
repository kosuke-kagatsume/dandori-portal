# DandoriPortal - AWS デプロイ完全戦略

**日付**: 2025-11-15
**プロジェクト進捗**: 95%完成（422項目中400項目完了）
**ビルド状態**: ✅ 成功（エラー0、E2Eテスト30/30成功）

---

## 📊 プロジェクトの技術的特性

### アーキテクチャ
- **フレームワーク**: Next.js 14.2.15（App Router + SSR + API Routes）
- **ランタイム**: Node.js >= 20.0.0
- **言語**: TypeScript 5（strict mode有効）
- **状態管理**: Zustand（18ストア、LocalStorage永続化）
- **データベース**: PostgreSQL（現在Supabase）
- **ORM**: Prisma 6.17.1

### 重要な技術的特徴
```typescript
✅ SSR多用 - ダッシュボード、ユーザー管理など14ページ
✅ API Routes - 40+のエンドポイント（/api/*）
✅ LocalStorage依存 - 18ストアのクライアントサイド永続化
✅ PDF生成 - jsPDF（給与明細、賞与明細、源泉徴収票）
✅ CSV出力 - 10種類のエクスポート機能
✅ 大型ページ - settings（166kB）、payroll（15.9kB）
```

### ビルドサイズ
- **最大ページ**: 403kB（settings）
- **平均ページ**: 150kB前後
- **共通JS**: 88kB
- **ミドルウェア**: 39.6kB

---

## 🎯 デプロイ方法の詳細比較

### オプション1: AWS Amplify（推奨度: ⭐⭐⭐⭐⭐）

#### メリット
✅ **Next.js 14完全サポート**
- SSR、API Routes、Middlewareすべて対応
- 自動的に最適化されたビルド

✅ **自動デプロイ・CI/CD**
- GitHubプッシュで自動デプロイ
- プルリクエストごとのプレビュー環境
- ロールバック機能

✅ **グローバルCDN（CloudFront）**
- 世界中に配信、低レイテンシー
- 静的アセット自動キャッシング
- 画像最適化

✅ **簡単な環境変数管理**
- Webコンソールから設定
- ステージング/本番環境の分離
- シークレット管理

✅ **SSL証明書自動発行**
- Let's Encryptで無料SSL
- カスタムドメイン対応
- 自動更新

#### デメリット
⚠️ **制限事項**
- ビルドメモリ制限（7GB）
- ビルド時間制限（30分）
- 同時実行数制限

⚠️ **コスト構造**
- リクエスト課金（最初の50万リクエスト無料/月）
- ビルド時間課金（最初の1,000分無料/月）
- データ転送量課金（最初の15GB無料/月）

#### コスト試算（月間）
```
【シナリオA: 小規模運用（社内20-50人）】
- ビルド時間: 3分/回 × 20回 = 60分（無料枠内）
- リクエスト: 月間10万 = $0（無料枠内）
- データ転送: 月間5GB = $0（無料枠内）
合計: $0/月 ← 無料枠でカバー！

【シナリオB: 中規模運用（100-200人）】
- ビルド時間: 3分/回 × 50回 = 150分（無料枠内）
- リクエスト: 月間100万 = $1.00（50万超過分）
- データ転送: 月間30GB = $2.25（15GB超過分）
合計: $3.25/月

【シナリオC: 大規模運用（500人以上）】
- ビルド時間: 3分/回 × 100回 = 300分 = $1.00
- リクエスト: 月間300万 = $5.00
- データ転送: 月間100GB = $12.75
合計: $18.75/月
```

#### 推奨理由
1. **初期コスト0円** - 無料枠で小規模運用可能
2. **運用コスト最小** - サーバー管理不要
3. **自動スケーリング** - トラフィック増加に自動対応
4. **高速デプロイ** - GitHubプッシュから5分以内
5. **Next.js最適化** - フレームワーク特化で高性能

---

### オプション2: AWS EC2 + Docker（推奨度: ⭐⭐⭐）

#### メリット
✅ **完全なコントロール**
- カスタム設定が自由
- 任意のミドルウェア導入可能
- パフォーマンスチューニング可能

✅ **予測可能なコスト**
- 固定月額料金
- データ転送量課金なし（ある程度まで）

✅ **他サービスとの統合**
- VPC内で安全に通信
- RDS、ElastiCache等と直接接続
- 独自のセキュリティポリシー適用

#### デメリット
❌ **運用負荷が高い**
- サーバー管理が必要
- OSアップデート、セキュリティパッチ
- モニタリング設定

❌ **初期セットアップ複雑**
- Dockerイメージ作成
- Load Balancer設定
- Auto Scaling設定
- CloudWatch設定

❌ **スケーリングが手動**
- トラフィック予測が必要
- 過剰にスペック確保→コスト増
- 不足時にパフォーマンス低下

#### 必要なAWSリソース
```yaml
必須:
  - EC2インスタンス（t3.small以上）
  - Application Load Balancer（ALB）
  - Elastic Container Registry（ECR）
  - CloudWatch（ログ・メトリクス）

推奨:
  - Auto Scaling Group
  - Elastic IP
  - Route 53（DNS）
  - Certificate Manager（SSL）
```

#### コスト試算（月間）
```
【最小構成: t3.small × 1台】
- EC2 t3.small（2vCPU、2GBメモリ）: $15/月
- ALB: $22/月（固定）+ データ処理$0.008/GB
- EBS 30GB: $3/月
- データ転送（100GB）: $9/月
- CloudWatch: $5/月
合計: $54/月

【推奨構成: t3.medium × 2台（冗長化）】
- EC2 t3.medium（2vCPU、4GBメモリ）× 2: $60/月
- ALB: $22/月 + データ処理
- EBS 30GB × 2: $6/月
- Auto Scaling: $0（設定のみ）
- データ転送: $15/月
- CloudWatch: $10/月
合計: $113/月
```

#### 適用シーン
- 特殊なカスタマイズが必要
- 既存のVPCインフラと統合
- セキュリティ要件が厳しい

---

### オプション3: AWS App Runner（推奨度: ⭐⭐⭐⭐）

#### メリット
✅ **EC2より簡単**
- Dockerイメージだけ準備すればOK
- インフラ管理不要
- 自動スケーリング

✅ **Amplifyより柔軟**
- カスタムDockerイメージ対応
- ポート設定自由
- 環境変数管理簡単

✅ **従量課金**
- 使った分だけ課金
- 0リクエスト時は最小料金
- 予測しやすいコスト

#### デメリット
⚠️ **Next.js最適化なし**
- Amplifyのような自動最適化なし
- CDN連携が手動

⚠️ **新しいサービス**
- 情報が少ない
- ベストプラクティスが確立されていない

#### コスト試算（月間）
```
【基本料金】
- vCPU: $0.064/vCPU時間
- メモリ: $0.007/GB時間

【シナリオ: 1vCPU、2GBメモリ、常時稼働】
- vCPU: $0.064 × 730時間 = $46.72
- メモリ: $0.007 × 2GB × 730時間 = $10.22
合計: $57/月

【実際の運用（アイドル時間を考慮）】
- アクティブ時間: 200時間/月
- vCPU: $0.064 × 200 = $12.80
- メモリ: $0.007 × 2 × 200 = $2.80
合計: $15.60/月
```

---

## 🗄️ データベース戦略の詳細比較

### 現状: Supabase（無料枠）
```yaml
メリット:
  - 完全無料（500MB、月間5万リクエスト）
  - すぐ使える（既に設定済み）
  - バックアップ自動
  - 認証機能付き

デメリット:
  - 外部サービス（レイテンシー）
  - 無料枠制限（データ量、リクエスト数）
  - AWS VPC外（セキュリティ懸念）
```

**推奨**: 初期は継続、データ量増加時に移行検討

---

### オプション1: Supabase継続（推奨度: ⭐⭐⭐⭐）

#### 無料枠の制限
```
✅ データベースサイズ: 500MB
✅ データ転送: 5GB/月
✅ API リクエスト: 月間5万回
✅ 同時接続: 60
```

#### 有料プラン（Pro: $25/月）
```
✅ データベースサイズ: 8GB
✅ データ転送: 50GB/月
✅ API リクエスト: 無制限
✅ 同時接続: 200
✅ 毎日自動バックアップ
✅ Point-in-Time Recovery（7日間）
```

#### 推奨理由
1. **初期コスト0円** - 無料枠で十分
2. **運用コスト低** - データベース管理不要
3. **認証統合** - Supabase Authそのまま使える
4. **既存実装** - 移行作業不要

#### 移行タイミング
```
無料枠超過時（以下のいずれか）:
  - データベースサイズ > 400MB
  - 月間リクエスト > 4万
  - 同時接続 > 50
→ Proプラン（$25/月）へアップグレード

さらに大規模化時:
  - データベースサイズ > 5GB
  - レイテンシーが問題に
→ AWS RDS PostgreSQLへ移行検討
```

---

### オプション2: AWS RDS PostgreSQL（推奨度: ⭐⭐⭐）

#### メリット
✅ **AWS内で完結**
- VPC内で安全に通信
- 低レイテンシー
- Amplify/EC2と直接接続

✅ **エンタープライズ機能**
- 自動バックアップ
- Point-in-Time Recovery
- Multi-AZ（高可用性）
- Read Replica（読み取り分散）

#### コスト試算
```
【最小構成: db.t3.micro（Single-AZ）】
- インスタンス: $13/月
- ストレージ（20GB）: $2.3/月
- バックアップ（20GB）: $2/月
合計: $17.3/月

【推奨構成: db.t3.small（Multi-AZ）】
- インスタンス: $60/月（Multi-AZで2倍）
- ストレージ（50GB）: $11.5/月
- バックアップ（50GB）: $5/月
合計: $76.5/月
```

#### 移行作業
```bash
1. RDSインスタンス作成（15分）
2. Supabaseからデータエクスポート（10分）
3. RDSへインポート（5分）
4. DATABASE_URL変更（1分）
5. デプロイ・動作確認（10分）
合計: 約1時間
```

#### 適用シーン
- データ量が大きい（10GB以上）
- レイテンシーが重要
- エンタープライズ向け

---

### オプション3: Amazon Aurora Serverless（推奨度: ⭐⭐）

#### メリット
✅ **自動スケーリング**
- アクセス量に応じて自動調整
- アイドル時は0.5 ACU
- ピーク時は最大16 ACU

✅ **従量課金**
- 使った分だけ課金
- 自動停止機能（10分未使用時）

#### デメリット
❌ **コールドスタート**
- 停止後の初回アクセスが遅い（20-30秒）
- HR管理システムには不向き

❌ **高コスト**
- 最小: $43/月（0.5 ACU × 730時間）
- RDS db.t3.microより高い

**推奨**: 現時点では不要（オーバースペック）

---

## 💰 総合コスト比較（月間）

### シナリオA: 小規模（社内20-50人）
```
【Amplify + Supabase無料枠】
- Amplify: $0（無料枠内）
- Supabase: $0（無料枠内）
合計: $0/月 ← 最安！
```

### シナリオB: 中規模（100-200人）
```
【Amplify + Supabase Pro】
- Amplify: $3.25
- Supabase Pro: $25
合計: $28.25/月

【Amplify + RDS db.t3.micro】
- Amplify: $3.25
- RDS: $17.3
合計: $20.55/月 ← 安い

【App Runner + Supabase Pro】
- App Runner: $15.60
- Supabase Pro: $25
合計: $40.60/月

【EC2 t3.small + RDS db.t3.micro】
- EC2構成: $54
- RDS: $17.3
合計: $71.3/月 ← 高い
```

### シナリオC: 大規模（500人以上）
```
【Amplify + RDS db.t3.small Multi-AZ】
- Amplify: $18.75
- RDS Multi-AZ: $76.5
合計: $95.25/月

【EC2 t3.medium × 2 + RDS db.t3.small Multi-AZ】
- EC2構成: $113
- RDS Multi-AZ: $76.5
合計: $189.5/月
```

---

## 🎯 推奨デプロイ戦略（フェーズ別）

### Phase 1: 初期リリース（0-3ヶ月）
```yaml
目的: 最小コストで本番運用開始

デプロイ方法: AWS Amplify
データベース: Supabase 無料枠
理由:
  - 初期コスト $0/月
  - 設定が簡単（2-3時間でデプロイ可能）
  - 自動CI/CD

想定ユーザー: 20-50人
月間コスト: $0
```

### Phase 2: 成長期（3-12ヶ月）
```yaml
目的: ユーザー増加に対応、パフォーマンス向上

デプロイ方法: AWS Amplify（継続）
データベース: Supabase Pro → RDS db.t3.micro へ移行検討
理由:
  - ユーザー増加に伴いデータ量増加
  - レイテンシー改善
  - AWS内で完結

想定ユーザー: 100-200人
月間コスト: $20-30
移行作業: 1時間程度
```

### Phase 3: 成熟期（12ヶ月以降）
```yaml
目的: 高可用性、エンタープライズ対応

デプロイ方法: AWS Amplify（継続）または EC2検討
データベース: RDS db.t3.small Multi-AZ
追加機能:
  - Read Replica（読み取り分散）
  - ElastiCache（Redisキャッシュ）
  - CloudWatch詳細モニタリング

想定ユーザー: 500人以上
月間コスト: $100-200
```

---

## 📋 実装チェックリスト

### 🚀 Phase 1実装（Amplify + Supabase）

#### 事前準備（30分）
- [ ] AWSアカウント作成
- [ ] GitHubリポジトリ確認（public/private）
- [ ] Supabase接続情報確認
- [ ] 環境変数リスト作成

#### Amplify設定（1-2時間）
- [ ] Amplifyアプリ作成
- [ ] GitHubリポジトリ連携
- [ ] ビルド設定（amplify.yml作成）
- [ ] 環境変数設定（10個程度）
- [ ] カスタムドメイン設定（オプション）
- [ ] SSL証明書発行

#### デプロイ・検証（1時間）
- [ ] 初回デプロイ実行（10-15分）
- [ ] 全ページ動作確認
- [ ] データベース接続確認
- [ ] CSV/PDF出力確認
- [ ] E2Eテスト実行

#### 合計所要時間: 3-4時間

---

## 🔐 セキュリティ対策

### 必須対策
```yaml
SSL/TLS:
  - ✅ Amplifyで自動発行
  - ✅ Let's Encrypt証明書
  - ✅ 自動更新

環境変数:
  - ✅ Amplifyコンソールで暗号化保存
  - ⚠️ .env.local を Git にコミットしない
  - ✅ DEMO_MODE=false に設定

データベース:
  - ✅ Supabase: Row Level Security（RLS）
  - ✅ RDS: VPC内配置、セキュリティグループ
  - ✅ 接続文字列の暗号化

認証:
  - ✅ Supabase Auth（既存実装）
  - ⚠️ デモモードは本番無効化
```

### 推奨対策
```yaml
WAF（Web Application Firewall）:
  - Amplify: AWS WAF統合可能
  - コスト: $5/月 + ルール数
  - SQLインジェクション、XSS対策

CloudWatch Alarms:
  - エラー率アラート
  - レスポンスタイムアラート
  - データベース接続エラーアラート

バックアップ:
  - Supabase: 自動バックアップ（毎日）
  - RDS: 自動バックアップ（7日保持）
  - Point-in-Time Recovery有効化
```

---

## 📊 モニタリング戦略

### 必須メトリクス
```yaml
アプリケーション:
  - レスポンスタイム（目標: < 1秒）
  - エラー率（目標: < 0.1%）
  - リクエスト数/時
  - ページビュー数

データベース:
  - CPU使用率
  - メモリ使用率
  - 接続数
  - スロークエリ

ビジネス:
  - アクティブユーザー数
  - 勤怠打刻数/日
  - ワークフロー申請数/日
  - CSV/PDFダウンロード数
```

### 監視ツール
```yaml
AWS CloudWatch:
  - ✅ 標準メトリクス（無料）
  - ✅ カスタムメトリクス（$0.30/メトリクス/月）
  - ✅ ログ保存（$0.50/GB）

Vercel Analytics（オプション）:
  - Web Vitals自動計測
  - コスト: $20/月
  - 既にパッケージ導入済み

Sentry（オプション）:
  - エラートラッキング
  - 無料枠: 5,000イベント/月
  - Proプラン: $26/月
```

---

## 🎯 最終推奨構成

### **推奨: AWS Amplify + Supabase（無料枠）**

#### 理由
1. ✅ **初期コスト0円** - 予算に優しい
2. ✅ **最速デプロイ** - 3-4時間で本番稼働
3. ✅ **運用負荷最小** - サーバー管理不要
4. ✅ **自動スケーリング** - トラフィック増加対応
5. ✅ **Next.js最適化** - フレームワーク特化

#### 移行パス
```
【フェーズ1】Amplify + Supabase無料枠
  ↓ データ量増加（400MB超過）
【フェーズ2】Amplify + Supabase Pro（$25/月）
  ↓ レイテンシー問題発生
【フェーズ3】Amplify + RDS db.t3.micro（$20.55/月）
  ↓ さらなる成長
【フェーズ4】Amplify + RDS Multi-AZ（$95.25/月）
```

---

## 📞 次のアクション

### 即座に実施（今日）
1. [ ] AWSアカウント作成（15分）
2. [ ] Supabase接続情報確認（5分）
3. [ ] 環境変数リスト作成（10分）
4. [ ] amplify.yml作成（10分）

### 近日中に実施（今週）
1. [ ] Amplifyアプリ作成・GitHub連携（30分）
2. [ ] 環境変数設定（15分）
3. [ ] 初回デプロイ実行（30分）
4. [ ] 動作確認・E2Eテスト（1時間）

### デプロイ後の確認
1. [ ] 全ページ正常表示
2. [ ] ログイン機能動作
3. [ ] CSV/PDF出力動作
4. [ ] レスポンスタイム計測
5. [ ] Lighthouse スコア確認（目標: 90+）

---

**作成日**: 2025-11-15
**次回レビュー**: デプロイ完了後
**推定総コスト（初年度）**: $0-300/年
