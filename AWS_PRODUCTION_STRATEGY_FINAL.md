# DandoriPortal - 本番運用完全戦略書

**作成日**: 2025-11-15
**対象**: 30テナント・1000ユーザー（増加中）
**デプロイ期限**: 今月中
**運用体制**: 完全独立運用（エンジニアなし、AI活用）
**セキュリティ**: ISO27001/Pマーク準拠

---

## 🎯 全情報まとめ

### プロジェクト概要
- **サービス名**: DandoriPortal（HR管理システム）
- **位置づけ**: ダンドリワークの新サービス（独立展開）
- **顧客基盤**: ダンドリワーク顧客 + 新規顧客
- **マルチテナント**: シングルデプロイ・マルチテナント方式（完璧に実装済み）

### スケジュール
```
今月中: 本番デプロイ完了
来年1月: ベータテスト開始（1ヶ月）
来年2月: 本格運用開始（30テナント・1000ユーザー）
```

### 既存インフラ（ダンドリワーク）
```yaml
AWSアカウント: aws.dandoli (307398217374)
リージョン: ap-northeast-1（東京）
月額コスト: $17,000-19,000（約250-280万円）

主要リソース:
  - RDS: 27個（Aurora PostgreSQL/MySQL）
  - EC2: 21台
  - VPC: 4個（メイン: dandori-production-vpc）
  - Cognito: IDプールのみ（ユーザープールなし）

セキュリティ: ISO27001/Pマーク取得済み
```

### マルチテナント実装状況
```yaml
評価: A++（完璧）

✅ Tenantテーブル実装済み
✅ 全テーブルにtenantIdカラムあり
✅ カスケード削除設定
✅ インデックス最適化
✅ tenant-storeあり（Zustand）
✅ tenant-switcherあり（UI）

⚠️ テナント管理画面なし（要実装）
⚠️ テナント登録フローなし（要実装）
```

---

## 🏗️ 最終推奨インフラ構成

### デプロイ方法: **AWS Amplify（変更なし）**

#### 理由
1. ✅ **最速デプロイ**（3-4時間で完了）
2. ✅ **完全マネージド**（運用負荷ゼロ）
3. ✅ **自動CI/CD**（GitHubプッシュで自動デプロイ）
4. ✅ **グローバルCDN**（CloudFront自動設定）
5. ✅ **SSL自動発行**（Let's Encrypt）

---

### データベース: **既存RDS活用 + 新規Cognito**

#### 🔴 重要決定: 既存RDS活用を推奨

**理由**:
```yaml
✅ 追加コスト最小（ストレージ増加分のみ）
✅ 同一VPC内で高速アクセス
✅ 既存セキュリティ基準を継承（ISO27001/Pマーク）
✅ バックアップ体制がすでに整備済み
✅ 監視体制がすでに整備済み
```

**推奨RDS**: `dandori-production-postgresql-v17-cluster`
- タイプ: Aurora Serverless v2（0.5-2 ACU）
- エンジン: PostgreSQL 17
- 環境: 本番環境
- VPC: dandori-production-vpc

**追加作業**:
```sql
-- 1. 新規データベース作成
CREATE DATABASE dandori_portal;

-- 2. 権限設定
GRANT ALL PRIVILEGES ON DATABASE dandori_portal TO postgres;

-- 3. 接続文字列（環境変数）
DATABASE_URL=postgresql://postgres.[ref]:[password]@dandori-production-postgresql-v17.cluster-xxx.ap-northeast-1.rds.amazonaws.com:5432/dandori_portal
```

**追加コスト試算**:
```
想定データ量:
  - 30テナント × 平均33ユーザー = 1000ユーザー
  - 勤怠データ: 1000ユーザー × 365日 = 365,000レコード/年
  - ワークフロー: 1000ユーザー × 月10件 = 10,000レコード/月
  → 初年度: 約5GB

追加ストレージコスト:
  - Aurora: $0.10/GB/月
  - 5GB × $0.10 = $0.50/月 ← ほぼ無料！
```

---

### 認証: **新規Cognito ユーザープール**

#### なぜSupabaseではなくCognito？

**決定的理由**:
```yaml
❌ Supabaseのデメリット:
  - 外部サービス（AWS外）
  - 既存インフラと統合困難
  - SSO実装が複雑
  - ISO27001監査範囲外

✅ Cognitoのメリット:
  - AWS内で完結
  - 既存ダンドリワークと統合可能（将来的にSSO）
  - ISO27001監査範囲内
  - 無料枠: 月間50,000 MAU（十分）
  - MFA・パスワードポリシー標準対応
```

#### Cognito構成
```yaml
新規作成:
  - ユーザープール名: dandori-portal-users
  - リージョン: ap-northeast-1
  - アプリクライアント: dandori-portal-web

設定:
  - MFA: オプション（SMS/TOTP）
  - パスワードポリシー: 最小8文字、大小英数記号
  - アカウント復旧: メール
  - 属性: email, name, custom:tenantId

将来的なSSO:
  ダンドリワーク ← → Cognito ← → DandoriPortal
  （同じユーザープールで管理）
```

#### コスト
```
無料枠: 月間50,000 MAU（Monthly Active Users）
DandoriPortal: 1,000ユーザー
→ 完全無料！
```

---

## 📊 総合インフラ構成図

```
┌─────────────────────────────────────────────────────────┐
│                  AWS ap-northeast-1                     │
│                                                          │
│  ┌────────────────────────────────────────────────┐   │
│  │         dandori-production-vpc (10.1.0.0/16)   │   │
│  │                                                 │   │
│  │  ┌──────────────────┐  ┌─────────────────┐   │   │
│  │  │  AWS Amplify     │  │  Aurora PG v17  │   │   │
│  │  │  (DandoriPortal) │←→│  + dandori_     │   │   │
│  │  │  - Next.js 14    │  │    portal DB    │   │   │
│  │  │  - SSR/API       │  │  (新規DB追加)   │   │   │
│  │  │  - CloudFront    │  │                  │   │   │
│  │  └──────────────────┘  └─────────────────┘   │   │
│  │           ↓                                     │   │
│  │  ┌──────────────────┐                         │   │
│  │  │  Cognito         │                         │   │
│  │  │  ユーザープール  │                         │   │
│  │  │  (新規作成)      │                         │   │
│  │  └──────────────────┘                         │   │
│  │                                                 │   │
│  │  ┌──────────────────────────────────────┐    │   │
│  │  │  既存ダンドリワークリソース          │    │   │
│  │  │  - EC2: 21台                         │    │   │
│  │  │  - RDS: 26個（他のDB）               │    │   │
│  │  │  - ECS, ELB, S3, CloudFront等        │    │   │
│  │  └──────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────┘   │
│                                                      │
│  ┌─────────────────────────────────────────────┐   │
│  │  共有サービス                                 │   │
│  │  - Route 53（DNS）                           │   │
│  │  - CloudWatch（監視・ログ）                  │   │
│  │  - GuardDuty（セキュリティ監視）             │   │
│  │  - Security Hub（セキュリティ統合）          │   │
│  │  - WAF（Webファイアウォール）               │   │
│  └─────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘

外部:
┌──────────────┐
│  GitHub      │ → Amplify自動デプロイ
└──────────────┘

┌──────────────┐
│  取得済み    │ → Route 53 DNS設定
│  ドメイン    │
└──────────────┘
```

---

## 💰 コスト試算（詳細版）

### 初年度（12ヶ月）

```yaml
AWS Amplify:
  - ビルド時間: 3分/回 × 50回/月 = 150分
    → 無料枠内（1,000分/月）: $0
  - リクエスト: 月間100万（1000ユーザー × 1000リクエスト/月）
    → 超過分: 50万 × $0.000002 = $1.00
  - データ転送: 月間30GB
    → 超過分: 15GB × $0.15 = $2.25
  小計: $3.25/月

RDS（既存に追加）:
  - ストレージ追加: 5GB
    → 5GB × $0.10/GB = $0.50/月
  小計: $0.50/月

Cognito:
  - MAU: 1,000ユーザー
    → 無料枠内（50,000 MAU）: $0
  小計: $0/月

Route 53:
  - ホストゾーン: 1個
    → $0.50/月
  - クエリ: 100万クエリ/月
    → 最初の10億クエリ: $0.40/100万 = $0.40
  小計: $0.90/月

CloudWatch（追加分）:
  - ログ保存: 5GB/月
    → 5GB × $0.50/GB = $2.50
  - カスタムメトリクス: 10個
    → 10 × $0.30 = $3.00
  小計: $5.50/月

合計月額: $10.15/月
合計年額: $121.80/年 ← 超低コスト！
```

### 成長期（3年後: 100テナント・3000ユーザー）

```yaml
AWS Amplify:
  - リクエスト: 300万/月
    → $5.00/月
  - データ転送: 100GB/月
    → $12.75/月
  小計: $17.75/月

RDS（ストレージ増加）:
  - ストレージ: 20GB
    → $2.00/月
  小計: $2.00/月

Cognito:
  - MAU: 3,000ユーザー
    → 無料枠内: $0
  小計: $0/月

その他: $6.40/月

合計月額: $26.15/月
合計年額: $313.80/年 ← まだ安い！
```

---

## 🛡️ セキュリティ・コンプライアンス対策

### ISO27001/Pマーク準拠

#### 既存ダンドリワークの対策を継承
```yaml
✅ 同じVPC内にデプロイ
✅ 同じセキュリティグループ適用
✅ 既存WAF・GuardDuty・Security Hubを利用
✅ CloudWatch監視を統合
```

#### DandoriPortal固有の対策
```yaml
1. データ暗号化:
   ✅ Aurora: 保存時暗号化（AES-256）
   ✅ Amplify: 転送時暗号化（TLS 1.2+）
   ✅ Cognito: パスワードハッシュ化（bcrypt）

2. アクセス制御:
   ✅ Cognito: MFA対応
   ✅ テナントID分離（RLS: Row Level Security）
   ✅ IAMロール最小権限

3. 監査ログ:
   ✅ CloudWatch Logs保存（1年間）
   ✅ アプリケーションログ（監査ログ機能実装済み）
   ✅ データベースクエリログ

4. バックアップ:
   ✅ Aurora自動バックアップ（7日保持）
   ✅ Point-in-Time Recovery有効
   ✅ クロスリージョンバックアップ（オプション）

5. 脆弱性対策:
   ✅ WAF（SQLインジェクション・XSS対策）
   ✅ GuardDuty（脅威検知）
   ✅ Security Hub（統合セキュリティ管理）
```

---

## 🚨 省力化運用戦略（最重要）

### 完全独立運用のための自動化

#### 1. 自動デプロイ（CI/CD）
```yaml
GitHub Actions（推奨）:
  - プッシュ時: 自動ビルド・テスト
  - main/masterブランチ: 自動本番デプロイ
  - developブランチ: ステージング自動デプロイ
  - プルリクエスト: プレビュー環境自動作成

Amplifyコンソール:
  - ブランチごとに自動ビルド設定
  - 失敗時: メール通知
  - ロールバック: ワンクリック
```

#### 2. 自動監視・アラート
```yaml
CloudWatch Alarms（必須設定）:
  - エラー率 > 1%: メール通知
  - レスポンスタイム > 3秒: メール通知
  - RDS CPU > 80%: メール通知
  - RDS接続数 > 90%: メール通知
  - ディスク使用率 > 80%: メール通知

SNS（通知先）:
  - メールアドレス: あなたのメール
  - SMS: あなたの電話番号（オプション）
  - Slack: チャンネル統合（オプション）
```

#### 3. 自動バックアップ
```yaml
Aurora自動バックアップ:
  - 毎日: 自動スナップショット
  - 保持期間: 7日間
  - Point-in-Time Recovery: 有効
  - リストア手順: AWSコンソールでワンクリック

Amplifyビルド履歴:
  - 過去50回のビルド保存
  - ロールバック: バージョン選択 → Deploy
```

#### 4. 自動スケーリング
```yaml
Amplify:
  - トラフィック増加時: 自動スケール（設定不要）
  - CloudFront: 世界中にキャッシュ配信

Aurora Serverless v2:
  - 負荷増加時: 0.5 ACU → 2 ACU自動スケール
  - 負荷減少時: 自動スケールダウン
  - コスト最適化
```

#### 5. ログ自動保存
```yaml
CloudWatch Logs:
  - Amplifyアプリログ: 自動保存
  - Auroraクエリログ: オプション（推奨OFF、コスト高）
  - 保持期間: 1年間（ISO27001要件）
  - ログ検索: CloudWatch Insights

アプリケーション監査ログ:
  - 既存実装: /ja/audit ページ
  - LocalStorage永続化
  - CSV出力機能あり
```

---

## 📋 デプロイ手順（今月中完了）

### フェーズ1: 準備（Week 1: 11/15-11/21）

#### Day 1-2: AWS環境設定
- [ ] 既存RDSに新規データベース作成
  ```sql
  -- RDSに接続
  psql -h dandori-production-postgresql-v17.cluster-xxx.ap-northeast-1.rds.amazonaws.com -U postgres

  -- データベース作成
  CREATE DATABASE dandori_portal;
  GRANT ALL PRIVILEGES ON DATABASE dandori_portal TO postgres;
  ```

- [ ] 接続文字列取得・確認
  ```
  DATABASE_URL=postgresql://postgres.[ref]:[password]@dandori-production-postgresql-v17.cluster-xxx.ap-northeast-1.rds.amazonaws.com:5432/dandori_portal
  ```

- [ ] Prismaマイグレーション実行
  ```bash
  # ローカルで実行
  DATABASE_URL="..." npx prisma migrate deploy
  ```

#### Day 3-4: Cognito設定
- [ ] 新規ユーザープール作成
  ```
  名前: dandori-portal-users
  属性: email, name, custom:tenantId
  MFA: オプション
  パスワードポリシー: 最小8文字
  ```

- [ ] アプリクライアント作成
  ```
  名前: dandori-portal-web
  認証フロー: ALLOW_USER_SRP_AUTH, ALLOW_REFRESH_TOKEN_AUTH
  ```

- [ ] 環境変数準備
  ```
  NEXT_PUBLIC_COGNITO_USER_POOL_ID=ap-northeast-1_xxxxx
  NEXT_PUBLIC_COGNITO_CLIENT_ID=xxxxx
  ```

#### Day 5: テナント管理機能実装（必須）
- [ ] テナント管理画面作成
  - `/ja/admin/tenants` ページ
  - テナントCRUD機能
  - 管理者専用ページ

- [ ] テナント登録フロー実装
  - 新規テナント作成API
  - 初期管理者アカウント作成
  - メール招待機能（オプション）

---

### フェーズ2: デプロイ（Week 2: 11/22-11/28）

#### Day 1: Amplify設定
- [ ] Amplifyアプリ作成
  - GitHubリポジトリ連携
  - ブランチ: main

- [ ] ビルド設定
  - `amplify.yml`確認
  - Node.js 20指定

- [ ] 環境変数設定（21個）
  ```
  NEXT_PUBLIC_SUPABASE_URL=（削除、使わない）
  NEXT_PUBLIC_SUPABASE_ANON_KEY=（削除、使わない）
  DATABASE_URL=（RDS接続文字列）
  NEXT_PUBLIC_COGNITO_USER_POOL_ID=（Cognito）
  NEXT_PUBLIC_COGNITO_CLIENT_ID=（Cognito）
  DEMO_MODE=false
  NEXT_PUBLIC_DEMO_MODE=false
  NODE_ENV=production
  ```

#### Day 2: 初回デプロイ
- [ ] デプロイ実行
- [ ] ビルドログ確認
- [ ] エラー対処

#### Day 3-4: 動作確認
- [ ] 全ページ表示確認（14ページ）
- [ ] データベース接続確認
- [ ] Cognito認証確認
- [ ] CSV/PDF出力確認
- [ ] E2Eテスト実行（30/30成功確認）

#### Day 5: ドメイン設定
- [ ] 取得済みドメイン確認
- [ ] Route 53でDNS設定
- [ ] Amplifyにカスタムドメイン追加
- [ ] SSL証明書自動発行（5-10分）
- [ ] DNS伝播確認（最大24時間）

---

### フェーズ3: 運用準備（Week 3: 11/29-12/5）

#### Day 1-2: 監視設定
- [ ] CloudWatch Alarms作成（5個）
  - エラー率、レスポンスタイム、CPU、接続数、ディスク
- [ ] SNS通知先設定
- [ ] メールアドレス確認

#### Day 3: バックアップ確認
- [ ] Aurora自動バックアップ有効確認
- [ ] リストア手順確認
- [ ] ドキュメント作成

#### Day 4: テナント・ユーザー初期データ投入
- [ ] デモテナント作成（3社）
- [ ] 各テナントの管理者アカウント作成
- [ ] テストユーザー作成（各テナント10人）

#### Day 5: 負荷テスト
- [ ] 100同時接続テスト
- [ ] レスポンスタイム計測
- [ ] エラー率確認
- [ ] スケーリング動作確認

---

### フェーズ4: ベータテスト（2025年1月）

#### Week 1: 内部テスト
- [ ] チーム全員で動作確認
- [ ] バグリスト作成
- [ ] 優先度付け

#### Week 2-3: 外部ベータテスト
- [ ] 3-5社のベータテスター募集
- [ ] フィードバック収集
- [ ] 改善実装

#### Week 4: 本番準備
- [ ] バグ修正完了
- [ ] ドキュメント整備
- [ ] ユーザーマニュアル作成

---

## 🔧 運用マニュアル

### よくあるトラブルと対処法

#### 1. サイトが表示されない
```yaml
確認手順:
  1. Amplifyコンソール → Deployments
     → 最新ビルドのステータス確認
  2. 失敗している場合:
     → Build logs確認
     → エラーメッセージをChatGPT/Claudeに貼り付け
  3. 成功している場合:
     → CloudWatch Logs確認
     → エラーログを検索

対処:
  - ビルドエラー: コード修正 → GitHubプッシュ → 自動再デプロイ
  - ランタイムエラー: 環境変数確認 → 修正 → Redeploy
```

#### 2. データベース接続エラー
```yaml
確認手順:
  1. RDSステータス確認（Available?）
  2. セキュリティグループ確認
     → Amplifyからのインバウンド許可されているか
  3. DATABASE_URL環境変数確認
     → 正しい接続文字列か

対処:
  - RDSダウン: AWS Supportに連絡
  - 接続拒否: セキュリティグループ修正
  - 認証エラー: パスワード確認・再設定
```

#### 3. 認証エラー
```yaml
確認手順:
  1. Cognitoユーザープールステータス確認
  2. アプリクライアント設定確認
  3. NEXT_PUBLIC_COGNITO_*環境変数確認

対処:
  - ユーザープールなし: 作成
  - 環境変数誤り: 修正 → Redeploy
```

#### 4. パフォーマンス低下
```yaml
確認手順:
  1. CloudWatch Metrics確認
     → CPU、メモリ、ネットワーク
  2. Aurora Serverless ACU確認
     → スケーリング状況
  3. CloudFront Cacheヒット率確認

対処:
  - Aurora ACU上限引き上げ: 設定変更
  - CloudFrontキャッシュ改善: Cache-Control設定
  - Amplify: 自動スケールするため対処不要
```

---

## 📊 成功基準（KPI）

### デプロイ完了時
- [ ] ビルド成功（エラー0）
- [ ] 全ページ正常表示（14ページ）
- [ ] E2Eテスト100%成功（30/30）
- [ ] Lighthouse スコア 90+
- [ ] レスポンスタイム < 2秒（95パーセンタイル）

### ベータテスト終了時
- [ ] 稼働率 > 99.9%（ダウンタイム < 45分/月）
- [ ] エラー率 < 0.1%
- [ ] ユーザー満足度 > 4.0/5.0
- [ ] 重大バグ0件

### 本格運用開始時
- [ ] 30テナント登録完了
- [ ] 1000ユーザー登録完了
- [ ] 監視体制確立
- [ ] バックアップ・リストア手順確立

---

## 🎯 最終チェックリスト

### インフラ
- [ ] 既存RDSに新規DB追加
- [ ] Cognito ユーザープール作成
- [ ] Amplify アプリ作成・GitHub連携
- [ ] 環境変数設定（21個）
- [ ] カスタムドメイン設定
- [ ] CloudWatch Alarms設定（5個）

### アプリケーション
- [ ] テナント管理画面実装
- [ ] テナント登録フロー実装
- [ ] Cognito認証統合
- [ ] Supabase依存削除
- [ ] マルチテナントRLS実装（推奨）

### セキュリティ
- [ ] MFA有効化
- [ ] WAF設定確認
- [ ] 監査ログ保存確認
- [ ] バックアップ自動化確認

### ドキュメント
- [ ] 運用マニュアル作成
- [ ] トラブルシューティングガイド
- [ ] ユーザーマニュアル作成
- [ ] API仕様書（将来的）

---

## 💰 最終コストサマリー

```
【初年度】
月額コスト: $10.15
年額コスト: $121.80

内訳:
  - Amplify: $3.25/月
  - RDS追加: $0.50/月
  - Cognito: $0/月（無料枠）
  - Route 53: $0.90/月
  - CloudWatch: $5.50/月

【3年後（3000ユーザー）】
月額コスト: $26.15
年額コスト: $313.80

内訳:
  - Amplify: $17.75/月
  - RDS追加: $2.00/月
  - Cognito: $0/月（無料枠）
  - その他: $6.40/月
```

**結論**: **月額$10で1000ユーザー対応可能** 🎉

---

## 📞 サポート連絡先

### AWS公式サポート
- **ドキュメント**: https://docs.aws.amazon.com/
- **フォーラム**: https://repost.aws/
- **サポートケース**: AWSコンソール → Support

### AI支援
- **Claude (Anthropic)**: 技術的な質問・トラブル対処
- **ChatGPT (OpenAI)**: セカンドオピニオン

### コミュニティ
- **Next.js Discord**: https://discord.gg/nextjs
- **Prisma Discord**: https://discord.gg/prisma

---

**作成日**: 2025-11-15
**最終更新**: 2025-11-15
**デプロイ目標**: 2025年11月30日
**本格運用**: 2025年2月1日
