# バグ修正で学んだ教訓

## 2026-02-26: 認証・テナント問題の見落とし

### 見落とした問題

1. `/auth/change-password` がパブリックパスに含まれていなかった
2. ログインAPIで `x-tenant-id` を設定したことで、サブドメイン解決が上書きされた

### 原因

- PDFの症状だけ見て、コードフロー全体をトレースしなかった
- 「Cookieパス修正で解決した」と思い込んだ
- 自分の修正が副作用を起こす可能性を検証しなかった

### 再発防止チェックリスト

#### 認証問題の場合

1. `src/middleware.ts` の `publicPaths` を確認
2. Cookie名が全ファイルで一致しているか確認
   - `access_token`, `refresh_token`, `user_role`
   - `dw_admin_token`, `dw_user_email`
   - `x-tenant-id`
3. Cookie設定で `path: '/'` が設定されているか確認

#### テナント問題の場合

1. `x-tenant-id` の設定元を確認
   - ミドルウェア: サブドメインから設定（正）
   - ログインAPI: 設定しない（ミドルウェアに任せる）
   - proxy-login API: 設定する（メインドメインでの代理ログイン用）
2. `getTenantIdFromRequest()` がCookieを読む順序を確認

#### 修正前の確認事項

1. 問題のコードパスを最初から最後まで追う
2. 関連するファイルを全てリストアップ
3. 修正が他の機能に影響しないか検証
