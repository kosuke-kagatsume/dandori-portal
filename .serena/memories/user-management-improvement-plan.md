# ユーザー管理・メンバー状況 改修計画

## 概要

- 作成日: 2026-02-25
- 参照資料: /Users/dw100/Desktop/Dandori Portal改修/
- データ連携: MF連携 + 独立管理の両方対応
- DBマイグレーション: デプロイ後に本番適用

---

## Phase 1: バグ修正 ✅ 進行中

### 1.1 編集で「更新成功」と出るが実際は更新されない

- 対象: ユーザー編集ダイアログ
- 調査: API レスポンス、更新ロジック

### 1.2 入社日が1日前にセットされる

- 対象: 詳細表示 > ユーザー詳細 > 編集
- 推定原因: タイムゾーン処理

### 1.3 一部ユーザーで編集時エラー

- エラー: 409 conflict, "At least one role is required"
- 対象: 特定ユーザー（小林梓など）

---

## Phase 2: メンバー状況

### 2.1 表示項目追加

- フリガナ表示（入社手続き or ユーザー管理で登録されたもの）
- 社員番号表示（部署の上に配置）
- 文字色・サイズは部署・役職と同じ

### 2.2 対象

- グリッド表示・リスト表示の両方
- 表示項目: 氏名・社員番号・部署・役職・状況

---

## Phase 3: ユーザー管理基本改修

### 3.1 UI変更

- [ ] ユーザー招待ボタン削除（入社手続きで招待するため）
- [ ] 編集画面にフリガナ・社員番号・雇用形態追加
  - 雇用形態: 設定 > マスタ管理 > 雇用形態から選択
- [ ] 編集ボタンをタブごとに適切な内容に修正

### 3.2 基本情報タブ

- [ ] フリガナ表示
- [ ] 社員番号表示
- [ ] 雇用形態表示
- [ ] 住所・生年月日・性別表示
- [ ] 退職処理後、退職日を2ヶ所に表示

### 3.3 権限別タブ制御

| 権限           | 表示タブ                                 |
| -------------- | ---------------------------------------- |
| 経営者         | 基本情報・SaaS利用・資格情報（勤怠なし） |
| 人事           | 基本情報・SaaS利用・資格情報・勤怠・給与 |
| システム管理者 | 基本情報・SaaS利用のみ                   |

※ 人事権限のみ「編集」可能

---

## Phase 4: 勤怠タブ改修

### 4.1 削除項目

- 出勤日数、総労働時間、残業時間
- 雇用形態（勤怠設定から削除）

### 4.2 追加項目

- 就業ルール（設定 > 勤怠マスタ > 就業ルールから選択）
- 退職日

### 4.3 勤怠設定セクション

表示: 有給起算日・打刻方法・就業ルール・入社日・退職日
編集ダイアログ:

- 有給休暇起算日
- 打刻方法
- 就業ルール（ドロップダウン）

### 4.4 異動履歴セクション

- 予約管理 > 異動で登録したものを反映
- 編集ボタンなし（参照のみ）

### 4.5 休職履歴セクション

編集ダイアログ:

- 休職開始日
- 休職終了日
- 休職種別（設定 > 勤怠マスタ > 休暇・休日から選択）
- 支給項目の計算方法:
  - 全ての支給項目を0円にする
  - 休職・休業期間外と同じ
  - 「休職・休業の計算対象」に選択した項目のみを計算

---

## Phase 5: 給与タブ新規作成

### 5.1 一般情報サブタブ

#### 基本情報セクション

- 氏名、氏名（フリガナ）、性別、生年月日
- 電話番号、郵便番号、都道府県、市区町村
- 丁目・番地、マンション/ビル等
- 市区町村（フリガナ）、マンション/ビル等（フリガナ）
  ※ 氏名・住所変更はワークフローの変更申請で承認後に反映

#### 業務情報セクション

- 給与区分: 月給制・時給制・日給制
- 締め日グループ: 設定 > 勤怠マスタに追加
- 所属事業所: 設定 > 勤怠マスタに追加
- 部門: 設定 > 勤怠マスタに追加（データ集計用）
- 職種: 設定 > 勤怠マスタに追加
- 1日の所定労働時間
- 所定労働日数(月平均)
- 所定労働時間(月平均)

#### 住民税・所得税セクション

住民税:

- 給与支払報告書提出先市区町村
- 納付先市区町村
- 宛名番号
- 受給者番号

所得税:

- 税額表区分（甲・乙・丙）
- 寡婦区分（対象外・寡婦）
- ひとり親区分（対象外・ひとり親）
- 障害者区分（対象外・一般障がい者・特別障がい者）
- 勤労学生区分（対象外・勤労学生）
- 未成年者区分（対象外・未成年者）
- 災害者区分（対象外・災害者）
- 外国人区分（対象外・外国人）
- 居住者区分（居住者・非居住者）

#### 扶養情報セクション

- 配偶者: あり/なし
- 扶養等の人数
- 扶養家族一覧:
  - 氏名/氏名フリガナ、生年月日、続柄(性別)
  - 同居区分（同居・対象外・対象外(国外)）
  - 源泉控除対象区分（対象・対象外）
  - 扶養区分（対象・対象外）
  - 同一生計配偶者区分（対象・対象外）
  - 障害者区分（対象外・一般障がい者・特別障がい者）
  - 健保扶養区分（加入・未加入）
- +扶養追加ボタン

#### マイナンバーセクション

- 暗号化して保存、アクセスログ記録
- 本人・扶養家族分も取得可能

### 5.2 給与情報サブタブ

#### 支給項目セクション（月給制）

- 役員報酬、基本給、役職手当、家族手当、住宅手当、営業手当
- 定額時間外勤務手当、定額深夜勤務手当
- 法定内時間外勤務手当、法定外時間外勤務手当、深夜勤務手当

#### 支給項目セクション（時給制）

- 時給1、時給2、基本給
- 法定内時間外勤務手当、法定外時間外勤務手当、休日勤務手当
- 深夜勤務手当、有給取得分

#### 通勤情報セクション

- 通勤方法、通勤手当、通勤経路

#### 社会保険セクション

健康保険/厚生年金保険:

- 区分（短時間就労者(パートタイマー)・坑内夫）※時給のみ
- 資格取得年月日、被保険者整理番号/基礎年金番号
- 資格喪失年月日、資格喪失原因
- 適用開始月、標準報酬月額（保険料額表から選択）

社会保険料:

- 健康保険料（保険料額表を使用 or 手入力）
- 介護保険料
- 厚生年金保険料

労災保険/雇用保険:

- 労災保険料の事業（その他の各種事業等）
- 従業員区分（常用・臨時・役員で労働者扱いの者）
- 雇用保険料の事業（一般事業所等）
- 資格取得年月日、被保険者番号
- 離職等年月日、資格喪失原因（事業主都合以外の離職・事業主都合の離職・離職以外の理由）

### 5.3 支払情報サブタブ

#### 振込口座セクション

- 口座名、金融機関名、支店名
- 口座名義、口座名義（フリガナ）、口座番号
- 複数口座登録可能（+追加ボタン）

#### 給与支払いタブ

- 給与支払い・固定額1: 支給方法（振込/現金）、固定額、振込口座
- 給与支払い・固定額2: 同上
- 給与支払い・残額: 支給方法、振込口座

#### 賞与支払いタブ

- 賞与支払い・固定額1
- 賞与支払い・固定額2
- 賞与支払い・残額

### 5.4 住民税支払セクション

- 年度別表示（2025年度、2026年度...）
- 6月分〜翌5月分の住民税額入力
- 年税額表示
- 「以降の欄に金額をコピー」ボタン
- 前年・翌年切り替え

---

## Phase 6: 就業ルールマスタ

### 6.1 設定 > 勤怠マスタに「就業ルール」タブ追加

### 6.2 7種類の労働時間制度

1. **基本勤務制**
2. **シフト制**
3. **管理監督者**
4. **裁量労働制**
5. **フレックスタイム制**
6. **1ヶ月単位変形労働制**
7. **1年単位変形労働制**

### 6.3 各制度で設定可能な項目（MF準拠）

共通設定:

- 就業ルール名
- 締め日/起算日設定（日付変更時間、勤怠締め日、週間の起算曜日、年の起算日、残業上限管理の1年の起算日）
- 勤務日の判定方法
- 勤務パターン（複数登録可能、コピー/編集/削除）
- 勤務スケジュール（曜日ごとの勤怠区分と勤務パターン）
- 休憩打刻
- 有給休暇（自動付与、パターン名称、週の契約労働日数、時間単位休暇）
- その他休日/休暇
- 祝日、振替休日、代休
- 36協定
- 未申請の出退勤打刻の取り扱い

フレックスタイム制固有:

- 清算期間（1ヶ月/2ヶ月/3ヶ月）
- 総労働時間の計算方法
- 法定労働時間の総枠の計算方法
- 労働時間の不足分の取扱い
- フレックス勤務に含める範囲
- フレキシブルタイム、コアタイム

1ヶ月単位変形労働制固有:

- 変形労働制の毎月の起算日
- 7日に満たない端数週の取り扱い
- 変形労働制勤務に含める範囲

### 6.4 勤務パターン詳細

- 勤務パターン名
- 打刻みなし時間の種類（なし/直行/直帰/直行・直帰）
- 契約時間（開始・終了）
- 休憩時間自動適用設定
- 半休の取り扱い

---

## 追加が必要なDBテーブル/フィールド

### users テーブル追加フィールド

- furigana (フリガナ)
- employeeNumber (社員番号)
- employmentTypeId (雇用形態ID)
- birthDate (生年月日)
- gender (性別)
- postalCode (郵便番号)
- prefecture (都道府県)
- city (市区町村)
- address1 (丁目・番地)
- address2 (マンション/ビル等)
- cityFurigana (市区町村フリガナ)
- address2Furigana (マンション/ビル等フリガナ)
- resignationDate (退職日)

### 新規テーブル

- work_rules (就業ルール)
- work_patterns (勤務パターン)
- leave_history (休職履歴)
- payroll_general_info (給与一般情報)
- payroll_tax_info (住民税・所得税)
- dependent_info (扶養情報)
- payroll_salary_info (支給項目)
- social_insurance_info (社会保険)
- resident_tax_payments (住民税支払)
- bank_accounts (振込口座)
- payment_settings (支払設定)

---

## 進捗管理

- [x] Phase 1 開始 (2026-02-25)
- [ ] Phase 1 完了
- [ ] Phase 2 完了
- [ ] Phase 3 完了
- [ ] Phase 4 完了
- [ ] Phase 5 完了
- [ ] Phase 6 完了
