# Dandori Portal - é–‹ç™ºãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

## ğŸ¯ æœ€çµ‚æ›´æ–°: 2025-09-27

### âœ… Hydrationã‚¨ãƒ©ãƒ¼ã®å®Œå…¨è§£æ±º

#### å•é¡Œã®çµŒç·¯
Next.js 14.0.4ã§Hydrationã‚¨ãƒ©ãƒ¼ãŒé »ç™ºã—ã€å‰å›è§£æ±ºã§ããªã‹ã£ãŸå•é¡Œã‚’ä»Šå›æ ¹æœ¬çš„ã«è§£æ±ºã€‚

#### æ ¹æœ¬åŸå› ã¨è§£æ±ºç­–

##### 1. DOMæ§‹é€ ã®ä¸ä¸€è‡´
**å•é¡Œ**: æ¡ä»¶åˆ†å²ã§DOMæ§‹é€ ãŒå¤‰ã‚ã£ã¦ã„ãŸ
```jsx
// âŒ Before - SSR/CSRã§ç•°ãªã‚‹DOM
{collapsed ? <ChevronRight/> : <ChevronLeft/>}

// âœ… After - åŒä¸€DOMã€CSSã§åˆ¶å¾¡
<ChevronLeft className={collapsed ? 'rotate-180' : ''} />
```

##### 2. MountGateã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®Ÿè£…
SSR/CSRã®å·®ã‚’å¸åã™ã‚‹æ±ç”¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆï¼š
```jsx
// src/components/common/MountGate.tsx
export function MountGate({ children, fallback = null }) {
  const [mounted, setMounted] = useState(false);
  useEffect(() => setMounted(true), []);
  if (!mounted) return <>{fallback}</>;
  return <>{children}</>;
}
```

##### 3. Zustand persistã®SSRå¯¾å¿œ
```javascript
// SSRæ™‚ã¯persistã‚’ç„¡åŠ¹åŒ–
if (typeof window === 'undefined') {
  return create<State>()(storeCreator);
}
return create<State>()(persist(storeCreator, {...}));
```

### ğŸ›¡ï¸ å†ç™ºé˜²æ­¢ç­–

#### npm scripts
```json
{
  "scripts": {
    // çŸ¢å°æ–‡å­—ãƒã‚§ãƒƒã‚¯
    "lint:arrows": "grep -r -n \"â€º\\|&gt;\\|['\\\"]>['\\\"]\" src && echo 'NG' && exit 1 || echo 'OK'",
    // ã‚¯ãƒªãƒ¼ãƒ³èµ·å‹•
    "dev:clean": "pkill -f \"next|node\" || true && rm -rf .next .turbo node_modules/.cache && npm ci && npm dedupe && HOST=127.0.0.1 PORT=3100 npm run dev"
  }
}
```

#### ESLintãƒ«ãƒ¼ãƒ«
```json
// .eslintrc.json
{
  "rules": {
    "no-restricted-syntax": [
      "error",
      { "selector": "Literal[value='â€º']", "message": "JSXã«ç”Ÿã®â€ºã¯ç¦æ­¢" },
      { "selector": "Literal[value='>']", "message": "JSXã«ç”Ÿã®>ã¯ç¦æ­¢" }
    ]
  }
}
```

### ğŸ“ é‡è¦ãªè¨­è¨ˆåŸå‰‡

1. **DOMæ§‹é€ ã‚’æ¡ä»¶åˆ†å²ã§å¤‰ãˆãªã„**
   - ã‚¢ã‚¤ã‚³ãƒ³ã®å‘ãã¯CSSã®transformã§åˆ¶å¾¡
   - è¡¨ç¤º/éè¡¨ç¤ºã¯CSSã‚¯ãƒ©ã‚¹ã§åˆ¶å¾¡

2. **SSR/CSRã§ç•°ãªã‚‹å‡¦ç†ã¯å¿…ãšMountGateã§ãƒ©ãƒƒãƒ—**
   - localStorage/sessionStorageã¸ã®ã‚¢ã‚¯ã‚»ã‚¹
   - window/documentã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½¿ç”¨
   - ãƒ–ãƒ©ã‚¦ã‚¶APIä¾å­˜ã®å‡¦ç†

3. **Zustand storeã¯SSRå¯¾å¿œå¿…é ˆ**
   - ã‚µãƒ¼ãƒãƒ¼å´ã§ã¯persistç„¡åŠ¹
   - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã®ã¿localStorageä½¿ç”¨

### ğŸš€ é–‹ç™ºç’°å¢ƒ

#### é€šå¸¸èµ·å‹•
```bash
cd /Users/dw100/dandori-portal
PORT=3001 npm run dev
```

#### ãƒˆãƒ©ãƒ–ãƒ«æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³èµ·å‹•
```bash
npm run dev:clean  # ãƒãƒ¼ãƒˆ3100ã§èµ·å‹•
```

#### Hydrationã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
```bash
npm run lint:arrows  # çŸ¢å°æ–‡å­—ã®æ¤œå‡º
```

### ğŸ—ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```
src/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ [locale]/
â”‚       â”œâ”€â”€ layout.tsx        # ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â”‚       â”œâ”€â”€ dashboard/        # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
â”‚       â””â”€â”€ payroll/         # çµ¦ä¸ç®¡ç†ï¼ˆæ–°è¦è¿½åŠ ï¼‰
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â””â”€â”€ MountGate.tsx    # SSR/CSRå·®å¸åã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â””â”€â”€ layout/
â”‚       â””â”€â”€ app-shell.tsx    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚§ãƒ«
â”œâ”€â”€ features/
â”‚   â””â”€â”€ navigation/
â”‚       â””â”€â”€ sidebar.tsx      # ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰
â””â”€â”€ lib/
    â””â”€â”€ store/
        â”œâ”€â”€ ui-store.ts      # UIã‚¹ãƒˆã‚¢ï¼ˆSSRå¯¾å¿œæ¸ˆã¿ï¼‰
        â””â”€â”€ user-store.ts    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆã‚¢ï¼ˆSSRå¯¾å¿œæ¸ˆã¿ï¼‰
```

### ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

#### Hydrationã‚¨ãƒ©ãƒ¼ãŒå†ç™ºã—ãŸå ´åˆ
1. `npm run lint:arrows`ã§çŸ¢å°æ–‡å­—ãƒã‚§ãƒƒã‚¯
2. ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ç®‡æ‰€ã‚’ç‰¹å®š
3. æ¡ä»¶åˆ†å²ã§DOMãŒå¤‰ã‚ã£ã¦ã„ãªã„ã‹ç¢ºèª
4. MountGateã§ãƒ©ãƒƒãƒ—ã™ã¹ãç®‡æ‰€ãŒãªã„ã‹ç¢ºèª

#### é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒä¸å®‰å®šãªå ´åˆ
```bash
# å…¨ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†ï¼†ã‚¯ãƒªãƒ¼ãƒ³èµ·å‹•
npm run dev:clean
```

### ğŸ“Š å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½

- âœ… ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆçµ±è¨ˆè¡¨ç¤ºã€ã‚°ãƒ©ãƒ•è¡¨ç¤ºï¼‰
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼ˆCRUDã€æ¨©é™ç®¡ç†ï¼‰
- âœ… ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ï¼‰
- âœ… å‹¤æ€ ç®¡ç†ï¼ˆæ‰“åˆ»ã€å±¥æ­´ä¿å­˜ã€æœˆæ¬¡çµ±è¨ˆï¼‰
- âœ… ä¼‘æš‡ç®¡ç†ï¼ˆç”³è«‹ã€æ‰¿èªã€æ®‹æ•°ç®¡ç†ï¼‰
- âœ… æ‰¿èªç®¡ç†ï¼ˆå¤šæ®µéšæ‰¿èªã€ä»£ç†æ‰¿èªï¼‰
- âœ… ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆç”³è«‹ãƒ•ãƒ­ãƒ¼ã€ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
- âœ… **çµ¦ä¸ç®¡ç†**ï¼ˆç¨è¨ˆç®—ã€ç¤¾ä¼šä¿é™ºã€å¹´æœ«èª¿æ•´ã€PDFå‡ºåŠ›æº–å‚™ï¼‰
- âœ… **è³ä¸ç®¡ç†**ï¼ˆå¾“æ¥­å“¡åˆ¥æ˜ç´°ã€æŸ»å®šè©•ä¾¡ã€è¤‡æ•°ç¨®åˆ¥å¯¾å¿œï¼‰
- âœ… **çµ„ç¹”ç®¡ç†**ï¼ˆçµ„ç¹”å›³ã€éƒ¨é–€ç®¡ç†ã€æ¨©é™è¨­å®šï¼‰
- âœ… **è¨­å®šç”»é¢**ï¼ˆãƒ†ãƒ¼ãƒåˆ‡æ›¿ã€è¨€èªè¨­å®šã€é€šçŸ¥è¨­å®šï¼‰

### ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–

å…¨æ©Ÿèƒ½ã§LocalStorageçµŒç”±ã®ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–å®Ÿè£…æ¸ˆã¿ï¼š
- `attendance-history-store` - å‹¤æ€ å±¥æ­´ãƒ‡ãƒ¼ã‚¿
- `leave-management-store` - ä¼‘æš‡ç”³è«‹ãƒ»æ®‹æ•°ãƒ‡ãƒ¼ã‚¿
- `workflow-store` - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”³è«‹ãƒ‡ãƒ¼ã‚¿
- `organization-store` - çµ„ç¹”æ§‹é€ ãƒ‡ãƒ¼ã‚¿
- `user-store` - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
- `ui-store` - UIè¨­å®šï¼ˆãƒ†ãƒ¼ãƒã€è¨€èªç­‰ï¼‰

### ğŸ‰ è§£æ±ºæ¸ˆã¿å•é¡Œ

- âœ… Hydrationã‚¨ãƒ©ãƒ¼ï¼ˆ2025-09-27å®Œå…¨è§£æ±ºï¼‰
- âœ… UTF-8ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼
- âœ… è¤‡æ•°ãƒ—ãƒ­ã‚»ã‚¹åŒæ™‚èµ·å‹•å•é¡Œ
- âœ… SSR/CSRä¸ä¸€è‡´å•é¡Œ

### ğŸš¨ èªè¨¼é–¢é€£ã®ç™½ç”»é¢å•é¡Œã®è§£æ±ºï¼ˆ2025-09-27ï¼‰

#### å•é¡Œã®æ¦‚è¦
ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰èªè¨¼ã§ç™½ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„å•é¡ŒãŒç™ºç”Ÿã€‚

#### æ ¹æœ¬åŸå› 
1. **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ä¸æ•´åˆ**: AppShellã§localStorage `demo_user`ã‚’å‚ç…§ã€API/ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã¯Cookie `demo_session`ã‚’ä½¿ç”¨
2. **Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä¸å‚™**: `onAuthStateChange`ã®æˆ»ã‚Šå€¤ã«`unsubscribe`ãƒ¡ã‚½ãƒƒãƒ‰ãŒæ¬ ã‘ã¦ã„ãŸ
3. **èªè¨¼ãƒ•ãƒƒã‚¯å•é¡Œ**: useAuthã§ã‚‚åŒæ§˜ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ä¸æ•´åˆã¨unsubscribeå•é¡Œ

#### å®Ÿè£…ã—ãŸè§£æ±ºç­–

##### 1. Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä¿®æ­£ (`src/lib/supabase/client.ts`)
```typescript
onAuthStateChange: () => ({
  data: {
    subscription: {
      unsubscribe: () => {
        console.log('Demo mode: unsubscribe called');
      }
    }
  }
}),
```

##### 2. AppShellã®ä¿®æ­£ (`src/components/layout/app-shell.tsx`)
```typescript
// demo_session Cookieã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
const getDemoUserFromCookie = () => {
  try {
    const value = document.cookie
      .split('; ')
      .find(row => row.startsWith('demo_session='));

    if (value) {
      const cookieValue = value.split('=')[1];
      return JSON.parse(decodeURIComponent(cookieValue));
    }
    return null;
  } catch (error) {
    console.error('Failed to parse demo session cookie:', error);
    return null;
  }
};
```

##### 3. useAuthãƒ•ãƒƒã‚¯ã®ä¿®æ­£ (`src/hooks/use-auth.ts`)
- localStorage `demo_user` â†’ Cookie `demo_session`ã¸ã®å¤‰æ›´
- å®‰å…¨ãªunsubscribeå‡¦ç†ã®å®Ÿè£…

#### çµæœ
- âœ… ç™½ç”»é¢å•é¡Œå®Œå…¨è§£æ±º
- âœ… ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ­£å¸¸è¡¨ç¤º
- âœ… ãƒ‡ãƒ¢ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ­£å¸¸å‹•ä½œ
- âš ï¸ Supabaseè­¦å‘ŠãŒæ®‹ã‚‹ãŒæ©Ÿèƒ½ã«ã¯å½±éŸ¿ãªã—

---

### ğŸ è³ä¸ç®¡ç†æ©Ÿèƒ½è©³ç´°ï¼ˆ2025-09-27å®Œæˆï¼‰

#### å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½
- **15åå…¨å“¡ã®è©³ç´°è³ä¸æ˜ç´°è¡¨ç¤º** - å¾“æ¥­å“¡åˆ¥ã®è©³ç´°ãªè³ä¸è¨ˆç®—çµæœ
- **è³ä¸è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³** - åŸºæœ¬è³ä¸ãƒ»æŸ»å®šè³ä¸ãƒ»æ§é™¤é¡ã®å®Œå…¨è¨ˆç®—
- **æŸ»å®šè©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ ** - S/A/B/C/Dè©•ä¾¡ã¨ãƒãƒƒã‚¸è¡¨ç¤º
- **è³ä¸ç¨®åˆ¥é¸æŠ** - å¤å­£/å†¬å­£/ç‰¹åˆ¥è³ä¸ã®è¤‡æ•°ç¨®åˆ¥å¯¾å¿œ
- **æœŸé–“é¸æŠæ©Ÿèƒ½** - æ”¯çµ¦æœŸé–“ã®æŸ”è»Ÿãªé¸æŠ
- **è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«é€£æº** - PayrollDetailModalã§è³ä¸è©³ç´°è¡¨ç¤º
- **Hydrationã‚¨ãƒ©ãƒ¼è§£æ±º** - MountGateã§SSR/CSRä¸ä¸€è‡´å®Œå…¨å¯¾å¿œ

#### æŠ€è¡“ä»•æ§˜
```typescript
// è³ä¸ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
interface BonusCalculation {
  id: string;
  employeeId: string;
  bonusType: 'summer' | 'winter' | 'special';
  basicBonus: number;      // åŸºæœ¬è³ä¸ï¼ˆåŸºæœ¬çµ¦Ã—æœˆæ•°ï¼‰
  performanceBonus: number; // æŸ»å®šè³ä¸ï¼ˆS=50%, A=30%, B=15%, C=5%, D=0%ï¼‰
  totalDeductions: number; // æ§é™¤é¡ï¼ˆç¤¾ä¼šä¿é™ºãƒ»æ‰€å¾—ç¨ï¼‰
  netBonus: number;        // å·®å¼•æ”¯çµ¦é¡
  performanceRating: 'S' | 'A' | 'B' | 'C' | 'D';
  // ...ãã®ä»–
}
```

#### è³ä¸è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
- **å¤å­£è³ä¸**: åŸºæœ¬çµ¦Ã—2.5ãƒ¶æœˆ + æŸ»å®šè³ä¸
- **å†¬å­£è³ä¸**: åŸºæœ¬çµ¦Ã—3.0ãƒ¶æœˆ + æŸ»å®šè³ä¸
- **ç‰¹åˆ¥è³ä¸**: åŸºæœ¬çµ¦Ã—1.0ãƒ¶æœˆ + æŸ»å®šè³ä¸
- **æ§é™¤è¨ˆç®—**: å¥åº·ä¿é™ºãƒ»åšç”Ÿå¹´é‡‘ãƒ»é›‡ç”¨ä¿é™ºãƒ»æ‰€å¾—ç¨ï¼ˆè³ä¸ç”¨ç¨ç‡10.21%ï¼‰

#### è§£æ±ºã—ãŸèª²é¡Œ
- âŒ **Before**: ã€Œè³ä¸ã¯ç·é¡ã ã‘ã—ã‹è¦‹ã‚Œãªã„ã§ã¯ã ã‚ã‚ˆã­ï¼Ÿã€
- âœ… **After**: å¾“æ¥­å“¡15åå…¨å“¡ã®è©³ç´°è³ä¸æ˜ç´°å®Œå…¨å¯¾å¿œ

---

**æœ€é‡è¦**: Hydrationã‚¨ãƒ©ãƒ¼ã¨ç™½ç”»é¢èªè¨¼å•é¡Œã¯å®Œå…¨ã«è§£æ±ºæ¸ˆã¿ã€‚å†ç™ºé˜²æ­¢ç­–ã‚‚å®Ÿè£…æ¸ˆã¿ã€‚