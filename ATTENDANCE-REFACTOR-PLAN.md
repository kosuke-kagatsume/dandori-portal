# 勤怠管理 大規模リファクタリング計画

## 概要

PDFの修正依頼（22ページ）に基づき、勤怠管理機能を全面的に改修する。

---

## 現状 vs 要件 ギャップ分析

### タブ構成

| 現在       | 要件                 | ステータス   |
| ---------- | -------------------- | ------------ |
| 勤怠一覧   | 勤怠一覧             | **大幅変更** |
| 勤務表     | 勤怠集計（名称変更） | **大幅変更** |
| チーム勤怠 | 勤怠承認（名称変更） | **大幅変更** |
| シフト     | シフト               | **大幅変更** |
| カレンダー | 削除                 | **削除**     |

### 権限別表示

| 権限                       | 現在                       | 要件                              |
| -------------------------- | -------------------------- | --------------------------------- |
| 一般・システム管理者       | 勤怠一覧/勤務表/カレンダー | 勤怠一覧/勤怠集計/シフト          |
| 人事・マネージャー・経営者 | 全5タブ                    | 勤怠一覧/勤怠集計/勤怠承認/シフト |

---

## Phase 1: タブ構成変更・名称変更

**所要時間目安**: 中

### 変更内容

1. **page.tsx の修正**
   - カレンダータブを削除
   - 「勤務表」→「勤怠集計」に名称変更
   - 「チーム勤怠」→「勤怠承認」に名称変更
   - 権限による表示制御を修正

2. **ファイル変更**
   - `src/app/[locale]/(portal)/attendance/page.tsx`

### 詳細タスク

```
□ カレンダータブ（TabsTrigger/TabsContent）を削除
□ 「勤務表」→「勤怠集計」に名称変更
□ 「チーム勤怠」→「勤怠承認」に名称変更
□ タブ表示権限の修正
  - 一般/システム管理者: 勤怠一覧/勤怠集計/シフト
  - 人事/マネージャー/経営者: 全4タブ
□ 統計カードの「休暇取得」クリック時に休暇管理へ遷移
```

---

## Phase 2: 勤怠一覧タブ改修

**所要時間目安**: 大

### 現状

- MonthlyAttendanceList コンポーネント
- カレンダーグリッド形式
- 詳細/編集ダイアログあり

### 要件（P.4-8）

1. **ヘッダー**
   - 期間表示: `< 2026/02/01 ～ 2026/02/28 >`
   - 前月/翌月切替
   - PDF出力ボタン
   - 締め申請ボタン
   - CSV出力ボタン（人事権限）
   - 代理締め申請ボタン（人事権限）

2. **テーブル形式への変更**（カレンダーから表形式へ）

   | 詳細 | 編集 | 申請 | 日付 | 勤怠区分 | 勤怠申請状況 | 勤務パターン | 出勤 | 退勤 | 休憩入り | 休憩戻り | 総労働 | 所定 | 所定外 | 法定外 | 深夜所定 | 深夜所定外 | 深夜法定外 | 遅刻 | 早退 | 休憩 | 休憩みなし所定 | 休憩みなし所定外 | 休憩みなし法定外 | 備考 |

3. **詳細リンク**: 日次勤怠詳細ダイアログ
4. **編集リンク**: 日次勤怠編集ダイアログ
5. **申請リンク**: ドロップダウン（遅刻/早退/残業/早出/欠勤/休暇/休日出勤）→ ワークフローへ遷移

### ファイル変更

- `src/features/attendance/monthly-attendance-list.tsx` - 大幅改修
- `src/features/attendance/daily-attendance-detail-dialog.tsx` - 新規作成
- `src/features/attendance/daily-attendance-edit-dialog.tsx` - 新規作成
- `src/features/attendance/attendance-closing-apply-dialog.tsx` - 既存改修
- `src/features/attendance/proxy-closing-apply-dialog.tsx` - 新規作成

### 詳細タスク

```
□ テーブル形式のUIに変更
□ 全カラム実装（20+カラム）
□ 期間表示ヘッダー（前月/翌月ボタン）
□ PDF出力ボタン実装
□ CSV出力ボタン（人事権限のみ）
□ 締め申請ボタン・ダイアログ
□ 代理締め申請ボタン・ダイアログ（人事権限のみ）
□ 詳細ダイアログ（P.6参照）
  - 就業ルール表示
  - 勤怠打刻（打刻種別/打刻方法/打刻時間）
  - 勤怠項目
  - 勤務スケジュール
  - 合計時間
  - 備考
  - ワークフロー進行状況
□ 編集ダイアログ（P.7参照）
  - 打刻追加機能
  - 勤務パターン選択（事業場外みなし対応）
  - 勤務スケジュール編集
  - 備考入力
□ 申請ドロップダウン
  - 遅刻/早退/残業/早出/欠勤/休暇/休日出勤
  - クリック→ワークフローへ遷移
```

---

## Phase 3: 勤怠集計タブ改修

**所要時間目安**: 大

### 現状

- インラインでサマリー表示
- 日次一覧テーブルあり
- CSV出力/締め申請あり

### 要件（P.9-12）

1. **削除する要素**
   - 一覧テーブル（不要）
   - 締め申請ボタン（勤怠一覧に移動）
   - 平均出退勤時刻（不要）

2. **表示する集計**
   - 期間表示: `< 2026/02/01 ～ 2026/02/28 >`
   - PDF出力ボタン
   - 日数集計（平日/所定休日/法定休日 × 出勤/欠勤/遅刻/早退）
   - 休暇集計
   - 時間集計（所定/所定外/法定外/深夜所定/深夜所定外/深夜法定外/遅刻/早退/休憩/休憩みなし...）
   - 法定外集計

3. **就業ルール別表示**
   - 固定時間制/時給: 標準の時間集計
   - 1ヶ月単位変形労働制: 基準時間セクション追加（月毎/週毎）
   - フレックス制: フレックス制時間集計セクション追加

### ファイル変更

- `src/features/attendance/attendance-summary-tab.tsx` - 新規作成（勤怠集計タブ専用）
- `src/features/attendance/summary-day-count-table.tsx` - 新規作成
- `src/features/attendance/summary-leave-table.tsx` - 新規作成
- `src/features/attendance/summary-time-table.tsx` - 新規作成
- `src/features/attendance/summary-overtime-table.tsx` - 新規作成
- `src/features/attendance/summary-variable-working-hours.tsx` - 新規作成（変形労働制用）
- `src/features/attendance/summary-flextime.tsx` - 新規作成（フレックス用）

### 詳細タスク

```
□ 新しい勤怠集計タブコンポーネント作成
□ 期間表示ヘッダー
□ PDF出力ボタン
□ 日数集計テーブル
  - 平日/所定休日/法定休日 行
  - 出勤/欠勤/遅刻/早退 列
□ 休暇集計テーブル
□ 時間集計テーブル（P.10参照）
  - 全12カラム
  - 平日/所定休日/法定休日 行
□ 法定外集計
  - 法定外（平日・所定休日）
  - 60時間超法定外（平日・所定休日）
□ 就業ルール判定ロジック
□ 1ヶ月単位変形労働制セクション（P.11）
  - 月毎の基準時間/法定労働時間総枠/前月までの法定外除く労働時間合計
  - 週毎の基準時間/所定労働時間/法定労働時間総枠
□ フレックス制セクション（P.12）
  - 総労働時間/所定労働時間の総枠/清算期間における総労働時間
  - 控除繰越限度時間/控除繰越時間/控除繰越限度超過時間
```

---

## Phase 4: 勤怠承認タブ改修

**所要時間目安**: 大

### 現状

- TeamAttendance コンポーネント
- 打刻状況/勤怠項目別集計 サブタブ
- 当日の勤怠のみ表示

### 要件（P.13-17）

1. **全般**
   - 期間表示: `< 2026/02/01 ～ 2026/02/28 >`
   - 1ヶ月分の横スクロール表示
   - ステータスフィルタ（すべて/未締め/承認待ち/承認済み）

2. **打刻状況タブ**
   - 氏名/日次勤怠(一覧リンク)/承認申請/上長承認/勤怠締め/01日〜31日...
   - 各日セル: 出勤時刻・退勤時刻を2段表示
   - 一覧リンク→該当者の1ヶ月分勤怠一覧
   - 差し戻し/承認ボタン
   - マネージャー: 自分が承認するスタッフのみ
   - 人事: 全スタッフ + 承認解除/勤怠締め/締め解除ボタン

3. **勤怠項目別集計タブ**
   - 選択/承認/勤怠締め/締め解除なし（閲覧のみ）
   - 氏名/部署/所定日数/出勤日数/在宅日数/欠勤日数/遅刻/早退/総労働時間/残業時間/勤怠締め

### ファイル変更

- `src/features/attendance/team-attendance.tsx` - 大幅改修
- `src/features/attendance/team-punch-status-table.tsx` - 新規作成
- `src/features/attendance/team-summary-table.tsx` - 新規作成
- `src/features/attendance/member-attendance-dialog.tsx` - 新規作成（一覧クリック時）

### 詳細タスク

```
□ 期間表示ヘッダー
□ ステータスフィルタ改修（すべて/未締め/承認待ち/承認済み）
□ 検索フィールド維持

□ 打刻状況タブ改修
  - 横スクロール1ヶ月表示
  - 各日セル（出勤/退勤 2段表示）
  - 一覧リンク → メンバー勤怠ダイアログ
  - 承認申請/上長承認/勤怠締め ステータスアイコン
  - 差し戻し/承認ボタン
  - 権限別ボタン表示
    - マネージャー: 承認のみ
    - 人事: 承認解除/勤怠締め/締め解除

□ 勤怠項目別集計タブ改修
  - 選択チェックボックス削除
  - 承認/締めボタン削除
  - 集計カラム表示のみ

□ メンバー勤怠ダイアログ
  - 勤怠一覧タブと同形式
```

---

## Phase 5: シフトタブ改修

**所要時間目安**: 大

### 現状

- ShiftManagement コンポーネント
- カレンダー/シフト一覧/月間集計 サブタブ

### 要件（P.18-20）

1. **削除**: カレンダータブ
2. **サブタブ**: パターンシフト表 / 時間帯シフト
3. **パターンシフト表**
   - 期間表示
   - 部署フィルタ
   - CSV出力/CSV取込/PDF出力/保存ボタン（マネージャー・人事のみ）
   - 横スクロール1ヶ月表示
   - 各日: 勤怠区分（平日/休日）+ 勤務パターン（通常勤務etc）

4. **時間帯シフト**
   - 日付選択（デフォルト当日）
   - 部署フィルタ
   - PDF出力/保存ボタン
   - ガントチャート形式（00:00〜24:00）
   - 勤務時間帯をバーで表示

### ファイル変更

- `src/features/attendance/shift-management.tsx` - 大幅改修
- `src/features/attendance/pattern-shift-table.tsx` - 新規作成
- `src/features/attendance/time-slot-shift.tsx` - 新規作成

### 詳細タスク

```
□ カレンダータブ削除
□ サブタブ変更: パターンシフト表/時間帯シフト

□ パターンシフト表
  - 期間表示ヘッダー
  - 部署フィルタ
  - CSV出力/CSV取込/PDF出力/保存ボタン
  - 権限制御（取込・保存はマネージャー・人事のみ）
  - 横スクロール1ヶ月テーブル
  - 各日セル（勤怠区分 + 勤務パターン）
  - 権限別スタッフ表示
    - 経営者・人事: 全スタッフ
    - その他: 自部署のみ

□ 時間帯シフト
  - 日付選択（カレンダーピッカー）
  - 部署フィルタ
  - PDF出力/保存ボタン
  - 00:00〜24:00 タイムライン
  - 勤務時間帯バー表示
  - 左右スクロールで前日/翌日表示
```

---

## Phase 6: その他の修正

**所要時間目安**: 中

### 6.1 複数打刻の履歴保存（P.2）

**現状**: 退勤後に再出勤すると上書きされる
**要件**: 全ての打刻（休憩含む）を履歴として保存

**ファイル変更**:

- `src/lib/store/attendance-store.ts`
- `src/lib/store/attendance-history-store.ts`
- `src/app/api/attendance/route.ts`
- DBスキーマ変更（attendance_punches テーブル追加検討）

### 6.2 休暇取得カードのリンク（P.1）

**要件**: クリック時に休暇管理メニューへ遷移

**ファイル変更**:

- `src/app/[locale]/(portal)/attendance/page.tsx`

### 6.3 休職・休業連携（P.21）

**要件**: ユーザー管理の休職履歴が勤怠に自動反映

**ファイル変更**:

- ユーザー管理との連携ロジック追加
- 勤怠表示時に休職期間をチェック

### 6.4 エクスポート時間フォーマット（P.22）

**要件**: 4種類の時間フォーマット

- 時刻表示（1:30）
- 時間+分表示（1.30）
- 小数点表示（1.50）
- 分表示（90）

**ファイル変更**:

- `src/app/[locale]/(portal)/settings/page.tsx` - エクスポート設定
- エクスポート処理でフォーマット適用

---

## 実装順序

| Phase | 内容             | 優先度 | 依存関係  |
| ----- | ---------------- | ------ | --------- |
| **1** | タブ構成変更     | 高     | なし      |
| **2** | 勤怠一覧タブ改修 | 高     | Phase 1   |
| **3** | 勤怠集計タブ改修 | 高     | Phase 1   |
| **4** | 勤怠承認タブ改修 | 高     | Phase 1   |
| **5** | シフトタブ改修   | 中     | Phase 1   |
| **6** | その他の修正     | 中     | Phase 2-5 |

---

## 新規作成ファイル一覧

```
src/features/attendance/
├── daily-attendance-detail-dialog.tsx      # Phase 2
├── daily-attendance-edit-dialog.tsx        # Phase 2
├── proxy-closing-apply-dialog.tsx          # Phase 2
├── attendance-summary-tab.tsx              # Phase 3
├── summary-day-count-table.tsx             # Phase 3
├── summary-leave-table.tsx                 # Phase 3
├── summary-time-table.tsx                  # Phase 3
├── summary-overtime-table.tsx              # Phase 3
├── summary-variable-working-hours.tsx      # Phase 3
├── summary-flextime.tsx                    # Phase 3
├── team-punch-status-table.tsx             # Phase 4
├── team-summary-table.tsx                  # Phase 4
├── member-attendance-dialog.tsx            # Phase 4
├── pattern-shift-table.tsx                 # Phase 5
└── time-slot-shift.tsx                     # Phase 5
```

**新規ファイル数**: 15ファイル

---

## 大幅改修ファイル一覧

```
src/app/[locale]/(portal)/attendance/page.tsx
src/features/attendance/monthly-attendance-list.tsx
src/features/attendance/team-attendance.tsx
src/features/attendance/shift-management.tsx
src/features/attendance/attendance-closing-dialog.tsx
src/lib/store/attendance-store.ts
src/lib/store/attendance-history-store.ts
```

**改修ファイル数**: 7ファイル

---

## 削除ファイル一覧

```
src/features/attendance/attendance-calendar.tsx  # カレンダータブ削除
```

---

## リスク・注意点

1. **大規模改修**: 勤怠管理は基幹機能のため、慎重にテストが必要
2. **データ互換性**: 既存の打刻データとの互換性確保
3. **権限制御**: 複雑な権限ロジックのテスト
4. **パフォーマンス**: 1ヶ月分の横スクロール表示は重くなる可能性
5. **就業ルール対応**: 固定/変形/フレックスの3パターン対応

---

## 検証方法

```bash
# 1. ビルド確認
npm run build

# 2. lint確認
npm run lint

# 3. 型チェック
npx tsc --noEmit

# 4. 動作確認（各権限でログイン）
- 一般ユーザー
- マネージャー
- 人事権限
- システム管理者
```

---

## 次のステップ

1. この計画の承認
2. Phase 1（タブ構成変更）から着手
3. 各Phase完了ごとにコミット
4. 全Phase完了後にプッシュ
