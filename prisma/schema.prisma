generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model achievements {
  id                String            @id
  tenantId          String
  profileId         String
  userId            String
  title             String
  description       String?
  date              DateTime          @db.Date
  category          String?
  attachments       Json?
  isPublic          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime
  employee_profiles employee_profiles @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([tenantId, category])
  @@index([tenantId])
  @@index([userId])
}

model activity_feeds {
  id           String   @id
  tenantId     String
  activityType String
  title        String
  description  String?
  icon         String?
  userId       String?
  userName     String?
  resourceType String?
  resourceId   String?
  priority     String   @default("normal")
  isPublic     Boolean  @default(true)
  targetRoles  String[]
  createdAt    DateTime @default(now())

  @@index([tenantId, activityType])
  @@index([tenantId, createdAt])
  @@index([tenantId])
  @@index([tenantId, userId])
}

model announcement_reads {
  id                String        @id
  tenantId          String
  announcementId    String
  userId            String
  readAt            DateTime      @default(now())
  actionCompleted   Boolean       @default(false)
  actionCompletedAt DateTime?
  announcements     announcements @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  @@unique([announcementId, userId])
  @@index([announcementId])
  @@index([tenantId])
  @@index([tenantId, userId])
  @@index([userId])
}

model announcements {
  id                 String               @id
  tenantId           String
  title              String
  content            String
  type               String               @default("general")
  priority           String               @default("normal")
  target             String               @default("all")
  targetDepartments  String[]
  targetRoles        String[]
  published          Boolean              @default(false)
  publishedAt        DateTime?
  startDate          DateTime             @db.Date
  endDate            DateTime?            @db.Date
  requiresAction     Boolean              @default(false)
  actionLabel        String?
  actionUrl          String?
  actionDeadline     DateTime?            @db.Date
  createdBy          String
  createdByName      String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  announcement_reads announcement_reads[]

  @@index([published, startDate, endDate])
  @@index([tenantId])
  @@index([tenantId, published])
  @@index([tenantId, startDate])
}

// ============================================
// Phase 8: アナウンス種別マスタ
// ============================================

model announcement_types {
  id          String   @id
  tenantId    String
  code        String // 種別コード（general, urgent, maintenance, etc.）
  name        String // 種別名（お知らせ、緊急、メンテナンス等）
  description String? // 説明
  color       String   @default("#3B82F6") // 表示色
  icon        String? // アイコン名
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  isSystem    Boolean  @default(false) // システム定義（削除不可）
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, isActive])
}

model approval_flow_approvers {
  id                  String              @id
  stepId              String
  approverType        String
  approverId          String?
  approverRole        String?
  positionLevel       Int?
  order               Int                 @default(1)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime
  approval_flow_steps approval_flow_steps @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@index([stepId])
}

model approval_flow_conditions {
  id                        String                    @id
  flowId                    String
  field                     String
  operator                  String
  value                     Float
  description               String?
  createdAt                 DateTime                  @default(now())
  updatedAt                 DateTime
  approval_flow_definitions approval_flow_definitions @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@index([flowId])
}

model approval_flow_definitions {
  id                       String                     @id
  tenantId                 String
  name                     String
  description              String?
  documentType             String
  flowType                 String
  useOrganizationHierarchy Boolean                    @default(false)
  organizationLevels       Int?
  isActive                 Boolean                    @default(true)
  isDefault                Boolean                    @default(false)
  priority                 Int                        @default(1)
  createdBy                String
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime
  approval_flow_conditions approval_flow_conditions[]
  approval_flow_steps      approval_flow_steps[]

  @@index([tenantId, documentType])
  @@index([tenantId, documentType, isActive])
  @@index([tenantId])
}

model approval_flow_steps {
  id                        String                    @id
  flowId                    String
  stepNumber                Int
  name                      String
  executionMode             String                    @default("serial")
  requiredApprovals         Int                       @default(1)
  timeoutHours              Int?
  allowDelegate             Boolean                   @default(true)
  allowSkip                 Boolean                   @default(false)
  createdAt                 DateTime                  @default(now())
  updatedAt                 DateTime
  approval_flow_approvers   approval_flow_approvers[]
  approval_flow_definitions approval_flow_definitions @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@index([flowId])
  @@index([flowId, stepNumber])
}

model approval_steps {
  id                String            @id
  tenantId          String
  workflowId        String
  order             Int
  approverRole      String
  approverId        String?
  approverName      String?
  status            String            @default("pending")
  actionDate        DateTime?
  comments          String?
  executionMode     String            @default("sequential")
  timeoutHours      Int?
  isEscalated       Boolean           @default(false)
  escalatedTo       String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime
  workflow_requests workflow_requests @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([approverId])
  @@index([status])
  @@index([tenantId, approverId])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([workflowId])
}

model attendance {
  id                String    @id
  tenantId          String
  userId            String
  date              DateTime  @db.Date
  checkIn           DateTime?
  checkOut          DateTime?
  breakStart        DateTime?
  breakEnd          DateTime?
  totalBreakMinutes Int       @default(0)
  workMinutes       Int       @default(0)
  overtimeMinutes   Int       @default(0)
  workLocation      String    @default("office")
  status            String    @default("present")
  memo              String?
  approvalStatus    String?
  approvalReason    String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime
  checkInLocation   Json?
  checkOutLocation  Json?
  tenants           tenants   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user              users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([date])
  @@index([status])
  @@index([tenantId, date])
  @@index([tenantId])
  @@index([tenantId, userId])
  @@index([userId])
}

model attendance_settings {
  id                       String   @id
  tenantId                 String   @unique
  workStartTime            String   @default("09:00")
  workEndTime              String   @default("18:00")
  breakStartTime           String   @default("12:00")
  breakEndTime             String   @default("13:00")
  breakDurationMinutes     Int      @default(60)
  enableFlexTime           Boolean  @default(false)
  coreTimeStart            String?
  coreTimeEnd              String?
  overtimeThresholdMinutes Int      @default(480)
  maxOvertimeHoursPerMonth Int      @default(45)
  allowRemoteCheckIn       Boolean  @default(true)
  requireLocationOnCheckIn Boolean  @default(false)
  allowEarlyCheckIn        Boolean  @default(true)
  earlyCheckInMinutes      Int      @default(30)
  weeklyHolidays           String[] @default(["saturday", "sunday"])
  createdAt                DateTime @default(now())
  updatedAt                DateTime

  @@index([tenantId])
}

model certification_notification_settings {
  id                      String   @id
  tenantId                String   @unique
  notificationDays        Int[]    @default([90, 60, 30, 14, 7])
  enableEmailNotification Boolean  @default(true)
  enablePushNotification  Boolean  @default(true)
  enableInAppNotification Boolean  @default(true)
  escalateToManagerDays   Int      @default(30)
  escalateToHrDays        Int      @default(14)
  autoUpdateStatus        Boolean  @default(true)
  warningThresholdDays    Int      @default(30)
  createdAt               DateTime @default(now())
  updatedAt               DateTime
}

model certification_notifications {
  id                 String         @id
  tenantId           String
  certificationId    String
  userId             String
  notificationType   String
  daysUntilExpiry    Int
  sentAt             DateTime?
  readAt             DateTime?
  acknowledgedAt     DateTime?
  emailSent          Boolean        @default(false)
  pushSent           Boolean        @default(false)
  inAppSent          Boolean        @default(false)
  escalatedToManager Boolean        @default(false)
  escalatedToHr      Boolean        @default(false)
  managerNotifiedAt  DateTime?
  hrNotifiedAt       DateTime?
  createdAt          DateTime       @default(now())
  certifications     certifications @relation(fields: [certificationId], references: [id], onDelete: Cascade)

  @@index([certificationId])
  @@index([sentAt])
  @@index([tenantId])
  @@index([tenantId, notificationType])
  @@index([tenantId, userId])
  @@index([userId])
}

model certification_renewals {
  id                   String         @id
  tenantId             String
  certificationId      String
  userId               String
  newIssueDate         DateTime       @db.Date
  newExpiryDate        DateTime?      @db.Date
  newCredentialId      String?
  newDocumentUrl       String?
  newDocumentName      String?
  notes                String?
  status               String         @default("pending")
  reviewedBy           String?
  reviewedByName       String?
  reviewedAt           DateTime?
  reviewComment        String?
  documentVerified     Boolean        @default(false)
  dateVerified         Boolean        @default(false)
  organizationVerified Boolean        @default(false)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime
  certifications       certifications @relation(fields: [certificationId], references: [id], onDelete: Cascade)

  @@index([certificationId])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, userId, status])
  @@index([userId])
}

model certifications {
  id                          String                        @id
  tenantId                    String
  profileId                   String
  userId                      String
  name                        String
  organization                String
  issueDate                   DateTime                      @db.Date
  expiryDate                  DateTime?                     @db.Date
  credentialId                String?
  status                      String                        @default("active")
  documentUrl                 String?
  documentName                String?
  documentSize                String?
  notes                       String?
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime
  certification_notifications certification_notifications[]
  certification_renewals      certification_renewals[]
  employee_profiles           employee_profiles             @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([tenantId, expiryDate])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([userId])
}

model company_settings {
  id                  String    @id
  tenantId            String    @unique
  name                String
  nameKana            String?
  postalCode          String?
  address             String?
  phone               String?
  fax                 String?
  email               String?
  corporateNumber     String?
  representativeName  String?
  representativeTitle String?
  taxOffice           String?
  taxOfficeCode       String?
  fiscalYearEnd       String?
  foundedDate         DateTime? @db.Date
  createdAt           DateTime  @default(now())
  updatedAt           DateTime

  @@index([tenantId])
}

model daily_attendance_metrics {
  id                   String   @id
  tenantId             String
  date                 DateTime @db.Date
  totalEmployees       Int      @default(0)
  presentCount         Int      @default(0)
  absentCount          Int      @default(0)
  leaveCount           Int      @default(0)
  lateCount            Int      @default(0)
  earlyLeaveCount      Int      @default(0)
  remoteCount          Int      @default(0)
  totalWorkMinutes     Int      @default(0)
  totalOvertimeMinutes Int      @default(0)
  avgWorkMinutes       Int      @default(0)
  attendanceRate       Float    @default(0)
  calculatedAt         DateTime @default(now())
  createdAt            DateTime @default(now())
  updatedAt            DateTime

  @@unique([tenantId, date])
  @@index([tenantId, date])
  @@index([tenantId])
}

model departments {
  id        String   @id
  tenantId  String
  name      String
  parentId  String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([tenantId, sortOrder])
}

model dw_notifications {
  id          String    @id
  type        String
  title       String
  description String?
  priority    String    @default("normal")
  tenantId    String?
  tenantName  String?
  invoiceId   String?
  amount      Int?
  isRead      Boolean   @default(false)
  readAt      DateTime?
  readBy      String?
  actionUrl   String?
  actionLabel String?
  createdAt   DateTime  @default(now())

  @@index([createdAt])
  @@index([isRead])
  @@index([tenantId])
  @@index([type])
}

model employee_change_requests {
  id             String    @id
  tenantId       String
  userId         String
  requestType    String
  fieldName      String?
  currentValue   String?
  newValue       String
  reason         String?
  attachments    Json?
  status         String    @default("pending")
  reviewedBy     String?
  reviewedByName String?
  reviewedAt     DateTime?
  reviewComment  String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime

  @@index([tenantId])
  @@index([tenantId, requestType])
  @@index([tenantId, status])
  @@index([userId])
}

model employee_profiles {
  id                       String             @id
  tenantId                 String
  userId                   String             @unique
  employeeNumber           String?
  nameKana                 String?
  birthDate                DateTime?          @db.Date
  gender                   String?
  phone                    String?
  mobilePhone              String?
  postalCode               String?
  address                  String?
  addressKana              String?
  emergencyContactName     String?
  emergencyContactRelation String?
  emergencyContactPhone    String?
  bankName                 String?
  bankBranch               String?
  bankAccountType          String?
  bankAccountNumber        String?
  bankAccountHolder        String?
  commuteMethod            String?
  commuteRoute             String?
  commuteDistance          Float?
  commuteCost              Int?
  employmentType           String?
  contractEndDate          DateTime?          @db.Date
  completedProjectsCount   Int                @default(0)
  teamMembersCount         Int                @default(0)
  yearsOfExperience        Int                @default(0)
  createdAt                DateTime           @default(now())
  updatedAt                DateTime
  achievements             achievements[]
  certifications           certifications[]
  employee_skills          employee_skills[]
  work_experiences         work_experiences[]

  @@index([tenantId, employeeNumber])
  @@index([tenantId])
  @@index([userId])
}

model employee_skills {
  id                String            @id
  tenantId          String
  profileId         String
  userId            String
  name              String
  category          String
  level             Int               @default(50)
  selfAssessment    Int?
  managerAssessment Int?
  assessedAt        DateTime?
  notes             String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime
  employee_profiles employee_profiles @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, name])
  @@index([profileId])
  @@index([tenantId, category])
  @@index([tenantId])
  @@index([userId])
}

model employment_types {
  id        String   @id
  tenantId  String
  name      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, isActive])
}

model general_assets {
  id                 String           @id
  tenantId           String
  assetNumber        String
  category           String
  name               String
  manufacturer       String?
  model              String?
  serialNumber       String?
  specifications     Json?
  assignedUserId     String?
  assignedUserName   String?
  assignedDate       DateTime?        @db.Date
  ownershipType      String           @default("owned")
  purchaseDate       DateTime?        @db.Date
  purchaseCost       Int?
  leaseCompany       String?
  leaseMonthlyCost   Int?
  leaseStartDate     DateTime?        @db.Date
  leaseEndDate       DateTime?        @db.Date
  warrantyExpiration DateTime?        @db.Date
  status             String           @default("active")
  notes              String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime
  repair_records     repair_records[]

  @@unique([tenantId, assetNumber])
  @@index([tenantId, assignedUserId])
  @@index([tenantId, category])
  @@index([tenantId])
  @@index([tenantId, status])
}

model health_access_logs {
  id           String   @id
  tenantId     String
  userId       String
  targetUserId String
  resourceType String
  resourceId   String?
  action       String
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  @@index([targetUserId])
  @@index([tenantId, createdAt])
  @@index([tenantId])
  @@index([userId])
}

model health_checkup_summaries {
  id                     String   @id
  tenantId               String
  fiscalYear             Int
  month                  Int
  totalEmployees         Int      @default(0)
  completedCount         Int      @default(0)
  pendingCount           Int      @default(0)
  completionRate         Float    @default(0)
  resultACount           Int      @default(0)
  resultBCount           Int      @default(0)
  resultCCount           Int      @default(0)
  resultDCount           Int      @default(0)
  resultECount           Int      @default(0)
  requiresReexamCount    Int      @default(0)
  requiresTreatmentCount Int      @default(0)
  requiresGuidanceCount  Int      @default(0)
  calculatedAt           DateTime @default(now())
  createdAt              DateTime @default(now())
  updatedAt              DateTime

  @@unique([tenantId, fiscalYear, month])
  @@index([tenantId, fiscalYear])
  @@index([tenantId])
}

model health_checkups {
  id                     String            @id
  tenantId               String
  userId                 String
  userName               String
  checkupDate            DateTime          @db.Date
  checkupType            String
  medicalInstitution     String?
  fiscalYear             Int
  overallResult          String
  requiresReexam         Boolean           @default(false)
  requiresTreatment      Boolean           @default(false)
  requiresGuidance       Boolean           @default(false)
  height                 Float?
  weight                 Float?
  bmi                    Float?
  waistCircumference     Float?
  eyesightLeft           Float?
  eyesightRight          Float?
  hearingLeft            String?
  hearingRight           String?
  bloodPressureSystolic  Int?
  bloodPressureDiastolic Int?
  bloodGlucose           Float?
  hba1c                  Float?
  triglycerides          Float?
  hdlCholesterol         Float?
  ldlCholesterol         Float?
  got                    Float?
  gpt                    Float?
  gammaGtp               Float?
  uricAcid               Float?
  urinaryProtein         String?
  urinaryGlucose         String?
  followUpStatus         String            @default("none")
  followUpDate           DateTime?         @db.Date
  followUpNotes          String?
  doctorOpinion          String?
  workRestriction        String?
  attachments            Json?
  createdAt              DateTime          @default(now())
  updatedAt              DateTime
  health_findings        health_findings[]

  @@index([tenantId, checkupDate])
  @@index([tenantId, fiscalYear])
  @@index([tenantId])
  @@index([tenantId, userId])
  @@index([userId])
}

model health_findings {
  id              String          @id
  checkupId       String
  category        String
  finding         String
  severity        String
  recommendation  String?
  createdAt       DateTime        @default(now())
  health_checkups health_checkups @relation(fields: [checkupId], references: [id], onDelete: Cascade)

  @@index([checkupId])
}

model health_settings {
  id                        String   @id
  tenantId                  String   @unique
  checkupPeriodStart        Int      @default(4)
  checkupPeriodEnd          Int      @default(3)
  checkupReminderDays       Int      @default(30)
  requireCheckupForNewHires Boolean  @default(true)
  stressCheckPeriodStart    Int      @default(10)
  stressCheckPeriodEnd      Int      @default(11)
  stressCheckReminderDays   Int      @default(14)
  stressCheckRequired       Boolean  @default(true)
  highStressThresholdA      Int      @default(77)
  highStressThresholdB      Int      @default(63)
  allowSelfView             Boolean  @default(true)
  allowManagerViewStatus    Boolean  @default(true)
  allowHrViewStats          Boolean  @default(true)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime
}

model invoice_items {
  id          String   @id
  invoiceId   String
  description String
  quantity    Int
  unitPrice   Int
  amount      Int
  period      String?
  invoices    invoices @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model invoice_reminders {
  id            String    @id
  tenantId      String
  invoiceId     String
  reminderType  String
  scheduledDate DateTime  @db.Date
  daysBeforeDue Int
  status        String    @default("scheduled")
  sentAt        DateTime?
  sentTo        String?
  errorMessage  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime
  invoices      invoices  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([scheduledDate])
  @@index([status])
  @@index([tenantId])
}

model invoices {
  id                String              @id
  invoiceNumber     String              @unique
  tenantId          String
  billingMonth      DateTime            @db.Date
  subtotal          Int
  tax               Int
  total             Int
  status            String              @default("draft")
  dueDate           DateTime            @db.Date
  paidDate          DateTime?           @db.Date
  sentDate          DateTime?
  billingEmail      String
  memo              String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  invoice_items     invoice_items[]
  invoice_reminders invoice_reminders[]
  tenants           tenants             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payments          payments[]

  @@index([billingMonth])
  @@index([invoiceNumber])
  @@index([status])
  @@index([tenantId, billingMonth])
  @@index([tenantId])
  @@index([tenantId, status])
}

model leave_balances {
  id                         String   @id
  tenantId                   String
  userId                     String
  year                       Int
  paidLeaveTotal             Int      @default(0)
  paidLeaveUsed              Float    @default(0)
  paidLeaveRemaining         Float    @default(0)
  paidLeaveExpiry            DateTime @db.Date
  sickLeaveTotal             Int      @default(0)
  sickLeaveUsed              Float    @default(0)
  sickLeaveRemaining         Float    @default(0)
  specialLeaveTotal          Int      @default(0)
  specialLeaveUsed           Float    @default(0)
  specialLeaveRemaining      Float    @default(0)
  compensatoryLeaveTotal     Int      @default(0)
  compensatoryLeaveUsed      Float    @default(0)
  compensatoryLeaveRemaining Float    @default(0)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime

  @@unique([userId, year])
  @@index([tenantId])
  @@index([tenantId, userId])
  @@index([userId])
}

model leave_requests {
  id             String    @id
  tenantId       String
  userId         String
  userName       String
  type           String
  startDate      DateTime  @db.Date
  endDate        DateTime  @db.Date
  days           Float
  reason         String
  attachments    Json?
  status         String    @default("draft")
  approver       String?
  approverName   String?
  approvedDate   DateTime?
  rejectedReason String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime

  @@index([endDate])
  @@index([startDate])
  @@index([status])
  @@index([tenantId])
  @@index([tenantId, startDate])
  @@index([tenantId, status])
  @@index([tenantId, userId])
  @@index([userId])
}

model legal_updates {
  id                    String                  @id
  title                 String
  description           String?
  category              String
  effectiveDate         DateTime                @db.Date
  relatedLaws           String?
  affectedAreas         String[]
  priority              String                  @default("medium")
  isPublished           Boolean                 @default(false)
  publishedAt           DateTime?
  referenceUrl          String?
  attachments           Json?
  createdBy             String?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  tenant_legal_statuses tenant_legal_statuses[]

  @@index([category])
  @@index([effectiveDate])
  @@index([isPublished, effectiveDate])
  @@index([isPublished])
  @@index([priority])
}

model maintenance_records {
  id              String    @id
  tenantId        String
  vehicleId       String
  type            String
  date            DateTime  @db.Date
  mileage         Int?
  cost            Int
  vendorId        String?
  description     String?
  nextDueDate     DateTime? @db.Date
  nextDueMileage  Int?
  tireType        String?
  performedBy     String?
  performedByName String?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  vehicles        vehicles  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  vendors         vendors?  @relation(fields: [vendorId], references: [id])

  @@index([tenantId])
  @@index([tenantId, type])
  @@index([tenantId, vehicleId])
  @@index([vehicleId])
}

model monthly_mileages {
  id             String   @id
  tenantId       String
  vehicleId      String
  month          String
  distance       Int
  recordedBy     String?
  recordedByName String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime
  vehicles       vehicles @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([vehicleId, month])
  @@index([tenantId])
  @@index([vehicleId])
}

model org_units {
  id              String      @id
  tenantId        String
  name            String
  parentId        String?
  level           Int         @default(0)
  headUserId      String?
  type            String
  memberCount     Int         @default(0)
  description     String?
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime
  org_units       org_units?  @relation("org_unitsToorg_units", fields: [parentId], references: [id])
  other_org_units org_units[] @relation("org_unitsToorg_units")
  tenants         tenants     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users           users[]

  @@index([parentId])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([tenantId, parentId])
}

model payments {
  id              String    @id
  tenantId        String
  invoiceId       String
  amount          Int
  paymentDate     DateTime  @db.Date
  paymentMethod   String    @default("bank_transfer")
  status          String    @default("completed")
  transactionId   String?
  notes           String?
  confirmedBy     String?
  confirmedByName String?
  confirmedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  invoices        invoices  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([tenantId])
  @@index([tenantId, paymentDate])
  @@index([tenantId, status])
}

model payroll_settings {
  id                        String   @id
  tenantId                  String   @unique
  paymentDay                Int      @default(25)
  paymentDayType            String   @default("current")
  closingDay                Int      @default(31)
  defaultPayType            String   @default("monthly")
  standardWorkHours         Float    @default(8)
  standardWorkDays          Int      @default(20)
  enableHealthInsurance     Boolean  @default(true)
  enablePensionInsurance    Boolean  @default(true)
  enableEmploymentInsurance Boolean  @default(true)
  enableIncomeTax           Boolean  @default(true)
  enableResidentTax         Boolean  @default(true)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime

  @@index([tenantId])
}

// ========================================
// Phase 5: 給与管理マスタ
// ========================================

// 給与項目マスタ（支給項目・控除項目の定義）
model salary_items {
  id                String   @id
  tenantId          String
  code              String   // 項目コード
  name              String   // 項目名
  category          String   // earning:支給, deduction:控除
  itemType          String   // fixed:固定, variable:変動, calculated:計算
  calculationType   String?  // hourly:時給計算, rate:率計算, fixed:固定額
  defaultAmount     Int?     // デフォルト金額
  isRequired        Boolean  @default(false) // 必須項目
  isTaxable         Boolean  @default(true)  // 課税対象
  isInsuranceTarget Boolean  @default(true)  // 社会保険対象
  sortOrder         Int      @default(0)
  isActive          Boolean  @default(true)
  description       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, category])
  @@index([tenantId, isActive])
}

// 手当種別マスタ
model allowance_types {
  id                String   @id
  tenantId          String
  code              String   // 手当コード
  name              String   // 手当名
  calculationType   String   @default("fixed") // fixed:固定額, rate:率, formula:計算式
  defaultAmount     Int?     // デフォルト金額
  rate              Float?   // 率（%）
  formula           String?  // 計算式（JSON）
  isTaxable         Boolean  @default(true)  // 課税対象
  isInsuranceTarget Boolean  @default(true)  // 社会保険対象
  isCommuting       Boolean  @default(false) // 通勤手当フラグ
  maxAmount         Int?     // 上限金額
  conditions        String?  // 支給条件（JSON）
  sortOrder         Int      @default(0)
  isActive          Boolean  @default(true)
  description       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, isActive])
}

// 控除種別マスタ
model deduction_types {
  id                String   @id
  tenantId          String
  code              String   // 控除コード
  name              String   // 控除名
  calculationType   String   @default("fixed") // fixed:固定額, rate:率, table:テーブル参照
  deductionCategory String   @default("other") // social_insurance:社会保険, tax:税金, other:その他
  defaultAmount     Int?     // デフォルト金額
  rate              Float?   // 率（%）
  isPreTax          Boolean  @default(true)  // 税引前控除
  sortOrder         Int      @default(0)
  isActive          Boolean  @default(true)
  description       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, deductionCategory])
  @@index([tenantId, isActive])
}

// 社会保険等級表（健康保険・厚生年金）
model social_insurance_grades {
  id                       String   @id
  tenantId                 String
  fiscalYear               Int      // 適用年度
  grade                    Int      // 等級
  standardMonthlyAmount    Int      // 標準報酬月額
  minMonthlyAmount         Int?     // 報酬月額下限
  maxMonthlyAmount         Int?     // 報酬月額上限
  healthInsuranceEmployee  Int      // 健康保険料（本人負担）
  healthInsuranceEmployer  Int      // 健康保険料（事業主負担）
  pensionInsuranceEmployee Int      // 厚生年金（本人負担）
  pensionInsuranceEmployer Int      // 厚生年金（事業主負担）
  insuranceType            String   @default("general") // general:一般, specific:特定適用事業所
  prefectureCode           String?  // 都道府県コード（健康保険料は都道府県で異なる）
  isActive                 Boolean  @default(true)
  createdAt                DateTime @default(now())
  updatedAt                DateTime

  @@unique([tenantId, fiscalYear, grade, insuranceType])
  @@index([tenantId, fiscalYear])
  @@index([tenantId, fiscalYear, standardMonthlyAmount])
}

// 従業員給与設定
model employee_salary_settings {
  id                    String    @id
  tenantId              String
  userId                String    // usersテーブルへの参照
  employeeNumber        String?   // 従業員番号
  effectiveFrom         DateTime  @db.Date // 適用開始日
  effectiveTo           DateTime? @db.Date // 適用終了日
  paymentType           String    @default("monthly") // monthly:月給, daily:日給, hourly:時給
  basicSalary           Int       @default(0)  // 基本給
  hourlyRate            Int?      // 時給
  dailyRate             Int?      // 日給
  socialInsuranceGrade  Int?      // 社会保険等級
  employmentInsuranceRate Float   @default(0.006) // 雇用保険料率
  residentTaxAmount     Int       @default(0)  // 住民税額（月額）
  dependentCount        Int       @default(0)  // 扶養親族数
  bankName              String?   // 振込先銀行名
  bankBranchName        String?   // 支店名
  bankAccountType       String?   // 口座種別（ordinary:普通, current:当座）
  bankAccountNumber     String?   // 口座番号
  bankAccountHolder     String?   // 口座名義
  notes                 String?
  isActive              Boolean   @default(true)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime

  @@unique([tenantId, userId, effectiveFrom])
  @@index([tenantId])
  @@index([tenantId, userId])
  @@index([tenantId, isActive])
}

// 従業員手当設定（個別の手当設定）
model employee_allowances {
  id              String    @id
  tenantId        String
  userId          String
  allowanceCode   String    // allowance_typesのcode参照
  amount          Int       // 支給額
  effectiveFrom   DateTime  @db.Date
  effectiveTo     DateTime? @db.Date
  notes           String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime

  @@unique([tenantId, userId, allowanceCode, effectiveFrom])
  @@index([tenantId, userId])
  @@index([tenantId, userId, isActive])
}

// 従業員控除設定（個別の控除設定）
model employee_deductions {
  id              String    @id
  tenantId        String
  userId          String
  deductionCode   String    // deduction_typesのcode参照
  amount          Int       // 控除額
  effectiveFrom   DateTime  @db.Date
  effectiveTo     DateTime? @db.Date
  notes           String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime

  @@unique([tenantId, userId, deductionCode, effectiveFrom])
  @@index([tenantId, userId])
  @@index([tenantId, userId, isActive])
}

// ========================================
// Phase 6: 給与計算・出力
// ========================================

// 給与明細
model pay_slips {
  id                    String   @id
  tenantId              String
  userId                String
  payPeriod             String   // YYYY-MM形式
  paymentDate           DateTime @db.Date // 支給日

  // 支給項目
  basicSalary           Int      @default(0)  // 基本給
  positionAllowance     Int      @default(0)  // 役職手当
  overtimeAllowance     Int      @default(0)  // 残業手当
  lateNightAllowance    Int      @default(0)  // 深夜手当
  holidayAllowance      Int      @default(0)  // 休日手当
  commuteAllowance      Int      @default(0)  // 通勤手当
  housingAllowance      Int      @default(0)  // 住宅手当
  familyAllowance       Int      @default(0)  // 家族手当
  qualificationAllowance Int     @default(0)  // 資格手当
  otherAllowances       Int      @default(0)  // その他手当
  allowancesJson        String?  // 詳細な手当情報（JSON）
  grossPay              Int      @default(0)  // 総支給額

  // 控除項目
  healthInsurance       Int      @default(0)  // 健康保険料
  pensionInsurance      Int      @default(0)  // 厚生年金
  employmentInsurance   Int      @default(0)  // 雇用保険
  incomeTax             Int      @default(0)  // 所得税
  residentTax           Int      @default(0)  // 住民税
  otherDeductions       Int      @default(0)  // その他控除
  deductionsJson        String?  // 詳細な控除情報（JSON）
  totalDeductions       Int      @default(0)  // 総控除額

  // 勤怠情報
  workingDays           Int      @default(0)  // 所定勤務日数
  actualWorkingDays     Int      @default(0)  // 実働日数
  absenceDays           Float    @default(0)  // 欠勤日数
  paidLeaveDays         Float    @default(0)  // 有給消化日数
  overtimeHours         Float    @default(0)  // 残業時間
  lateNightHours        Float    @default(0)  // 深夜労働時間
  holidayWorkHours      Float    @default(0)  // 休日労働時間

  // 差引支給額
  netPay                Int      @default(0)  // 差引支給額（手取り）

  // ステータス
  status                String   @default("draft") // draft, confirmed, paid, corrected
  confirmedAt           DateTime?
  confirmedBy           String?
  paidAt                DateTime?
  notes                 String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime

  @@unique([tenantId, userId, payPeriod])
  @@index([tenantId])
  @@index([tenantId, payPeriod])
  @@index([tenantId, userId])
  @@index([tenantId, status])
}

// 賞与明細
model bonus_slips {
  id                    String   @id
  tenantId              String
  userId                String
  bonusType             String   // summer:夏季, winter:冬季, special:特別
  payPeriod             String   // YYYY-MM形式（支給対象期間）
  paymentDate           DateTime @db.Date // 支給日

  // 支給項目
  basicBonus            Int      @default(0)  // 基本賞与
  positionBonus         Int      @default(0)  // 役職加算
  performanceBonus      Int      @default(0)  // 業績加算
  specialBonus          Int      @default(0)  // 特別加算
  grossBonus            Int      @default(0)  // 総支給額

  // 控除項目
  healthInsurance       Int      @default(0)
  pensionInsurance      Int      @default(0)
  employmentInsurance   Int      @default(0)
  incomeTax             Int      @default(0)
  totalDeductions       Int      @default(0)

  // 査定情報
  performanceRating     String?  // S, A, B, C, D
  performanceScore      Int?     // 0-100
  evaluationComment     String?

  // 差引支給額
  netBonus              Int      @default(0)

  // ステータス
  status                String   @default("draft") // draft, approved, paid
  approvedAt            DateTime?
  approvedBy            String?
  paidAt                DateTime?
  notes                 String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime

  @@unique([tenantId, userId, bonusType, payPeriod])
  @@index([tenantId])
  @@index([tenantId, payPeriod])
  @@index([tenantId, userId])
  @@index([tenantId, bonusType])
  @@index([tenantId, status])
}

model pc_assets {
  id                 String              @id
  tenantId           String
  assetNumber        String
  manufacturer       String
  model              String
  serialNumber       String
  cpu                String?
  memory             String?
  storage            String?
  os                 String?
  assignedUserId     String?
  assignedUserName   String?
  assignedDate       DateTime?           @db.Date
  ownershipType      String              @default("owned")
  purchaseDate       DateTime?           @db.Date
  purchaseCost       Int?
  leaseCompany       String?
  leaseMonthlyCost   Int?
  leaseStartDate     DateTime?           @db.Date
  leaseEndDate       DateTime?           @db.Date
  leaseContact       String?
  leasePhone         String?
  warrantyExpiration DateTime?           @db.Date
  status             String              @default("active")
  notes              String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime
  repair_records     repair_records[]
  software_licenses  software_licenses[]

  @@unique([tenantId, assetNumber])
  @@index([tenantId, assignedUserId])
  @@index([tenantId])
  @@index([tenantId, status])
}

model positions {
  id        String   @id
  tenantId  String
  name      String
  level     Int      @default(1)
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([tenantId, level])
}

model pricing_tiers {
  id           String   @id
  tenantId     String?
  name         String
  minUsers     Int
  maxUsers     Int?
  pricePerUser Int
  order        Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  tenants      tenants? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model repair_records {
  id              String          @id
  tenantId        String
  pcAssetId       String?
  generalAssetId  String?
  repairType      String
  date            DateTime        @db.Date
  cost            Int
  vendorId        String?
  vendorName      String?
  symptom         String?
  description     String?
  status          String          @default("completed")
  completedDate   DateTime?       @db.Date
  performedBy     String?
  performedByName String?
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  general_assets  general_assets? @relation(fields: [generalAssetId], references: [id], onDelete: Cascade)
  pc_assets       pc_assets?      @relation(fields: [pcAssetId], references: [id], onDelete: Cascade)

  @@index([generalAssetId])
  @@index([pcAssetId])
  @@index([tenantId, date])
  @@index([tenantId])
  @@index([tenantId, repairType])
}

model saas_license_assignments {
  id                 String             @id
  tenantId           String
  serviceId          String
  planId             String
  userId             String?
  userName           String?
  userEmail          String?
  departmentId       String?
  departmentName     String?
  status             String             @default("active")
  assignedDate       DateTime           @db.Date
  revokedDate        DateTime?          @db.Date
  lastUsedAt         DateTime?
  usageCount         Int?
  notes              String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime
  saas_license_plans saas_license_plans @relation(fields: [planId], references: [id], onDelete: Cascade)
  saas_services      saas_services      @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@index([serviceId])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, userId])
}

model saas_license_plans {
  id                       String                     @id
  tenantId                 String
  serviceId                String
  planName                 String
  billingCycle             String
  pricePerUser             Int?
  fixedPrice               Int?
  currency                 String                     @default("JPY")
  maxUsers                 Int?
  features                 String[]
  isActive                 Boolean                    @default(true)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime
  saas_license_assignments saas_license_assignments[]
  saas_services            saas_services              @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([tenantId])
}

model saas_monthly_costs {
  id               String        @id
  tenantId         String
  serviceId        String
  period           String
  userLicenseCount Int           @default(0)
  userLicenseCost  Int           @default(0)
  fixedCost        Int           @default(0)
  usageCost        Int           @default(0)
  totalCost        Int           @default(0)
  currency         String        @default("JPY")
  activeUserIds    String[]
  inactiveUserIds  String[]
  notes            String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime
  saas_services    saas_services @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([serviceId, period])
  @@index([serviceId])
  @@index([tenantId])
  @@index([tenantId, period])
}

model saas_services {
  id                       String                     @id
  tenantId                 String
  name                     String
  category                 String
  vendor                   String?
  website                  String?
  logo                     String?
  description              String?
  licenseType              String
  securityRating           String?
  ssoEnabled               Boolean                    @default(false)
  mfaEnabled               Boolean                    @default(false)
  adminEmail               String?
  supportUrl               String?
  contractStartDate        DateTime?                  @db.Date
  contractEndDate          DateTime?                  @db.Date
  autoRenew                Boolean                    @default(false)
  isActive                 Boolean                    @default(true)
  notes                    String?
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime
  saas_license_assignments saas_license_assignments[]
  saas_license_plans       saas_license_plans[]
  saas_monthly_costs       saas_monthly_costs[]

  @@unique([tenantId, name])
  @@index([tenantId, category])
  @@index([tenantId])
  @@index([tenantId, isActive])
}

model software_licenses {
  id             String    @id
  tenantId       String
  pcAssetId      String
  softwareName   String
  licenseKey     String?
  expirationDate DateTime? @db.Date
  monthlyCost    Int?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime
  pc_assets      pc_assets @relation(fields: [pcAssetId], references: [id], onDelete: Cascade)

  @@index([pcAssetId])
  @@index([tenantId])
}

model stress_check_questions {
  id             String   @id
  tenantId       String?
  questionNumber Int
  category       String
  subcategory    String
  questionText   String
  isReverse      Boolean  @default(false)
  sortOrder      Int      @default(0)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime

  @@unique([tenantId, questionNumber])
  @@index([category])
  @@index([tenantId])
}

model stress_check_summaries {
  id                      String   @id
  tenantId                String
  fiscalYear              Int
  totalEmployees          Int      @default(0)
  completedCount          Int      @default(0)
  pendingCount            Int      @default(0)
  completionRate          Float    @default(0)
  highStressCount         Int      @default(0)
  highStressRate          Float    @default(0)
  interviewRequestedCount Int      @default(0)
  interviewScheduledCount Int      @default(0)
  interviewCompletedCount Int      @default(0)
  avgStressFactorsScore   Float?
  avgStressResponseScore  Float?
  avgSocialSupportScore   Float?
  calculatedAt            DateTime @default(now())
  createdAt               DateTime @default(now())
  updatedAt               DateTime

  @@unique([tenantId, fiscalYear])
  @@index([tenantId, fiscalYear])
  @@index([tenantId])
}

model stress_checks {
  id                   String    @id
  tenantId             String
  userId               String
  userName             String
  fiscalYear           Int
  checkDate            DateTime? @db.Date
  status               String    @default("pending")
  stressFactorsScore   Int?
  stressResponseScore  Int?
  socialSupportScore   Int?
  totalScore           Int?
  isHighStress         Boolean   @default(false)
  highStressReason     String?
  interviewRequested   Boolean   @default(false)
  interviewRequestedAt DateTime?
  interviewScheduled   Boolean   @default(false)
  interviewScheduledAt DateTime?
  interviewCompleted   Boolean   @default(false)
  interviewCompletedAt DateTime?
  interviewNotes       String?
  doctorName           String?
  doctorOpinion        String?
  responses            Json?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime

  @@unique([tenantId, userId, fiscalYear])
  @@index([tenantId, fiscalYear])
  @@index([tenantId])
  @@index([tenantId, isHighStress])
  @@index([userId])
}

model tenant_legal_statuses {
  id            String        @id
  tenantId      String
  legalUpdateId String
  status        String        @default("pending")
  notes         String?
  completedAt   DateTime?
  completedBy   String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  legal_updates legal_updates @relation(fields: [legalUpdateId], references: [id], onDelete: Cascade)

  @@unique([tenantId, legalUpdateId])
  @@index([legalUpdateId])
  @@index([tenantId])
  @@index([tenantId, status])
}

model tenant_settings {
  id                String    @id
  tenantId          String    @unique
  trialEndDate      DateTime? @db.Date
  contractStartDate DateTime? @db.Date
  contractEndDate   DateTime? @db.Date
  billingEmail      String?
  customPricing     Boolean   @default(false)
  status            String    @default("trial")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime
  tenants           tenants   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model tenants {
  id              String           @id
  name            String
  logo            String?
  timezone        String           @default("Asia/Tokyo")
  closingDay      String           @default("末")
  weekStartDay    Int              @default(1)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime
  subdomain       String?          @unique
  attendance      attendance[]
  invoices        invoices[]
  org_units       org_units[]
  pricing_tiers   pricing_tiers[]
  tenant_settings tenant_settings?
  user_histories  user_histories[]
  users           users[]

  @@index([subdomain])
}

model timeline_entries {
  id                String            @id
  tenantId          String
  workflowId        String
  action            String
  actorId           String?
  actorName         String?
  details           String?
  createdAt         DateTime          @default(now())
  workflow_requests workflow_requests @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([tenantId, createdAt])
  @@index([tenantId])
  @@index([workflowId])
}

model user_account_settings {
  id                        String    @id
  tenantId                  String
  userId                    String    @unique
  displayName               String?
  avatar                    String?
  bio                       String?
  theme                     String    @default("system")
  language                  String    @default("ja")
  timezone                  String    @default("Asia/Tokyo")
  dateFormat                String    @default("YYYY/MM/DD")
  timeFormat                String    @default("24h")
  emailNotifications        Boolean   @default(true)
  pushNotifications         Boolean   @default(true)
  workflowNotifications     Boolean   @default(true)
  leaveNotifications        Boolean   @default(true)
  systemNotifications       Boolean   @default(true)
  announcementNotifications Boolean   @default(true)
  // クイックアクション表示設定（JSON: {attendance: true, leave: true, members: true, workflow: true, users: true, settings: true}）
  quickActionSettings       String?
  twoFactorEnabled          Boolean   @default(false)
  twoFactorSecret           String?
  passwordChangedAt         DateTime?
  lastLoginAt               DateTime?
  lastLoginIp               String?
  lastLoginDevice           String?
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime

  @@index([tenantId])
  @@index([userId])
}

model user_histories {
  id          String   @id
  tenantId    String
  userId      String
  action      String
  date        DateTime @db.Date
  userCount   Int
  dailyCharge Int
  memo        String?
  createdAt   DateTime @default(now())
  tenants     tenants  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([tenantId, date])
  @@index([tenantId])
  @@index([userId])
}

model users {
  id               String       @id
  tenantId         String
  email            String       @unique
  name             String
  phone            String?
  hireDate         DateTime?
  unitId           String?
  roles            String[]
  status           String       @default("active")
  retiredDate      DateTime?
  retirementReason String?
  timezone         String       @default("Asia/Tokyo")
  avatar           String?
  position         String?
  department       String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime
  passwordHash          String?
  role                  String?      @default("employee")
  passwordResetRequired Boolean      @default(false)
  invitedAt             DateTime?
  inviteToken           String?
  inviteTokenExpiry     DateTime?
  attendance            attendance[]
  tenants          tenants      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  org_units        org_units?   @relation(fields: [unitId], references: [id])

  @@index([email])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([unitId])
}

model vehicles {
  id                  String                @id
  tenantId            String
  vehicleNumber       String
  licensePlate        String
  make                String
  model               String
  year                Int
  color               String?
  assignedUserId      String?
  assignedUserName    String?
  assignedDate        DateTime?             @db.Date
  ownershipType       String                @default("owned")
  purchaseDate        DateTime?             @db.Date
  purchaseCost        Int?
  leaseCompany        String?
  leaseMonthlyCost    Int?
  leaseStartDate      DateTime?             @db.Date
  leaseEndDate        DateTime?             @db.Date
  leaseContact        String?
  leasePhone          String?
  inspectionDate      DateTime?             @db.Date
  maintenanceDate     DateTime?             @db.Date
  insuranceDate       DateTime?             @db.Date
  currentTireType     String                @default("summer")
  status              String                @default("active")
  mileageTracking     Boolean               @default(true)
  currentMileage      Int?
  notes               String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  tireChangeDate      DateTime?             @db.Date
  maintenance_records maintenance_records[]
  monthly_mileages    monthly_mileages[]

  @@unique([tenantId, vehicleNumber])
  @@index([tenantId, assignedUserId])
  @@index([tenantId])
  @@index([tenantId, status])
}

model vendors {
  id                  String                @id
  tenantId            String
  name                String
  phone               String?
  address             String?
  contactPerson       String?
  email               String?
  rating              Int?
  notes               String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  maintenance_records maintenance_records[]

  @@index([tenantId])
  @@index([tenantId, name])
}

model work_experiences {
  id                String            @id
  tenantId          String
  profileId         String
  userId            String
  position          String
  company           String
  startDate         DateTime          @db.Date
  endDate           DateTime?         @db.Date
  isCurrent         Boolean           @default(false)
  description       String?
  achievements      String[]
  skills            String[]
  sortOrder         Int               @default(0)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime
  employee_profiles employee_profiles @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([tenantId])
  @@index([tenantId, isCurrent])
  @@index([userId])
}

model workflow_requests {
  id               String             @id
  tenantId         String
  requesterId      String
  requesterName    String
  department       String?
  type             String
  title            String
  description      String?
  amount           Float?
  days             Int?
  hours            Float?
  details          Json?
  status           String             @default("pending")
  currentStep      Int                @default(0)
  priority         String             @default("medium")
  dueDate          DateTime?
  completedAt      DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  approval_steps   approval_steps[]
  timeline_entries timeline_entries[]

  @@index([createdAt])
  @@index([requesterId])
  @@index([status])
  @@index([tenantId])
  @@index([tenantId, requesterId])
  @@index([tenantId, status])
  @@index([type])
}

model workflow_settings {
  id                          String   @id
  tenantId                    String   @unique
  defaultApprovalDeadlineDays Int      @default(3)
  enableAutoEscalation        Boolean  @default(false)
  escalationReminderDays      Int      @default(1)
  enableAutoApproval          Boolean  @default(false)
  autoApprovalThreshold       Int      @default(10000)
  requireCommentOnReject      Boolean  @default(true)
  allowParallelApproval       Boolean  @default(false)
  enableProxyApproval         Boolean  @default(false)
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime

  @@index([tenantId])
}

model year_end_adjustment_settings {
  id                             String   @id
  tenantId                       String   @unique
  adjustmentStartMonth           Int      @default(11)
  adjustmentEndMonth             Int      @default(12)
  enableBasicDeduction           Boolean  @default(true)
  enableSpouseDeduction          Boolean  @default(true)
  enableDependentDeduction       Boolean  @default(true)
  enableInsuranceDeduction       Boolean  @default(true)
  enableSocialInsuranceDeduction Boolean  @default(true)
  withholdingSlipFormat          String   @default("standard")
  includeQRCode                  Boolean  @default(false)
  createdAt                      DateTime @default(now())
  updatedAt                      DateTime

  @@index([tenantId])
}

// ============================================
// Phase 7: 年末調整
// ============================================

// 年末調整申告書（扶養控除等申告書）
model year_end_declarations {
  id                    String   @id
  tenantId              String
  userId                String
  fiscalYear            Int      // 対象年度（例: 2024）

  // 本人情報
  maritalStatus         String?  // 婚姻状況: single, married, divorced, widowed
  isDisabled            Boolean  @default(false)
  disabilityType        String?  // 障害区分: general, special, special_living
  isWorkingStudent      Boolean  @default(false)
  isSingleParent        Boolean  @default(false)
  isWidow               Boolean  @default(false)

  // 配偶者情報
  hasSpouse             Boolean  @default(false)
  spouseName            String?
  spouseBirthDate       DateTime? @db.Date
  spouseIncome          Int?     // 配偶者の年間所得見込み
  spouseIsDisabled      Boolean  @default(false)
  spouseDisabilityType  String?
  spouseLivingTogether  Boolean  @default(true)

  // 扶養親族情報（JSONで保存）
  dependentsJson        String?  @db.Text // 扶養親族の詳細情報
  dependentCount        Int      @default(0)
  specificDependentCount Int     @default(0) // 特定扶養親族（19-22歳）
  elderlyDependentCount Int      @default(0) // 老人扶養親族（70歳以上）

  // 保険料控除申告
  lifeInsuranceNew      Int      @default(0) // 一般生命保険料（新契約）
  lifeInsuranceOld      Int      @default(0) // 一般生命保険料（旧契約）
  medicalInsurance      Int      @default(0) // 介護医療保険料
  pensionInsuranceNew   Int      @default(0) // 個人年金保険料（新契約）
  pensionInsuranceOld   Int      @default(0) // 個人年金保険料（旧契約）
  earthquakeInsurance   Int      @default(0) // 地震保険料
  longTermDamageIns     Int      @default(0) // 旧長期損害保険料

  // 社会保険料控除（本人負担分以外）
  nationalPension       Int      @default(0) // 国民年金
  nationalHealthIns     Int      @default(0) // 国民健康保険
  otherSocialIns        Int      @default(0) // その他社会保険

  // 小規模企業共済等
  idecoAmount           Int      @default(0) // iDeCo
  smallBusinessMutualAid Int     @default(0) // 小規模企業共済

  // 住宅借入金等特別控除
  hasMortgage           Boolean  @default(false)
  mortgageBalance       Int?     // 住宅ローン年末残高
  mortgageType          String?  // 住宅ローン区分
  mortgageStartYear     Int?     // 居住開始年

  // 添付書類
  documentsJson         String?  @db.Text // 添付書類情報

  status                String   @default("draft") // draft, submitted, approved, rejected
  submittedAt           DateTime?
  approvedAt            DateTime?
  approvedBy            String?
  rejectionReason       String?
  notes                 String?  @db.Text
  createdAt             DateTime @default(now())
  updatedAt             DateTime

  @@unique([tenantId, userId, fiscalYear])
  @@index([tenantId])
  @@index([tenantId, fiscalYear])
  @@index([tenantId, userId])
  @@index([tenantId, status])
}

// 年末調整計算結果
model year_end_results {
  id                    String   @id
  tenantId              String
  userId                String
  fiscalYear            Int

  // 給与収入
  totalSalary           Int      @default(0) // 給与収入合計
  totalBonus            Int      @default(0) // 賞与収入合計
  totalIncome           Int      @default(0) // 年間収入合計

  // 給与所得控除後の金額
  employmentIncomeDeduction Int @default(0) // 給与所得控除額
  employmentIncome      Int      @default(0) // 給与所得金額

  // 所得控除
  basicDeduction        Int      @default(0) // 基礎控除
  spouseDeduction       Int      @default(0) // 配偶者控除
  spouseSpecialDeduction Int     @default(0) // 配偶者特別控除
  dependentDeduction    Int      @default(0) // 扶養控除
  disabilityDeduction   Int      @default(0) // 障害者控除
  widowDeduction        Int      @default(0) // 寡婦控除
  singleParentDeduction Int      @default(0) // ひとり親控除
  workingStudentDeduction Int    @default(0) // 勤労学生控除

  socialInsuranceDeduction Int   @default(0) // 社会保険料控除
  lifeInsuranceDeduction Int     @default(0) // 生命保険料控除
  earthquakeInsuranceDeduction Int @default(0) // 地震保険料控除
  smallBusinessDeduction Int     @default(0) // 小規模企業共済等掛金控除

  totalDeductions       Int      @default(0) // 所得控除合計

  // 税額計算
  taxableIncome         Int      @default(0) // 課税所得金額
  calculatedTax         Int      @default(0) // 算出所得税額
  specialReconstructionTax Int   @default(0) // 復興特別所得税
  totalTax              Int      @default(0) // 年調年税額

  // 住宅借入金等特別控除
  mortgageDeduction     Int      @default(0)
  finalTax              Int      @default(0) // 差引税額

  // 源泉徴収との差額
  withheldTaxTotal      Int      @default(0) // 年間源泉徴収税額
  adjustmentAmount      Int      @default(0) // 年末調整額（正=還付、負=徴収）
  isRefund              Boolean  @default(true)

  // 計算明細（JSON）
  calculationDetailsJson String? @db.Text

  status                String   @default("draft") // draft, calculated, confirmed, paid
  calculatedAt          DateTime?
  confirmedAt           DateTime?
  confirmedBy           String?
  paidAt                DateTime?
  notes                 String?  @db.Text
  createdAt             DateTime @default(now())
  updatedAt             DateTime

  @@unique([tenantId, userId, fiscalYear])
  @@index([tenantId])
  @@index([tenantId, fiscalYear])
  @@index([tenantId, status])
}

// 源泉徴収票
model withholding_slips {
  id                    String   @id
  tenantId              String
  userId                String
  fiscalYear            Int

  // 従業員情報
  employeeName          String
  employeeAddress       String?
  employeeMyNumber      String?  // マイナンバー（暗号化推奨）

  // 支払者情報
  payerName             String
  payerAddress          String?
  payerCorporateNumber  String?  // 法人番号

  // 支払金額等
  paymentAmount         Int      @default(0) // 支払金額
  employmentIncome      Int      @default(0) // 給与所得控除後の金額
  deductionTotal        Int      @default(0) // 所得控除の額の合計額
  withheldTax           Int      @default(0) // 源泉徴収税額

  // 控除対象配偶者
  hasSpouse             Boolean  @default(false)
  spouseName            String?
  spouseIncome          Int?

  // 扶養親族
  dependentCount        Int      @default(0) // 扶養親族の数（配偶者除く）
  under16DependentCount Int      @default(0) // 16歳未満扶養親族の数

  // 社会保険料等
  socialInsuranceAmount Int      @default(0)

  // 生命保険料控除
  lifeInsuranceDeduction Int     @default(0)

  // 地震保険料控除
  earthquakeInsuranceDeduction Int @default(0)

  // 住宅借入金等特別控除
  mortgageDeduction     Int      @default(0)
  mortgageBalance       Int?     // 住宅借入金等の年末残高

  // 備考欄（JSON）
  remarksJson           String?  @db.Text

  // 発行情報
  issueDate             DateTime @db.Date
  issueNumber           String?  // 発行番号
  isReissue             Boolean  @default(false)
  reissueCount          Int      @default(0)

  status                String   @default("draft") // draft, issued, delivered
  deliveredAt           DateTime?
  deliveryMethod        String?  // email, paper, download

  createdAt             DateTime @default(now())
  updatedAt             DateTime

  @@unique([tenantId, userId, fiscalYear, isReissue, reissueCount])
  @@index([tenantId])
  @@index([tenantId, fiscalYear])
  @@index([tenantId, userId])
}

// 給与支払報告書（市区町村提出用）
model salary_payment_reports {
  id                    String   @id
  tenantId              String
  userId                String
  fiscalYear            Int

  // 提出先市区町村
  municipalityCode      String   // 市区町村コード
  municipalityName      String   // 市区町村名

  // 従業員情報
  employeeName          String
  employeeAddress       String
  employeeBirthDate     DateTime? @db.Date

  // 1月1日現在の住所地
  jan1Address           String?

  // 支払金額等（源泉徴収票と同一）
  paymentAmount         Int      @default(0)
  withheldTax           Int      @default(0)
  socialInsuranceAmount Int      @default(0)

  // 提出区分
  submissionType        String   @default("normal") // normal, correction, cancel
  isSpecialCollection   Boolean  @default(true) // 特別徴収対象

  // 提出情報
  status                String   @default("draft") // draft, submitted, accepted
  submittedAt           DateTime?
  submissionMethod      String?  // eltax, paper
  receiptNumber         String?  // 受付番号

  notes                 String?  @db.Text
  createdAt             DateTime @default(now())
  updatedAt             DateTime

  @@unique([tenantId, userId, fiscalYear, submissionType])
  @@index([tenantId])
  @@index([tenantId, fiscalYear])
  @@index([tenantId, municipalityCode])
  @@index([tenantId, status])
}

// ============================================
// Phase 4: 勤怠マスタ
// ============================================

// 勤務パターン（日勤、夜勤、フレックス等）
model work_patterns {
  id                   String   @id
  tenantId             String
  name                 String
  code                 String
  description          String?
  workStartTime        String   // 始業時間 "09:00"
  workEndTime          String   // 終業時間 "18:00"
  breakStartTime       String?  // 休憩開始 "12:00"
  breakEndTime         String?  // 休憩終了 "13:00"
  breakDurationMinutes Int      @default(60)
  workingMinutes       Int      @default(480) // 所定労働時間（分）
  isFlexTime           Boolean  @default(false)
  coreTimeStart        String?  // フレックスのコアタイム開始
  coreTimeEnd          String?  // フレックスのコアタイム終了
  isNightShift         Boolean  @default(false) // 夜勤フラグ
  isDefault            Boolean  @default(false)
  isActive             Boolean  @default(true)
  sortOrder            Int      @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, isActive])
}

// 残業ルール
model overtime_rules {
  id                         String   @id
  tenantId                   String   @unique
  calculationMethod          String   @default("daily") // daily, weekly, monthly
  dailyOvertimeThreshold     Int      @default(480) // 日次残業開始時間（分）
  weeklyOvertimeThreshold    Int      @default(2400) // 週次残業開始時間（分）
  monthlyOvertimeThreshold   Int      @default(10080) // 月次残業開始時間（分）
  lateNightStartHour         Int      @default(22) // 深夜開始時刻
  lateNightEndHour           Int      @default(5) // 深夜終了時刻
  normalOvertimeRate         Float    @default(1.25) // 通常残業割増率
  lateNightOvertimeRate      Float    @default(1.5) // 深夜残業割増率
  holidayOvertimeRate        Float    @default(1.35) // 休日出勤割増率
  holidayLateNightRate       Float    @default(1.6) // 休日深夜割増率
  enableMinutesRounding      Boolean  @default(true)
  roundingUnit               Int      @default(15) // 丸め単位（分）
  roundingMethod             String   @default("floor") // floor, ceil, round
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime

  @@index([tenantId])
}

// 36協定設定
model article36_agreements {
  id                          String    @id
  tenantId                    String
  fiscalYear                  Int
  effectiveStartDate          DateTime  @db.Date
  effectiveEndDate            DateTime  @db.Date
  monthlyOvertimeLimit        Int       @default(45) // 月間残業上限（時間）
  yearlyOvertimeLimit         Int       @default(360) // 年間残業上限（時間）
  specialClauseEnabled        Boolean   @default(false) // 特別条項
  specialMonthlyLimit         Int?      // 特別条項時の月間上限
  specialYearlyLimit          Int?      // 特別条項時の年間上限
  specialMonthsPerYear        Int?      // 特別条項の適用回数（年間）
  holidayWorkLimit            Int?      // 休日出勤上限（日/月）
  lateNightWorkRestriction    Boolean   @default(false)
  healthCheckupRequired       Boolean   @default(true) // 80時間超えで健康診断
  doctorInterviewRequired     Boolean   @default(true) // 100時間超えで医師面談
  workerRepresentativeName    String?   // 労働者代表氏名
  workerRepresentativeDate    DateTime? @db.Date
  employerRepresentativeName  String?   // 使用者代表氏名
  employerRepresentativeDate  DateTime? @db.Date
  submittedToLabor            Boolean   @default(false)
  laborSubmissionDate         DateTime? @db.Date
  isActive                    Boolean   @default(true)
  notes                       String?
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime

  @@unique([tenantId, fiscalYear])
  @@index([tenantId])
  @@index([tenantId, fiscalYear])
}

// 休暇種別マスタ
model leave_types {
  id                   String   @id
  tenantId             String
  name                 String
  code                 String
  description          String?
  category             String   // paid, special, sick, compensatory, other
  isPaid               Boolean  @default(true)
  defaultDays          Int      @default(0) // 年間付与日数
  maxCarryoverDays     Int      @default(0) // 繰越上限
  carryoverMonths      Int      @default(0) // 繰越有効月数
  minRequestDays       Float    @default(0.5) // 最小申請単位
  requiresApproval     Boolean  @default(true)
  requiresDocument     Boolean  @default(false) // 証明書類必須
  documentTypes        String[] // 必要書類種別
  allowHalfDay         Boolean  @default(true) // 半日休暇
  allowHourly          Boolean  @default(false) // 時間単位休暇
  isLegalLeave         Boolean  @default(false) // 法定休暇
  isActive             Boolean  @default(true)
  sortOrder            Int      @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([tenantId, category])
}

// 休日カレンダー（会社休日、祝日）
model company_holidays {
  id           String   @id
  tenantId     String
  date         DateTime @db.Date
  name         String
  type         String   // national_holiday, company_holiday, substitute, other
  isHalfDay    Boolean  @default(false)
  description  String?
  fiscalYear   Int
  isRecurring  Boolean  @default(false) // 毎年繰り返し
  createdAt    DateTime @default(now())
  updatedAt    DateTime

  @@unique([tenantId, date])
  @@index([tenantId])
  @@index([tenantId, fiscalYear])
  @@index([tenantId, date])
  @@index([tenantId, type])
}

// 有給休暇付与ルール
model paid_leave_rules {
  id                    String   @id
  tenantId              String   @unique
  grantMonth            Int      @default(4) // 付与月（1-12）
  grantDay              Int      @default(1) // 付与日
  grantTiming           String   @default("hire_anniversary") // hire_anniversary, fixed_date, hire_month_end
  initialGrantDays      Int      @default(10) // 初年度付与日数
  maxGrantDays          Int      @default(20) // 最大付与日数
  carryoverEnabled      Boolean  @default(true)
  maxCarryoverDays      Int      @default(20) // 繰越上限
  carryoverExpiryMonths Int      @default(24) // 繰越有効期間（月）
  proportionalGrant     Boolean  @default(true) // 比例付与
  hourlyLeaveEnabled    Boolean  @default(false) // 時間単位有給
  hourlyLeaveMaxDays    Int      @default(5) // 時間単位有給の年間上限日数
  plannedLeaveEnabled   Boolean  @default(false) // 計画年休
  plannedLeaveDays      Int      @default(5) // 計画年休日数
  createdAt             DateTime @default(now())
  updatedAt             DateTime

  @@index([tenantId])
}

// 有給付与実績（勤続年数による付与テーブル）
model paid_leave_grant_table {
  id             String   @id
  tenantId       String
  yearsOfService Float    // 勤続年数（0.5 = 6ヶ月）
  grantDays      Int      // 付与日数
  createdAt      DateTime @default(now())
  updatedAt      DateTime

  @@unique([tenantId, yearsOfService])
  @@index([tenantId])
}

// ============================================
// 権限管理システム（RBAC v2）
// ============================================

// ロール定義
model roles {
  id               String                    @id
  tenantId         String
  code             String                    // employee, manager, executive, hr, admin, applicant, or custom
  name             String                    // 表示名
  description      String?
  isSystem         Boolean                   @default(false) // システム定義（削除不可）
  isActive         Boolean                   @default(true)
  sortOrder        Int                       @default(0)
  color            String?                   // バッジ表示色
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime
  role_permissions role_permissions[]
  user_permission_overrides user_permission_overrides[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, isActive])
}

// 権限マスタ
model permissions {
  id          String                    @id
  resource    String                    // dashboard, attendance, payroll, etc.
  action      String                    // create, read, update, delete, approve, manage
  scope       String                    // self, team, department, company
  code        String                    @unique // {resource}:{action}:{scope}
  name        String                    // 表示名
  description String?
  category    String                    // menu, feature
  menuKey     String?                   // メニュー表示権限の場合のメニューキー
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime
  role_permissions role_permissions[]
  user_permission_overrides user_permission_overrides[]

  @@index([resource])
  @@index([category])
  @@index([code])
}

// ロール×権限マッピング
model role_permissions {
  id           String      @id
  roleId       String
  permissionId String
  createdAt    DateTime    @default(now())
  roles        roles       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissions  permissions @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

// ユーザー個別オーバーライド
model user_permission_overrides {
  id           String      @id
  tenantId     String
  userId       String
  permissionId String
  roleId       String?     // 特定ロールに紐づくオーバーライド（任意）
  overrideType String      // grant, revoke
  reason       String?
  grantedBy    String      // オーバーライドを設定したユーザーID
  expiresAt    DateTime?   // 有効期限
  createdAt    DateTime    @default(now())
  updatedAt    DateTime
  permissions  permissions @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  roles        roles?      @relation(fields: [roleId], references: [id])

  @@unique([tenantId, userId, permissionId])
  @@index([tenantId])
  @@index([tenantId, userId])
  @@index([permissionId])
}

// ============================================================================
// 予約管理（入社・異動・退職）
// ============================================================================

// ============================================================================
// 健康管理: 健診マスタ
// ============================================================================

// 健診種別マスタ
model health_checkup_types {
  id          String   @id
  tenantId    String
  name        String   // "定期健康診断", "雇入時健診"
  code        String   // "regular", "pre_employment"
  description String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, isActive])
}

// 医療機関マスタ
model health_medical_institutions {
  id        String   @id
  tenantId  String
  name      String
  code      String?
  address   String?
  phone     String?
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, isActive])
}

// 健診予定
model health_checkup_schedules {
  id                   String   @id
  tenantId             String
  userId               String
  userName             String
  departmentName       String?
  checkupTypeName      String
  medicalInstitutionId String?
  scheduledDate        DateTime @db.Date
  scheduledTime        String?
  status               String   @default("scheduled") // scheduled, completed, cancelled
  fiscalYear           Int
  notes                String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime

  @@index([tenantId, scheduledDate])
  @@index([tenantId, userId])
  @@index([tenantId, status])
  @@index([tenantId, fiscalYear])
}

// ============================================================================
// 予約管理（入社・異動・退職）
// ============================================================================

// 予約変更
model scheduled_changes {
  id               String    @id
  tenantId         String
  type             String    // hire, transfer, retirement
  userId           String?   // 入社の場合はnull、異動・退職の場合は対象ユーザーID
  userName         String?   // 表示用のユーザー名
  effectiveDate    DateTime  @db.Date // 適用予定日
  status           String    @default("pending") // pending, applied, cancelled
  createdBy        String    // HR担当者のID
  createdByName    String    // HR担当者の名前

  // 入社予約の詳細（typeがhireの場合）
  hireName         String?   // 新規入社者の氏名
  hireEmail        String?   // 新規入社者のメールアドレス
  hireDepartment   String?   // 配属部門
  hirePosition     String?   // 役職
  hireRole         String?   // 権限ロール（employee, manager, hr, admin）
  hireEmployeeNumber String? // 社員番号

  // 異動予約の詳細（typeがtransferの場合）
  currentDepartment String?  // 現在の部門
  newDepartment    String?   // 異動先部門
  currentPosition  String?   // 現在の役職
  newPosition      String?   // 新役職
  transferReason   String?   // 異動理由

  // 退職予約の詳細（typeがretirementの場合）
  retirementReason String?   // voluntary, company, contract_end, retirement_age, other
  retirementNotes  String?   // 退職に関する備考

  // 承認フロー関連
  requiresApproval Boolean   @default(false) // 承認が必要かどうか
  approvalStatus   String?   // not_required, pending_approval, approved, rejected
  workflowId       String?   // ワークフローID（承認フローが開始された場合）
  approvedBy       String?   // 承認者のID
  approvedByName   String?   // 承認者の名前
  approvedAt       DateTime? // 承認日時
  rejectionReason  String?   // 却下理由

  createdAt        DateTime  @default(now())
  updatedAt        DateTime

  @@index([tenantId])
  @@index([tenantId, type])
  @@index([tenantId, status])
  @@index([tenantId, effectiveDate])
  @@index([tenantId, userId])
  @@index([tenantId, approvalStatus])
}

// ============================================
// 監査ログ
// ============================================

model audit_logs {
  id          String   @id
  tenantId    String
  userId      String?
  userName    String?
  userRole    String?
  action      String   // login, logout, create, update, delete, approve, reject, return, export, import, access
  category    String   // auth, user, attendance, leave, workflow, payroll, organization, settings, saas, assets
  targetType  String?  // 対象エンティティの種類
  targetId    String?  // 対象エンティティのID
  targetName  String?  // 対象エンティティの名前
  description String
  oldValue    Json?    // 変更前の値
  newValue    Json?    // 変更後の値
  ipAddress   String?
  userAgent   String?
  metadata    Json?
  severity    String   @default("info") // info, warning, error, critical
  createdAt   DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, userId])
  @@index([tenantId, category])
  @@index([tenantId, action])
  @@index([tenantId, createdAt])
  @@index([createdAt])
}
