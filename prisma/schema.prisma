// Dandori Portal Database Schema
// HRé ˜åŸŸç‰¹åŒ–ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒï¼ˆãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå®Œå…¨å¯¾å¿œï¼‰
//
// ğŸ¢ ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆè¨­è¨ˆ:
// - ã™ã¹ã¦ã®ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã« tenant_id ã‚’å«ã‚€
// - RDS PostgreSQL ã§ Row Level Security (RLS) å¯¾å¿œ
// - è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
// - 20ç¤¾Ã—30åè¦æ¨¡ï¼ˆ600ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã«æœ€é©åŒ–

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ãƒ†ãƒŠãƒ³ãƒˆï¼ˆä¼šç¤¾ï¼‰
model Tenant {
  id           String   @id @default(cuid())
  name         String
  subdomain    String?  @unique // ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆä¾‹: dandori-work, sample-corpï¼‰
  logo         String?
  timezone     String   @default("Asia/Tokyo")
  closingDay   String   @default("æœ«") // æœ«, 20, 15, ä»»æ„
  weekStartDay Int      @default(1) // 0=æ—¥æ›œ, 1=æœˆæ›œ
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  users         User[]
  orgUnits      OrgUnit[]
  attendance    Attendance[]
  pricingTiers  PricingTier[]
  invoices      Invoice[]
  settings      TenantSettings?
  userHistories UserHistory[]

  @@index([subdomain])
  @@map("tenants")
}

// çµ„ç¹”å˜ä½ï¼ˆä¼šç¤¾ã€éƒ¨é–€ã€éƒ¨ã€ãƒãƒ¼ãƒ ï¼‰
model OrgUnit {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  parentId    String?
  level       Int      @default(0)
  headUserId  String?
  type        String // company, division, department, team
  memberCount Int      @default(0)
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent   OrgUnit?  @relation("OrgUnitHierarchy", fields: [parentId], references: [id])
  children OrgUnit[] @relation("OrgUnitHierarchy")
  users    User[]

  @@index([tenantId])
  @@index([parentId])
  @@index([tenantId, parentId]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆçµ„ç¹”éšå±¤æ¤œç´¢ç”¨ï¼‰
  @@index([tenantId, isActive]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæœ‰åŠ¹çµ„ç¹”æ¤œç´¢ç”¨ï¼‰
  @@map("org_units")
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼
model User {
  id               String    @id @default(cuid())
  tenantId         String
  email            String    @unique
  name             String
  phone            String?
  hireDate         DateTime
  unitId           String
  roles            String[] // JSONé…åˆ—: ["employee", "admin"]
  status           String    @default("active") // active, inactive, suspended, retired
  retiredDate      DateTime?
  retirementReason String? // voluntary, company, contract_end, retirement_age, other
  timezone         String    @default("Asia/Tokyo")
  avatar           String?
  position         String?
  department       String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  tenant     Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orgUnit    OrgUnit      @relation(fields: [unitId], references: [id])
  attendance Attendance[]

  @@index([tenantId])
  @@index([unitId])
  @@index([email])
  @@index([tenantId, status]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ç”¨ï¼‰
  @@map("users")
}

// å‹¤æ€ è¨˜éŒ²
model Attendance {
  id                String    @id @default(cuid())
  tenantId          String
  userId            String
  date              DateTime  @db.Date // YYYY-MM-DDå½¢å¼
  checkIn           DateTime? // å‡ºå‹¤æ™‚åˆ»
  checkOut          DateTime? // é€€å‹¤æ™‚åˆ»
  breakStart        DateTime? // ä¼‘æ†©é–‹å§‹æ™‚åˆ»
  breakEnd          DateTime? // ä¼‘æ†©çµ‚äº†æ™‚åˆ»
  totalBreakMinutes Int       @default(0)
  workMinutes       Int       @default(0)
  overtimeMinutes   Int       @default(0)
  workLocation      String    @default("office") // office, home, client, other
  checkInLocation   Json? // GPSä½ç½®æƒ…å ± {latitude, longitude, address, timestamp}
  checkOutLocation  Json? // GPSä½ç½®æƒ…å ± {latitude, longitude, address, timestamp}
  status            String    @default("present") // present, absent, holiday, leave, late, early
  memo              String?
  approvalStatus    String? // pending, approved, rejected
  approvalReason    String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date]) // 1ãƒ¦ãƒ¼ã‚¶ãƒ¼1æ—¥1ãƒ¬ã‚³ãƒ¼ãƒ‰
  @@index([tenantId])
  @@index([userId])
  @@index([tenantId, userId]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆæœ€é©åŒ–ï¼‰
  @@index([tenantId, date]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæ—¥ä»˜ç¯„å›²æ¤œç´¢ç”¨ï¼‰
  @@index([date])
  @@index([status])
  @@map("attendance")
}

// ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”³è«‹
model WorkflowRequest {
  id            String    @id @default(cuid())
  tenantId      String
  requesterId   String // ç”³è«‹è€…ID
  requesterName String // ç”³è«‹è€…å
  department    String? // éƒ¨ç½²
  type          String // leave, overtime, expense, business_trip, purchase, attendance_correction
  title         String // ç”³è«‹ã‚¿ã‚¤ãƒˆãƒ«
  description   String? // ç”³è«‹å†…å®¹
  amount        Float? // é‡‘é¡ï¼ˆçµŒè²»ãƒ»è³¼è²·ç”³è«‹ç”¨ï¼‰
  days          Int? // æ—¥æ•°ï¼ˆä¼‘æš‡ç”³è«‹ç”¨ï¼‰
  hours         Float? // æ™‚é–“æ•°ï¼ˆæ®‹æ¥­ç”³è«‹ç”¨ï¼‰
  details       Json? // ãã®ä»–è©³ç´°æƒ…å ±
  status        String    @default("pending") // pending, in_progress, approved, rejected, withdrawn
  currentStep   Int       @default(0)
  priority      String    @default("medium") // low, medium, high, urgent
  dueDate       DateTime?
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  approvalSteps   ApprovalStep[]
  timelineEntries TimelineEntry[]

  @@index([tenantId])
  @@index([requesterId])
  @@index([tenantId, requesterId]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ç”³è«‹ä¸€è¦§ç”¨ï¼‰
  @@index([tenantId, status]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥æ¤œç´¢ç”¨ï¼‰
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("workflow_requests")
}

// æ‰¿èªã‚¹ãƒ†ãƒƒãƒ—
model ApprovalStep {
  id            String    @id @default(cuid())
  tenantId      String // éæ­£è¦åŒ–ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
  workflowId    String
  order         Int // ã‚¹ãƒ†ãƒƒãƒ—ã®é †åºï¼ˆ0å§‹ã¾ã‚Šï¼‰
  approverRole  String // direct_manager, hr_manager, finance_manager, etc.
  approverId    String? // æ‰¿èªè€…ID
  approverName  String? // æ‰¿èªè€…å
  status        String    @default("pending") // pending, approved, rejected, skipped
  actionDate    DateTime? // æ‰¿èª/å´ä¸‹æ—¥æ™‚
  comments      String? // ã‚³ãƒ¡ãƒ³ãƒˆ
  executionMode String    @default("sequential") // sequential, parallel
  timeoutHours  Int? // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“
  isEscalated   Boolean   @default(false)
  escalatedTo   String? // ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å…ˆ
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  workflow WorkflowRequest @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([workflowId])
  @@index([tenantId, approverId]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæ‰¿èªè€…åˆ¥ã‚¿ã‚¹ã‚¯ä¸€è¦§ç”¨ï¼‰
  @@index([tenantId, status]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥æ¤œç´¢ç”¨ï¼‰
  @@index([approverId])
  @@index([status])
  @@map("approval_steps")
}

// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆå±¥æ­´ï¼‰
model TimelineEntry {
  id         String   @id @default(cuid())
  tenantId   String // éæ­£è¦åŒ–ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
  workflowId String
  action     String // created, submitted, approved, rejected, returned, escalated, etc.
  actorId    String? // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œè€…ID
  actorName  String? // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œè€…å
  details    String? // è©³ç´°æƒ…å ±
  createdAt  DateTime @default(now())

  // Relations
  workflow WorkflowRequest @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([workflowId])
  @@index([tenantId, createdAt]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼‰
  @@index([createdAt])
  @@map("timeline_entries")
}

// ä¼‘æš‡ç”³è«‹
model LeaveRequest {
  id             String    @id @default(cuid())
  tenantId       String
  userId         String
  userName       String
  type           String // paid, sick, special, compensatory, half_day_am, half_day_pm
  startDate      DateTime  @db.Date
  endDate        DateTime  @db.Date
  days           Float // æ—¥æ•°ï¼ˆ0.5ã®åŠä¼‘ã‚‚å¯¾å¿œï¼‰
  reason         String
  attachments    Json? // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ï¼ˆè¨ºæ–­æ›¸ãªã©ï¼‰[{id, name, size, type, url, uploadedAt}]
  status         String    @default("draft") // draft, pending, approved, rejected, cancelled
  approver       String? // æ‰¿èªè€…ID
  approverName   String? // æ‰¿èªè€…å
  approvedDate   DateTime?
  rejectedReason String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([tenantId])
  @@index([userId])
  @@index([tenantId, userId]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ä¼‘æš‡ä¸€è¦§ç”¨ï¼‰
  @@index([tenantId, status]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥æ¤œç´¢ç”¨ï¼‰
  @@index([tenantId, startDate]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæ—¥ä»˜ç¯„å›²æ¤œç´¢ç”¨ï¼‰
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@map("leave_requests")
}

// ä¼‘æš‡æ®‹æ•°
model LeaveBalance {
  id                         String   @id @default(cuid())
  tenantId                   String
  userId                     String
  year                       Int
  paidLeaveTotal             Int      @default(0)
  paidLeaveUsed              Float    @default(0)
  paidLeaveRemaining         Float    @default(0)
  paidLeaveExpiry            DateTime @db.Date
  sickLeaveTotal             Int      @default(0)
  sickLeaveUsed              Float    @default(0)
  sickLeaveRemaining         Float    @default(0)
  specialLeaveTotal          Int      @default(0)
  specialLeaveUsed           Float    @default(0)
  specialLeaveRemaining      Float    @default(0)
  compensatoryLeaveTotal     Int      @default(0)
  compensatoryLeaveUsed      Float    @default(0)
  compensatoryLeaveRemaining Float    @default(0)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  @@unique([userId, year])
  @@index([tenantId])
  @@index([userId])
  @@index([tenantId, userId]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ä¼‘æš‡æ®‹æ•°æ¤œç´¢ç”¨ï¼‰
  @@map("leave_balances")
}

// ========================================
// ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†ãƒ»è«‹æ±‚æ›¸æ©Ÿèƒ½
// ========================================

// æ–™é‡‘ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå„ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ï¼‰
model PricingTier {
  id           String   @id @default(cuid())
  tenantId     String? // nullã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ–™é‡‘
  name         String // "1-10äºº", "11-50äºº", "51äººä»¥ä¸Š"
  minUsers     Int // æœ€å°ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
  maxUsers     Int? // æœ€å¤§ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ï¼ˆnullã®å ´åˆã¯ç„¡åˆ¶é™ï¼‰
  pricePerUser Int // 1äººã‚ãŸã‚Šã®æ–™é‡‘ï¼ˆç¨æŠœãƒ»å††ï¼‰
  order        Int      @default(0) // è¡¨ç¤ºé †åº
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("pricing_tiers")
}

// è«‹æ±‚æ›¸
model Invoice {
  id            String    @id @default(cuid())
  invoiceNumber String    @unique // INV-2025-11-001
  tenantId      String
  billingMonth  DateTime  @db.Date // è«‹æ±‚æœˆï¼ˆ2025-11-01ï¼‰
  subtotal      Int // å°è¨ˆï¼ˆç¨æŠœãƒ»å††ï¼‰
  tax           Int // æ¶ˆè²»ç¨ï¼ˆå††ï¼‰
  total         Int // åˆè¨ˆï¼ˆç¨è¾¼ãƒ»å††ï¼‰
  status        String    @default("draft") // draft, sent, paid
  dueDate       DateTime  @db.Date // æ”¯æ‰•ã„æœŸé™
  paidDate      DateTime? @db.Date // æ”¯æ‰•æ—¥
  sentDate      DateTime? // ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ—¥æ™‚
  billingEmail  String // è«‹æ±‚å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  memo          String? // ãƒ¡ãƒ¢
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  tenant Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items  InvoiceItem[]

  @@index([tenantId])
  @@index([status])
  @@index([billingMonth])
  @@index([invoiceNumber])
  @@index([tenantId, billingMonth]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ†ãƒŠãƒ³ãƒˆåˆ¥è«‹æ±‚æ›¸æ¤œç´¢ç”¨ï¼‰
  @@index([tenantId, status]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥æ¤œç´¢ç”¨ï¼‰
  @@map("invoices")
}

// è«‹æ±‚æ˜ç´°
model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String // "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ 49åï¼ˆ11/1-11/30ï¼‰"
  quantity    Int // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
  unitPrice   Int // å˜ä¾¡ï¼ˆç¨æŠœãƒ»å††ï¼‰
  amount      Int // é‡‘é¡ï¼ˆç¨æŠœãƒ»å††ï¼‰
  period      String? // "2025-11-01 ã€œ 2025-11-30"

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_items")
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼å±¥æ­´ï¼ˆæ—¥å‰²ã‚Šè¨ˆç®—ç”¨ï¼‰
model UserHistory {
  id          String   @id @default(cuid())
  tenantId    String
  userId      String
  action      String // added, activated, deactivated, deleted
  date        DateTime @db.Date // æ“ä½œæ—¥
  userCount   Int // æ“ä½œå¾Œã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
  dailyCharge Int // æ—¥æ¬¡æ–™é‡‘ï¼ˆç¨è¾¼ãƒ»å††ï¼‰
  memo        String?
  createdAt   DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([date])
  @@index([tenantId, date]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ†ãƒŠãƒ³ãƒˆåˆ¥èª²é‡‘å±¥æ­´æ¤œç´¢ç”¨ï¼‰
  @@map("user_histories")
}

// ãƒ†ãƒŠãƒ³ãƒˆè¨­å®š
model TenantSettings {
  id                String    @id @default(cuid())
  tenantId          String    @unique
  trialEndDate      DateTime? @db.Date // ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«çµ‚äº†æ—¥
  contractStartDate DateTime? @db.Date // å¥‘ç´„é–‹å§‹æ—¥
  contractEndDate   DateTime? @db.Date // å¥‘ç´„çµ‚äº†æ—¥
  billingEmail      String? // è«‹æ±‚å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  customPricing     Boolean   @default(false) // ã‚«ã‚¹ã‚¿ãƒ æ–™é‡‘è¨­å®šãƒ•ãƒ©ã‚°
  status            String    @default("trial") // trial, active, suspended, cancelled
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_settings")
}

// ========================================
// ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆéƒ¨ç½²ãƒ»å½¹è·ãƒ»é›‡ç”¨å½¢æ…‹ï¼‰
// ========================================

// éƒ¨ç½²ãƒã‚¹ã‚¿
model Department {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  parentId  String?  // è¦ªéƒ¨ç½²IDï¼ˆéšå±¤æ§‹é€ ç”¨ï¼‰
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationsï¼ˆè‡ªå·±å‚ç…§ã¯å‰Šé™¤ã—ã¦ã‚·ãƒ³ãƒ—ãƒ«åŒ–ï¼‰

  @@unique([tenantId, name]) // åŒä¸€ãƒ†ãƒŠãƒ³ãƒˆå†…ã§éƒ¨ç½²åã¯é‡è¤‡ä¸å¯
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([tenantId, sortOrder])
  @@map("departments")
}

// å½¹è·ãƒã‚¹ã‚¿
model Position {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  level     Int      @default(1) // å½¹è·ãƒ¬ãƒ™ãƒ«ï¼ˆ1: ä¸€èˆ¬, 2: ä¸»ä»», 3: ä¿‚é•·, 4: èª²é•·, 5: éƒ¨é•·, 6: å½¹å“¡, 7: ä»£è¡¨ï¼‰
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, name]) // åŒä¸€ãƒ†ãƒŠãƒ³ãƒˆå†…ã§å½¹è·åã¯é‡è¤‡ä¸å¯
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([tenantId, level])
  @@map("positions")
}

// é›‡ç”¨å½¢æ…‹ãƒã‚¹ã‚¿
model EmploymentType {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, name]) // åŒä¸€ãƒ†ãƒŠãƒ³ãƒˆå†…ã§é›‡ç”¨å½¢æ…‹åã¯é‡è¤‡ä¸å¯
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("employment_types")
}

// ========================================
// æ‰¿èªãƒ•ãƒ­ãƒ¼å®šç¾©
// ========================================

// æ‰¿èªãƒ•ãƒ­ãƒ¼å®šç¾©ï¼ˆãƒã‚¹ã‚¿ï¼‰
model ApprovalFlowDefinition {
  id                     String   @id @default(cuid())
  tenantId               String
  name                   String   // ãƒ•ãƒ­ãƒ¼å
  description            String?  // èª¬æ˜
  documentType           String   // leave_request, overtime_request, expense_claim, business_trip, purchase_request
  flowType               String   // organizationï¼ˆçµ„ç¹”é€£å‹•ï¼‰, customï¼ˆã‚«ã‚¹ã‚¿ãƒ ï¼‰
  useOrganizationHierarchy Boolean @default(false) // çµ„ç¹”é€£å‹•å‹ã®å ´åˆtrue
  organizationLevels     Int?     // çµ„ç¹”é€£å‹•å‹: ä½•éšå±¤ä¸Šã¾ã§æ‰¿èªãŒå¿…è¦ã‹ï¼ˆ1-5ï¼‰
  isActive               Boolean  @default(true)
  isDefault              Boolean  @default(false) // ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ãƒ­ãƒ¼
  priority               Int      @default(1) // å„ªå…ˆåº¦ï¼ˆæ¡ä»¶åˆ†å²æ™‚ã®åˆ¤å®šé †ï¼‰
  createdBy              String   // ä½œæˆè€…ID
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // Relations
  steps      ApprovalFlowStep[]
  conditions ApprovalFlowCondition[]

  // Note: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ãƒ­ãƒ¼ã®ä¸€æ„æ€§ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ã§åˆ¶å¾¡
  @@index([tenantId])
  @@index([tenantId, documentType])
  @@index([tenantId, documentType, isActive])
  @@map("approval_flow_definitions")
}

// æ‰¿èªãƒ•ãƒ­ãƒ¼ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ï¼ˆã‚«ã‚¹ã‚¿ãƒ å‹ç”¨ï¼‰
model ApprovalFlowStep {
  id               String   @id @default(cuid())
  flowId           String
  stepNumber       Int      // ã‚¹ãƒ†ãƒƒãƒ—ç•ªå·ï¼ˆ1å§‹ã¾ã‚Šï¼‰
  name             String   // ã‚¹ãƒ†ãƒƒãƒ—åï¼ˆä¾‹: ç›´å±ä¸Šå¸æ‰¿èªã€éƒ¨é•·æ‰¿èªï¼‰
  executionMode    String   @default("serial") // serialï¼ˆé †æ¬¡ï¼‰, parallelï¼ˆä¸¦åˆ—ï¼‰
  requiredApprovals Int     @default(1) // å¿…è¦æ‰¿èªæ•°ï¼ˆä¸¦åˆ—æ™‚ï¼‰
  timeoutHours     Int?     // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“
  allowDelegate    Boolean  @default(true) // ä»£ç†æ‰¿èªã‚’è¨±å¯
  allowSkip        Boolean  @default(false) // ã‚¹ã‚­ãƒƒãƒ—ã‚’è¨±å¯
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  flow      ApprovalFlowDefinition @relation(fields: [flowId], references: [id], onDelete: Cascade)
  approvers ApprovalFlowApprover[]

  @@index([flowId])
  @@index([flowId, stepNumber])
  @@map("approval_flow_steps")
}

// æ‰¿èªãƒ•ãƒ­ãƒ¼ã‚¹ãƒ†ãƒƒãƒ—ã®æ‰¿èªè€…å®šç¾©
model ApprovalFlowApprover {
  id          String   @id @default(cuid())
  stepId      String
  approverType String  // userï¼ˆç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰, roleï¼ˆå½¹è·ï¼‰, position_levelï¼ˆå½¹è·ãƒ¬ãƒ™ãƒ«ä»¥ä¸Šï¼‰
  approverId  String?  // approverType=userã®å ´åˆ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  approverRole String? // approverType=roleã®å ´åˆ: manager, hr, financeç­‰
  positionLevel Int?   // approverType=position_levelã®å ´åˆ: å½¹è·ãƒ¬ãƒ™ãƒ«
  order       Int      @default(1) // æ‰¿èªè€…ã®é †åºï¼ˆä¸¦åˆ—æ™‚ï¼‰
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  step ApprovalFlowStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@index([stepId])
  @@map("approval_flow_approvers")
}

// æ‰¿èªãƒ•ãƒ­ãƒ¼é©ç”¨æ¡ä»¶
model ApprovalFlowCondition {
  id          String   @id @default(cuid())
  flowId      String
  field       String   // æ¡ä»¶åˆ¤å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆamount, days, hoursç­‰ï¼‰
  operator    String   // æ¼”ç®—å­ï¼ˆgte, lte, gt, lt, eq, neï¼‰
  value       Float    // æ¯”è¼ƒå€¤
  description String?  // æ¡ä»¶ã®èª¬æ˜ï¼ˆä¾‹: 5æ—¥ä»¥ä¸Šã®ä¼‘æš‡ï¼‰
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  flow ApprovalFlowDefinition @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@index([flowId])
  @@map("approval_flow_conditions")
}

// ========================================
// ä¼šç¤¾è¨­å®šï¼ˆCompany Settingsï¼‰
// ========================================

// ä¼šç¤¾æƒ…å ±
model CompanySettings {
  id                   String   @id @default(cuid())
  tenantId             String   @unique // 1ãƒ†ãƒŠãƒ³ãƒˆ1è¨­å®š

  // åŸºæœ¬æƒ…å ±
  name                 String   // ä¼šç¤¾å
  nameKana             String?  // ä¼šç¤¾åï¼ˆã‚«ãƒŠï¼‰
  postalCode           String?  // éƒµä¾¿ç•ªå·
  address              String?  // ä½æ‰€
  phone                String?  // é›»è©±ç•ªå·
  fax                  String?  // FAXç•ªå·
  email                String?  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹

  // æ³•äººæƒ…å ±
  corporateNumber      String?  // æ³•äººç•ªå·ï¼ˆ13æ¡ï¼‰
  representativeName   String?  // ä»£è¡¨è€…å
  representativeTitle  String?  // ä»£è¡¨è€…å½¹è·

  // ç¨å‹™æƒ…å ±
  taxOffice            String?  // æ‰€è½„ç¨å‹™ç½²
  taxOfficeCode        String?  // ç¨å‹™ç½²ã‚³ãƒ¼ãƒ‰

  // ãã®ä»–
  fiscalYearEnd        String?  // æ±ºç®—æœˆï¼ˆMMå½¢å¼ï¼‰
  foundedDate          DateTime? @db.Date // è¨­ç«‹æ—¥

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([tenantId])
  @@map("company_settings")
}

// çµ¦ä¸è¨­å®š
model PayrollSettings {
  id                        String   @id @default(cuid())
  tenantId                  String   @unique // 1ãƒ†ãƒŠãƒ³ãƒˆ1è¨­å®š

  // æ”¯çµ¦æ—¥è¨­å®š
  paymentDay                Int      @default(25) // æ”¯çµ¦æ—¥ï¼ˆ1-31ï¼‰
  paymentDayType            String   @default("current") // currentï¼ˆå½“æœˆæ‰•ã„ï¼‰/ nextï¼ˆç¿Œæœˆæ‰•ã„ï¼‰

  // ç· ã‚æ—¥è¨­å®š
  closingDay                Int      @default(31) // ç· ã‚æ—¥ï¼ˆ1-31ã€æœ«æ—¥ã¯31ï¼‰

  // çµ¦ä¸ä½“ç³»
  defaultPayType            String   @default("monthly") // monthly / hourly / daily

  // æ™‚é–“è¨­å®š
  standardWorkHours         Float    @default(8) // æ‰€å®šåŠ´åƒæ™‚é–“/æ—¥
  standardWorkDays          Int      @default(20) // æ‰€å®šåŠ´åƒæ—¥æ•°/æœˆ

  // æ§é™¤è¨­å®š
  enableHealthInsurance     Boolean  @default(true)  // å¥åº·ä¿é™º
  enablePensionInsurance    Boolean  @default(true)  // åšç”Ÿå¹´é‡‘
  enableEmploymentInsurance Boolean  @default(true)  // é›‡ç”¨ä¿é™º
  enableIncomeTax           Boolean  @default(true)  // æ‰€å¾—ç¨
  enableResidentTax         Boolean  @default(true)  // ä½æ°‘ç¨

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@index([tenantId])
  @@map("payroll_settings")
}

// å‹¤æ€ è¨­å®š
model AttendanceSettings {
  id                    String   @id @default(cuid())
  tenantId              String   @unique // 1ãƒ†ãƒŠãƒ³ãƒˆ1è¨­å®š

  // å‹¤å‹™æ™‚é–“è¨­å®š
  workStartTime         String   @default("09:00") // å§‹æ¥­æ™‚åˆ»
  workEndTime           String   @default("18:00") // çµ‚æ¥­æ™‚åˆ»
  breakStartTime        String   @default("12:00") // ä¼‘æ†©é–‹å§‹æ™‚åˆ»
  breakEndTime          String   @default("13:00") // ä¼‘æ†©çµ‚äº†æ™‚åˆ»
  breakDurationMinutes  Int      @default(60) // ä¼‘æ†©æ™‚é–“ï¼ˆåˆ†ï¼‰

  // ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹è¨­å®š
  enableFlexTime        Boolean  @default(false) // ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹åˆ¶åº¦
  coreTimeStart         String?  // ã‚³ã‚¢ã‚¿ã‚¤ãƒ é–‹å§‹
  coreTimeEnd           String?  // ã‚³ã‚¢ã‚¿ã‚¤ãƒ çµ‚äº†

  // æ®‹æ¥­è¨­å®š
  overtimeThresholdMinutes Int   @default(480) // æ®‹æ¥­è¨ˆç®—é–‹å§‹ï¼ˆåˆ†ï¼‰= 8æ™‚é–“
  maxOvertimeHoursPerMonth Int   @default(45) // æœˆé–“æ®‹æ¥­ä¸Šé™ï¼ˆæ™‚é–“ï¼‰

  // æ‰“åˆ»è¨­å®š
  allowRemoteCheckIn    Boolean  @default(true) // ãƒªãƒ¢ãƒ¼ãƒˆæ‰“åˆ»è¨±å¯
  requireLocationOnCheckIn Boolean @default(false) // ä½ç½®æƒ…å ±å¿…é ˆ
  allowEarlyCheckIn     Boolean  @default(true) // æ—©å‡ºæ‰“åˆ»è¨±å¯
  earlyCheckInMinutes   Int      @default(30) // æ—©å‡ºè¨±å®¹æ™‚é–“ï¼ˆåˆ†ï¼‰

  // ä¼‘æ—¥è¨­å®š
  weeklyHolidays        String[] @default(["saturday", "sunday"]) // é€±ä¼‘æ—¥

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([tenantId])
  @@map("attendance_settings")
}
