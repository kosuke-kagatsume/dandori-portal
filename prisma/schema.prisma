// Dandori Portal Database Schema
// HRé ˜åŸŸç‰¹åŒ–ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒï¼ˆãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå®Œå…¨å¯¾å¿œï¼‰
//
// ğŸ¢ ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆè¨­è¨ˆ:
// - ã™ã¹ã¦ã®ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã« tenant_id ã‚’å«ã‚€
// - RDS PostgreSQL ã§ Row Level Security (RLS) å¯¾å¿œ
// - è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
// - 20ç¤¾Ã—30åè¦æ¨¡ï¼ˆ600ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã«æœ€é©åŒ–

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ãƒ†ãƒŠãƒ³ãƒˆï¼ˆä¼šç¤¾ï¼‰
model Tenant {
  id           String   @id @default(cuid())
  name         String
  subdomain    String?  @unique // ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆä¾‹: dandori-work, sample-corpï¼‰
  logo         String?
  timezone     String   @default("Asia/Tokyo")
  closingDay   String   @default("æœ«") // æœ«, 20, 15, ä»»æ„
  weekStartDay Int      @default(1) // 0=æ—¥æ›œ, 1=æœˆæ›œ
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  users         User[]
  orgUnits      OrgUnit[]
  attendance    Attendance[]
  pricingTiers  PricingTier[]
  invoices      Invoice[]
  settings      TenantSettings?
  userHistories UserHistory[]

  @@index([subdomain])
  @@map("tenants")
}

// çµ„ç¹”å˜ä½ï¼ˆä¼šç¤¾ã€éƒ¨é–€ã€éƒ¨ã€ãƒãƒ¼ãƒ ï¼‰
model OrgUnit {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  parentId    String?
  level       Int      @default(0)
  headUserId  String?
  type        String // company, division, department, team
  memberCount Int      @default(0)
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent   OrgUnit?  @relation("OrgUnitHierarchy", fields: [parentId], references: [id])
  children OrgUnit[] @relation("OrgUnitHierarchy")
  users    User[]

  @@index([tenantId])
  @@index([parentId])
  @@index([tenantId, parentId]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆçµ„ç¹”éšå±¤æ¤œç´¢ç”¨ï¼‰
  @@index([tenantId, isActive]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæœ‰åŠ¹çµ„ç¹”æ¤œç´¢ç”¨ï¼‰
  @@map("org_units")
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼
model User {
  id               String    @id @default(cuid())
  tenantId         String
  email            String    @unique
  name             String
  phone            String?
  hireDate         DateTime
  unitId           String
  roles            String[] // JSONé…åˆ—: ["employee", "admin"]
  status           String    @default("active") // active, inactive, suspended, retired
  retiredDate      DateTime?
  retirementReason String? // voluntary, company, contract_end, retirement_age, other
  timezone         String    @default("Asia/Tokyo")
  avatar           String?
  position         String?
  department       String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  tenant     Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orgUnit    OrgUnit      @relation(fields: [unitId], references: [id])
  attendance Attendance[]

  @@index([tenantId])
  @@index([unitId])
  @@index([email])
  @@index([tenantId, status]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ç”¨ï¼‰
  @@map("users")
}

// å‹¤æ€ è¨˜éŒ²
model Attendance {
  id                String    @id @default(cuid())
  tenantId          String
  userId            String
  date              DateTime  @db.Date // YYYY-MM-DDå½¢å¼
  checkIn           DateTime? // å‡ºå‹¤æ™‚åˆ»
  checkOut          DateTime? // é€€å‹¤æ™‚åˆ»
  breakStart        DateTime? // ä¼‘æ†©é–‹å§‹æ™‚åˆ»
  breakEnd          DateTime? // ä¼‘æ†©çµ‚äº†æ™‚åˆ»
  totalBreakMinutes Int       @default(0)
  workMinutes       Int       @default(0)
  overtimeMinutes   Int       @default(0)
  workLocation      String    @default("office") // office, home, client, other
  checkInLocation   Json? // GPSä½ç½®æƒ…å ± {latitude, longitude, address, timestamp}
  checkOutLocation  Json? // GPSä½ç½®æƒ…å ± {latitude, longitude, address, timestamp}
  status            String    @default("present") // present, absent, holiday, leave, late, early
  memo              String?
  approvalStatus    String? // pending, approved, rejected
  approvalReason    String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date]) // 1ãƒ¦ãƒ¼ã‚¶ãƒ¼1æ—¥1ãƒ¬ã‚³ãƒ¼ãƒ‰
  @@index([tenantId])
  @@index([userId])
  @@index([tenantId, userId]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆæœ€é©åŒ–ï¼‰
  @@index([tenantId, date]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæ—¥ä»˜ç¯„å›²æ¤œç´¢ç”¨ï¼‰
  @@index([date])
  @@index([status])
  @@map("attendance")
}

// ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”³è«‹
model WorkflowRequest {
  id            String    @id @default(cuid())
  tenantId      String
  requesterId   String // ç”³è«‹è€…ID
  requesterName String // ç”³è«‹è€…å
  department    String? // éƒ¨ç½²
  type          String // leave, overtime, expense, business_trip, purchase, attendance_correction
  title         String // ç”³è«‹ã‚¿ã‚¤ãƒˆãƒ«
  description   String? // ç”³è«‹å†…å®¹
  amount        Float? // é‡‘é¡ï¼ˆçµŒè²»ãƒ»è³¼è²·ç”³è«‹ç”¨ï¼‰
  days          Int? // æ—¥æ•°ï¼ˆä¼‘æš‡ç”³è«‹ç”¨ï¼‰
  hours         Float? // æ™‚é–“æ•°ï¼ˆæ®‹æ¥­ç”³è«‹ç”¨ï¼‰
  details       Json? // ãã®ä»–è©³ç´°æƒ…å ±
  status        String    @default("pending") // pending, in_progress, approved, rejected, withdrawn
  currentStep   Int       @default(0)
  priority      String    @default("medium") // low, medium, high, urgent
  dueDate       DateTime?
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  approvalSteps   ApprovalStep[]
  timelineEntries TimelineEntry[]

  @@index([tenantId])
  @@index([requesterId])
  @@index([tenantId, requesterId]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ç”³è«‹ä¸€è¦§ç”¨ï¼‰
  @@index([tenantId, status]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥æ¤œç´¢ç”¨ï¼‰
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("workflow_requests")
}

// æ‰¿èªã‚¹ãƒ†ãƒƒãƒ—
model ApprovalStep {
  id            String    @id @default(cuid())
  tenantId      String // éæ­£è¦åŒ–ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
  workflowId    String
  order         Int // ã‚¹ãƒ†ãƒƒãƒ—ã®é †åºï¼ˆ0å§‹ã¾ã‚Šï¼‰
  approverRole  String // direct_manager, hr_manager, finance_manager, etc.
  approverId    String? // æ‰¿èªè€…ID
  approverName  String? // æ‰¿èªè€…å
  status        String    @default("pending") // pending, approved, rejected, skipped
  actionDate    DateTime? // æ‰¿èª/å´ä¸‹æ—¥æ™‚
  comments      String? // ã‚³ãƒ¡ãƒ³ãƒˆ
  executionMode String    @default("sequential") // sequential, parallel
  timeoutHours  Int? // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“
  isEscalated   Boolean   @default(false)
  escalatedTo   String? // ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å…ˆ
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  workflow WorkflowRequest @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([workflowId])
  @@index([tenantId, approverId]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæ‰¿èªè€…åˆ¥ã‚¿ã‚¹ã‚¯ä¸€è¦§ç”¨ï¼‰
  @@index([tenantId, status]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥æ¤œç´¢ç”¨ï¼‰
  @@index([approverId])
  @@index([status])
  @@map("approval_steps")
}

// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆå±¥æ­´ï¼‰
model TimelineEntry {
  id         String   @id @default(cuid())
  tenantId   String // éæ­£è¦åŒ–ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
  workflowId String
  action     String // created, submitted, approved, rejected, returned, escalated, etc.
  actorId    String? // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œè€…ID
  actorName  String? // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œè€…å
  details    String? // è©³ç´°æƒ…å ±
  createdAt  DateTime @default(now())

  // Relations
  workflow WorkflowRequest @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([workflowId])
  @@index([tenantId, createdAt]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼‰
  @@index([createdAt])
  @@map("timeline_entries")
}

// ä¼‘æš‡ç”³è«‹
model LeaveRequest {
  id             String    @id @default(cuid())
  tenantId       String
  userId         String
  userName       String
  type           String // paid, sick, special, compensatory, half_day_am, half_day_pm
  startDate      DateTime  @db.Date
  endDate        DateTime  @db.Date
  days           Float // æ—¥æ•°ï¼ˆ0.5ã®åŠä¼‘ã‚‚å¯¾å¿œï¼‰
  reason         String
  attachments    Json? // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ï¼ˆè¨ºæ–­æ›¸ãªã©ï¼‰[{id, name, size, type, url, uploadedAt}]
  status         String    @default("draft") // draft, pending, approved, rejected, cancelled
  approver       String? // æ‰¿èªè€…ID
  approverName   String? // æ‰¿èªè€…å
  approvedDate   DateTime?
  rejectedReason String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([tenantId])
  @@index([userId])
  @@index([tenantId, userId]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ä¼‘æš‡ä¸€è¦§ç”¨ï¼‰
  @@index([tenantId, status]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥æ¤œç´¢ç”¨ï¼‰
  @@index([tenantId, startDate]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæ—¥ä»˜ç¯„å›²æ¤œç´¢ç”¨ï¼‰
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@map("leave_requests")
}

// ä¼‘æš‡æ®‹æ•°
model LeaveBalance {
  id                         String   @id @default(cuid())
  tenantId                   String
  userId                     String
  year                       Int
  paidLeaveTotal             Int      @default(0)
  paidLeaveUsed              Float    @default(0)
  paidLeaveRemaining         Float    @default(0)
  paidLeaveExpiry            DateTime @db.Date
  sickLeaveTotal             Int      @default(0)
  sickLeaveUsed              Float    @default(0)
  sickLeaveRemaining         Float    @default(0)
  specialLeaveTotal          Int      @default(0)
  specialLeaveUsed           Float    @default(0)
  specialLeaveRemaining      Float    @default(0)
  compensatoryLeaveTotal     Int      @default(0)
  compensatoryLeaveUsed      Float    @default(0)
  compensatoryLeaveRemaining Float    @default(0)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  @@unique([userId, year])
  @@index([tenantId])
  @@index([userId])
  @@index([tenantId, userId]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ä¼‘æš‡æ®‹æ•°æ¤œç´¢ç”¨ï¼‰
  @@map("leave_balances")
}

// ========================================
// ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†ãƒ»è«‹æ±‚æ›¸æ©Ÿèƒ½
// ========================================

// æ–™é‡‘ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå„ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ï¼‰
model PricingTier {
  id           String   @id @default(cuid())
  tenantId     String? // nullã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ–™é‡‘
  name         String // "1-10äºº", "11-50äºº", "51äººä»¥ä¸Š"
  minUsers     Int // æœ€å°ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
  maxUsers     Int? // æœ€å¤§ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ï¼ˆnullã®å ´åˆã¯ç„¡åˆ¶é™ï¼‰
  pricePerUser Int // 1äººã‚ãŸã‚Šã®æ–™é‡‘ï¼ˆç¨æŠœãƒ»å††ï¼‰
  order        Int      @default(0) // è¡¨ç¤ºé †åº
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("pricing_tiers")
}

// è«‹æ±‚æ›¸
model Invoice {
  id            String    @id @default(cuid())
  invoiceNumber String    @unique // INV-2025-11-001
  tenantId      String
  billingMonth  DateTime  @db.Date // è«‹æ±‚æœˆï¼ˆ2025-11-01ï¼‰
  subtotal      Int // å°è¨ˆï¼ˆç¨æŠœãƒ»å††ï¼‰
  tax           Int // æ¶ˆè²»ç¨ï¼ˆå††ï¼‰
  total         Int // åˆè¨ˆï¼ˆç¨è¾¼ãƒ»å††ï¼‰
  status        String    @default("draft") // draft, sent, paid
  dueDate       DateTime  @db.Date // æ”¯æ‰•ã„æœŸé™
  paidDate      DateTime? @db.Date // æ”¯æ‰•æ—¥
  sentDate      DateTime? // ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ—¥æ™‚
  billingEmail  String // è«‹æ±‚å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  memo          String? // ãƒ¡ãƒ¢
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  tenant Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items  InvoiceItem[]

  @@index([tenantId])
  @@index([status])
  @@index([billingMonth])
  @@index([invoiceNumber])
  @@index([tenantId, billingMonth]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ†ãƒŠãƒ³ãƒˆåˆ¥è«‹æ±‚æ›¸æ¤œç´¢ç”¨ï¼‰
  @@index([tenantId, status]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥æ¤œç´¢ç”¨ï¼‰
  @@map("invoices")
}

// è«‹æ±‚æ˜ç´°
model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String // "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ 49åï¼ˆ11/1-11/30ï¼‰"
  quantity    Int // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
  unitPrice   Int // å˜ä¾¡ï¼ˆç¨æŠœãƒ»å††ï¼‰
  amount      Int // é‡‘é¡ï¼ˆç¨æŠœãƒ»å††ï¼‰
  period      String? // "2025-11-01 ã€œ 2025-11-30"

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_items")
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼å±¥æ­´ï¼ˆæ—¥å‰²ã‚Šè¨ˆç®—ç”¨ï¼‰
model UserHistory {
  id          String   @id @default(cuid())
  tenantId    String
  userId      String
  action      String // added, activated, deactivated, deleted
  date        DateTime @db.Date // æ“ä½œæ—¥
  userCount   Int // æ“ä½œå¾Œã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
  dailyCharge Int // æ—¥æ¬¡æ–™é‡‘ï¼ˆç¨è¾¼ãƒ»å††ï¼‰
  memo        String?
  createdAt   DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([date])
  @@index([tenantId, date]) // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ†ãƒŠãƒ³ãƒˆåˆ¥èª²é‡‘å±¥æ­´æ¤œç´¢ç”¨ï¼‰
  @@map("user_histories")
}

// ãƒ†ãƒŠãƒ³ãƒˆè¨­å®š
model TenantSettings {
  id                String    @id @default(cuid())
  tenantId          String    @unique
  trialEndDate      DateTime? @db.Date // ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«çµ‚äº†æ—¥
  contractStartDate DateTime? @db.Date // å¥‘ç´„é–‹å§‹æ—¥
  contractEndDate   DateTime? @db.Date // å¥‘ç´„çµ‚äº†æ—¥
  billingEmail      String? // è«‹æ±‚å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  customPricing     Boolean   @default(false) // ã‚«ã‚¹ã‚¿ãƒ æ–™é‡‘è¨­å®šãƒ•ãƒ©ã‚°
  status            String    @default("trial") // trial, active, suspended, cancelled
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_settings")
}
