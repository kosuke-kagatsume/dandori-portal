version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Node.jsバージョン確認
        - node --version
        - npm --version

        # 依存関係インストール（devDependenciesも含む）
        - npm ci --include=dev

        # 環境変数を.env.productionに書き出し（Amplify SSR Lambda用）
        # これにより、ランタイムで環境変数が利用可能になる
        - 'echo "DATABASE_URL=${DATABASE_URL}" >> .env.production'
        - 'echo "DEMO_MODE=${DEMO_MODE}" >> .env.production'
        - 'echo "NEXT_PUBLIC_DEMO_MODE=${NEXT_PUBLIC_DEMO_MODE}" >> .env.production'
        - 'echo "NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}" >> .env.production'
        - 'echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}" >> .env.production'

        # SendGrid設定
        - 'echo "SENDGRID_API_KEY=${SENDGRID_API_KEY}" >> .env.production'
        - 'echo "SENDGRID_FROM_EMAIL=${SENDGRID_FROM_EMAIL}" >> .env.production'
        - 'echo "SENDGRID_FROM_NAME=${SENDGRID_FROM_NAME}" >> .env.production'

        # JWT設定
        - 'echo "JWT_SECRET=${JWT_SECRET}" >> .env.production'
        - 'echo "DW_ADMIN_JWT_SECRET=${DW_ADMIN_JWT_SECRET}" >> .env.production'
        - 'echo "PROXY_LOGIN_SECRET=${PROXY_LOGIN_SECRET}" >> .env.production'

        # DW管理者設定
        - 'echo "DW_ADMIN_EMAILS=${DW_ADMIN_EMAILS}" >> .env.production'
        - 'echo "DW_ADMIN_EMAIL_1=${DW_ADMIN_EMAIL_1}" >> .env.production'
        - 'echo "DW_ADMIN_EMAIL_2=${DW_ADMIN_EMAIL_2}" >> .env.production'
        # パスワードハッシュはbcrypt形式（$2b$10$...）のため、
        # dotenv-expandが$を変数展開してハッシュを破壊する問題を回避
        # → $を\$にエスケープして書き込む
        - node -e "const fs=require('fs'); ['1','2'].forEach(i=>{const k='DW_ADMIN_PASSWORD_HASH_'+i; const v=process.env[k]; if(v){fs.appendFileSync('.env.production', k+'='+v.replace(/\\$/g,'\\\\$$')+'\\n')}})"

        # S3設定
        - 'echo "S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}" >> .env.production'
        - 'echo "S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}" >> .env.production'
        - 'echo "S3_BUCKET=${S3_BUCKET}" >> .env.production'
        - 'echo "S3_REGION=${S3_REGION}" >> .env.production'

        # アプリURL
        - 'echo "NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}" >> .env.production'
        - 'echo "NEXT_PUBLIC_MAIN_DOMAIN=${NEXT_PUBLIC_MAIN_DOMAIN}" >> .env.production'

        # dotenv-expand対策: 全ての値で$を\$にエスケープ
        # （bcryptハッシュ、シークレットキー等に含まれる$が変数展開されるのを防止）
        - node -e "const fs=require('fs'); const lines=fs.readFileSync('.env.production','utf8').split('\n'); const fixed=lines.map(l=>{const i=l.indexOf('='); if(i<0)return l; return l.slice(0,i+1)+l.slice(i+1).replace(/\\$/g,'\\\\$$')}).join('\n'); fs.writeFileSync('.env.production',fixed)"

        # 環境変数が正しく書き出されたか確認（DATABASE_URLは先頭のみ表示）
        - 'echo "=== .env.production created ==="'
        - cat .env.production | grep -v DATABASE_URL
        - 'echo "DATABASE_URL is set: $(test -n \"$DATABASE_URL\" && echo YES || echo NO)"'

        # Prisma Clientの生成
        - npx prisma generate

    build:
      commands:
        # 型チェック（オプション、時間短縮のためコメントアウト可）
        # - npm run typecheck

        # 本番ビルド
        - npm run build

  artifacts:
    # Next.jsのビルド成果物
    baseDirectory: .next
    files:
      - '**/*'

  cache:
    paths:
      # ビルド高速化のためのキャッシュ
      - node_modules/**/*
      - .next/cache/**/*

# 環境変数（Amplifyコンソールで設定）
# NEXT_PUBLIC_SUPABASE_URL
# NEXT_PUBLIC_SUPABASE_ANON_KEY
# DATABASE_URL
# DEMO_MODE=false
# NEXT_PUBLIC_DEMO_MODE=false
