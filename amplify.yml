version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Node.jsバージョン確認
        - node --version
        - npm --version

        # 依存関係インストール（devDependenciesも含む）
        - npm ci --include=dev

        # 環境変数を.env.productionに書き出し（Amplify SSR Lambda用）
        # これにより、ランタイムで環境変数が利用可能になる
        - |
          echo "DATABASE_URL=${DATABASE_URL}" >> .env.production
          echo "DEMO_MODE=${DEMO_MODE}" >> .env.production
          echo "NEXT_PUBLIC_DEMO_MODE=${NEXT_PUBLIC_DEMO_MODE}" >> .env.production
          echo "NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}" >> .env.production
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}" >> .env.production

        # 環境変数が正しく書き出されたか確認（DATABASE_URLは先頭のみ表示）
        - echo "=== .env.production created ==="
        - cat .env.production | grep -v DATABASE_URL
        - echo "DATABASE_URL is set: $(test -n \"$DATABASE_URL\" && echo 'YES' || echo 'NO')"

        # Prisma Clientの生成
        - npx prisma generate

    build:
      commands:
        # 型チェック（オプション、時間短縮のためコメントアウト可）
        # - npm run typecheck

        # 本番ビルド
        - npm run build

  artifacts:
    # Next.jsのビルド成果物
    baseDirectory: .next
    files:
      - '**/*'

  cache:
    paths:
      # ビルド高速化のためのキャッシュ
      - node_modules/**/*
      - .next/cache/**/*

# 環境変数（Amplifyコンソールで設定）
# NEXT_PUBLIC_SUPABASE_URL
# NEXT_PUBLIC_SUPABASE_ANON_KEY
# DATABASE_URL
# DEMO_MODE=false
# NEXT_PUBLIC_DEMO_MODE=false
